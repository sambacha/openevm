\hypertarget{example_8c_source}{}\doxysection{example.\+c}
\label{example_8c_source}\index{examples/example.c@{examples/example.c}}
\mbox{\hyperlink{example_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00001}00001 \textcolor{comment}{/* EVMC: Ethereum Client-\/VM Connector API.}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00002}00002 \textcolor{comment}{ * Copyright 2016-\/2019 The EVMC Authors.}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00003}00003 \textcolor{comment}{ * Licensed under the Apache License, Version 2.0.}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00004}00004 \textcolor{comment}{ */}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00005}00005 }
\DoxyCodeLine{\Hypertarget{example_8c_source_l00006}00006 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{example__host_8h}{example\_host.h}}"{}}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00007}00007 \textcolor{preprocessor}{\#ifdef STATICALLY\_LINKED\_EXAMPLE}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00008}00008 \textcolor{preprocessor}{\#include "{}example\_vm/example\_vm.h"{}}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00009}00009 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00010}00010 }
\DoxyCodeLine{\Hypertarget{example_8c_source_l00011}00011 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{helpers_8h}{evmc/helpers.h}}>}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00012}00012 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{loader_8h}{evmc/loader.h}}>}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00013}00013 }
\DoxyCodeLine{\Hypertarget{example_8c_source_l00014}00014 \textcolor{preprocessor}{\#include <inttypes.h>}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00015}00015 \textcolor{preprocessor}{\#include <stdio.h>}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00016}00016 }
\DoxyCodeLine{\Hypertarget{example_8c_source_l00017}\mbox{\hyperlink{example_8c_a0ddf1224851353fc92bfbff6f499fa97}{00017}} \textcolor{keywordtype}{int} \mbox{\hyperlink{example_8c_a0ddf1224851353fc92bfbff6f499fa97}{main}}(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char}* argv[])}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00018}00018 \{}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00019}00019 \textcolor{preprocessor}{\#ifdef STATICALLY\_LINKED\_EXAMPLE}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00020}00020     (void)argc;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00021}00021     (void)argv;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00022}00022     \textcolor{keyword}{struct }\mbox{\hyperlink{structevmc__vm}{evmc\_vm}}* vm = \mbox{\hyperlink{group__EVMC_ga4ba5aae5d0250d9c4f6987a78602e795}{evmc\_create\_example\_vm}}();}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00023}00023     \textcolor{keywordflow}{if} (!vm)}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00024}00024         \textcolor{keywordflow}{return} \mbox{\hyperlink{group__loader_ggadf193ed1d2d7e9053e9c592fc201bd7da504de7833560037be4d2c620345767f5}{EVMC\_LOADER\_VM\_CREATION\_FAILURE}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00025}00025     \textcolor{keywordflow}{if} (!\mbox{\hyperlink{group__helpers_ga7e9c2c68b366dda89dba56566aab111d}{evmc\_is\_abi\_compatible}}(vm))}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00026}00026         \textcolor{keywordflow}{return} \mbox{\hyperlink{group__loader_ggadf193ed1d2d7e9053e9c592fc201bd7da0d4eb3a48d3f8c500b96f43e1aa7c458}{EVMC\_LOADER\_ABI\_VERSION\_MISMATCH}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00027}00027 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00028}00028     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* config\_string = (argc > 1) ? argv[1] : \textcolor{stringliteral}{"{}example-\/vm.so"{}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00029}00029     \textcolor{keyword}{enum} \mbox{\hyperlink{group__loader_gadf193ed1d2d7e9053e9c592fc201bd7d}{evmc\_loader\_error\_code}} error\_code;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00030}00030     \textcolor{keyword}{struct }\mbox{\hyperlink{structevmc__vm}{evmc\_vm}}* vm = \mbox{\hyperlink{group__loader_ga3e29ca285fe13db086daf0bf98b4a046}{evmc\_load\_and\_configure}}(config\_string, \&error\_code);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00031}00031     \textcolor{keywordflow}{if} (!vm)}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00032}00032     \{}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00033}00033         printf(\textcolor{stringliteral}{"{}Loading error: \%d\(\backslash\)n"{}}, error\_code);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00034}00034         \textcolor{comment}{// NOTE: the values are small enough for casting}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00035}00035         \textcolor{keywordflow}{return} (\textcolor{keywordtype}{int})error\_code;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00036}00036     \}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00037}00037 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00038}00038 }
\DoxyCodeLine{\Hypertarget{example_8c_source_l00039}00039     \textcolor{comment}{// EVM bytecode goes here. This is one of the examples.}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00040}00040     \textcolor{keyword}{const} uint8\_t code[] = \textcolor{stringliteral}{"{}\(\backslash\)x43\(\backslash\)x60\(\backslash\)x00\(\backslash\)x55\(\backslash\)x43\(\backslash\)x60\(\backslash\)x00\(\backslash\)x52\(\backslash\)x59\(\backslash\)x60\(\backslash\)x00\(\backslash\)xf3"{}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00041}00041     \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} code\_size = \textcolor{keyword}{sizeof}(code) -\/ 1;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00042}00042     \textcolor{keyword}{const} uint8\_t input[] = \textcolor{stringliteral}{"{}Hello World!"{}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00043}00043     \textcolor{keyword}{const} \mbox{\hyperlink{structevmc__bytes32}{evmc\_uint256be}} value = \{\{1, 0\}\};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00044}00044     \textcolor{keyword}{const} \mbox{\hyperlink{structevmc__address}{evmc\_address}} addr = \{\{0, 1, 2\}\};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00045}00045     \textcolor{keyword}{const} int64\_t gas = 200000;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00046}00046     \textcolor{keyword}{struct }\mbox{\hyperlink{structevmc__tx__context}{evmc\_tx\_context}} tx\_context;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00047}00047     memset(\&tx\_context, 0, \textcolor{keyword}{sizeof}(tx\_context));}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00048}00048     tx\_context.\mbox{\hyperlink{structevmc__tx__context_a1c3c0552db49b91358256c25643ba44a}{block\_number}} = 42;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00049}00049     tx\_context.\mbox{\hyperlink{structevmc__tx__context_a2391863eab970821d67a08341d9d3440}{block\_timestamp}} = 66;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00050}00050     tx\_context.\mbox{\hyperlink{structevmc__tx__context_af51d0246df23060d5e958ada3f25a676}{block\_gas\_limit}} = gas * 2;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00051}00051     \textcolor{keyword}{const} \textcolor{keyword}{struct }\mbox{\hyperlink{structevmc__host__interface}{evmc\_host\_interface}}* host = \mbox{\hyperlink{example__host_8cpp_a1aa8c09de78471976959763a62bf069c}{example\_host\_get\_interface}}();}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00052}00052     \textcolor{keyword}{struct }\mbox{\hyperlink{structevmc__host__context}{evmc\_host\_context}}* ctx = \mbox{\hyperlink{example__host_8cpp_a8009572826ed8abb88284e79cefb4987}{example\_host\_create\_context}}(tx\_context);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00053}00053     \textcolor{keyword}{struct }\mbox{\hyperlink{structevmc__message}{evmc\_message}} msg;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00054}00054     msg.\mbox{\hyperlink{structevmc__message_a691cb93e81d6dfd4fd7e2fa3d06a6bfa}{kind}} = \mbox{\hyperlink{group__EVMC_ggab2fa68a92a6828064a61e46060abc634abcf3ae29d9a88ff70b98374fc665694a}{EVMC\_CALL}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00055}00055     msg.\mbox{\hyperlink{structevmc__message_ae7f64ab994f49d9a5f028d56e80fd468}{sender}} = addr;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00056}00056     msg.\mbox{\hyperlink{structevmc__message_a63643daa5f3a30df28d42360a20e39e2}{recipient}} = addr;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00057}00057     msg.\mbox{\hyperlink{structevmc__message_adc7e2442cb362417931524ee904ecb33}{value}} = \mbox{\hyperlink{structevmc__message_adc7e2442cb362417931524ee904ecb33}{value}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00058}00058     msg.\mbox{\hyperlink{structevmc__message_a1adee3454b105eb29cd659ee0cf65c77}{input\_data}} = input;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00059}00059     msg.\mbox{\hyperlink{structevmc__message_a2cf1deebd0dbbb20f25ecdfa299f4b5d}{input\_size}} = \textcolor{keyword}{sizeof}(input);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00060}00060     msg.\mbox{\hyperlink{structevmc__message_ae8deff46588584fa27890e74c82db5e7}{gas}} = \mbox{\hyperlink{structevmc__message_ae8deff46588584fa27890e74c82db5e7}{gas}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00061}00061     msg.\mbox{\hyperlink{structevmc__message_a75ea15f85573ea3638e8625bbba54d3a}{depth}} = 0;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00062}00062     \textcolor{keyword}{struct }\mbox{\hyperlink{structevmc__result}{evmc\_result}} result = \mbox{\hyperlink{group__helpers_ga82fb11f4b40ceec377bf0093ffc1d416}{evmc\_execute}}(vm, host, ctx, \mbox{\hyperlink{group__EVMC_ggae5759b1590071966ccf6a505b52a0ef7a04f0bf686d2b1c50612f9a96480f70a9}{EVMC\_HOMESTEAD}}, \&msg, code, code\_size);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00063}00063     printf(\textcolor{stringliteral}{"{}Execution result:\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00064}00064     \textcolor{keywordtype}{int} exit\_code = 0;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00065}00065     \textcolor{keywordflow}{if} (result.\mbox{\hyperlink{structevmc__result_a759c4aaa4a1c002f5a8be09ccb0b6a1c}{status\_code}} != \mbox{\hyperlink{group__EVMC_gga4c0be97f333c050ff45321fcaa34d920a4bc3069fec2bab2a55355a72b7db68b7}{EVMC\_SUCCESS}})}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00066}00066     \{}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00067}00067         printf(\textcolor{stringliteral}{"{}  EVM execution failure: \%d\(\backslash\)n"{}}, result.\mbox{\hyperlink{structevmc__result_a759c4aaa4a1c002f5a8be09ccb0b6a1c}{status\_code}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00068}00068         exit\_code = result.\mbox{\hyperlink{structevmc__result_a759c4aaa4a1c002f5a8be09ccb0b6a1c}{status\_code}};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00069}00069     \}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00070}00070     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00071}00071     \{}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00072}00072         printf(\textcolor{stringliteral}{"{}  Gas used: \%"{}} PRId64 \textcolor{stringliteral}{"{}\(\backslash\)n"{}}, gas -\/ result.\mbox{\hyperlink{structevmc__result_af8478c93dbcc3cb2876037c5a5afd4c0}{gas\_left}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00073}00073         printf(\textcolor{stringliteral}{"{}  Gas left: \%"{}} PRId64 \textcolor{stringliteral}{"{}\(\backslash\)n"{}}, result.\mbox{\hyperlink{structevmc__result_af8478c93dbcc3cb2876037c5a5afd4c0}{gas\_left}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00074}00074         printf(\textcolor{stringliteral}{"{}  Output size: \%zd\(\backslash\)n"{}}, result.\mbox{\hyperlink{structevmc__result_a93bb7419aff492cdef754421c6d74e26}{output\_size}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00075}00075         printf(\textcolor{stringliteral}{"{}  Output: "{}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00076}00076         \textcolor{keywordtype}{size\_t} i = 0;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00077}00077         \textcolor{keywordflow}{for} (i = 0; i < result.\mbox{\hyperlink{structevmc__result_a93bb7419aff492cdef754421c6d74e26}{output\_size}}; i++)}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00078}00078             printf(\textcolor{stringliteral}{"{}\%02x"{}}, result.\mbox{\hyperlink{structevmc__result_a61978e85f9d795a7b9695b9cbf1748d6}{output\_data}}[i]);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00079}00079         printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00080}00080         \textcolor{keyword}{const} \mbox{\hyperlink{structevmc__bytes32}{evmc\_bytes32}} storage\_key = \{\{0\}\};}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00081}00081         \mbox{\hyperlink{structevmc__bytes32}{evmc\_bytes32}} storage\_value = host-\/>\mbox{\hyperlink{structevmc__host__interface_a1cfd339e26ceaba522aece2e1a06c6ef}{get\_storage}}(ctx, \&msg.\mbox{\hyperlink{structevmc__message_a63643daa5f3a30df28d42360a20e39e2}{recipient}}, \&storage\_key);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00082}00082         printf(\textcolor{stringliteral}{"{}  Storage at 0x00..00: "{}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00083}00083         \textcolor{keywordflow}{for} (i = 0; i < \textcolor{keyword}{sizeof}(storage\_value.\mbox{\hyperlink{structevmc__bytes32_a695eaf3c428daee54ce15c8252edc133}{bytes}}) / \textcolor{keyword}{sizeof}(storage\_value.\mbox{\hyperlink{structevmc__bytes32_a695eaf3c428daee54ce15c8252edc133}{bytes}}[0]); i++)}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00084}00084             printf(\textcolor{stringliteral}{"{}\%02x"{}}, storage\_value.\mbox{\hyperlink{structevmc__bytes32_a695eaf3c428daee54ce15c8252edc133}{bytes}}[i]);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00085}00085         printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00086}00086     \}}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00087}00087     \mbox{\hyperlink{group__helpers_ga78a610e76b00c5868368bd915bdeffb8}{evmc\_release\_result}}(\&result);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00088}00088     \mbox{\hyperlink{example__host_8cpp_a9ff72df98da6045af155bb8b9697da23}{example\_host\_destroy\_context}}(ctx);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00089}00089     \mbox{\hyperlink{group__helpers_ga6204e6ae26e07377b509b2953a8094b2}{evmc\_destroy}}(vm);}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00090}00090     \textcolor{keywordflow}{return} exit\_code;}
\DoxyCodeLine{\Hypertarget{example_8c_source_l00091}00091 \}}

\end{DoxyCode}
