<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>ethereum.homestead.fork API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../homestead.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;ethereum.homestead</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#introduction">Introduction</a></li>
</ul>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#BlockChain">BlockChain</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="function" href="#apply_fork">apply_fork</a>
            </li>
            <li>
                    <a class="function" href="#get_last_256_block_hashes">get_last_256_block_hashes</a>
            </li>
            <li>
                    <a class="function" href="#state_transition">state_transition</a>
            </li>
            <li>
                    <a class="function" href="#validate_header">validate_header</a>
            </li>
            <li>
                    <a class="function" href="#generate_header_hash_for_pow">generate_header_hash_for_pow</a>
            </li>
            <li>
                    <a class="function" href="#validate_proof_of_work">validate_proof_of_work</a>
            </li>
            <li>
                    <a class="function" href="#check_transaction">check_transaction</a>
            </li>
            <li>
                    <a class="function" href="#make_receipt">make_receipt</a>
            </li>
            <li>
                    <a class="function" href="#apply_body">apply_body</a>
            </li>
            <li>
                    <a class="function" href="#validate_ommers">validate_ommers</a>
            </li>
            <li>
                    <a class="function" href="#pay_rewards">pay_rewards</a>
            </li>
            <li>
                    <a class="function" href="#process_transaction">process_transaction</a>
            </li>
            <li>
                    <a class="function" href="#validate_transaction">validate_transaction</a>
            </li>
            <li>
                    <a class="function" href="#calculate_intrinsic_cost">calculate_intrinsic_cost</a>
            </li>
            <li>
                    <a class="function" href="#recover_sender">recover_sender</a>
            </li>
            <li>
                    <a class="function" href="#signing_hash">signing_hash</a>
            </li>
            <li>
                    <a class="function" href="#compute_header_hash">compute_header_hash</a>
            </li>
            <li>
                    <a class="function" href="#check_gas_limit">check_gas_limit</a>
            </li>
            <li>
                    <a class="function" href="#calculate_block_difficulty">calculate_block_difficulty</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../ethereum.html">ethereum</a><wbr>.<a href="./../homestead.html">homestead</a><wbr>.fork    </h1>

                        <div class="docstring"><p>Ethereum Specification
^^^^^^^^^^^^^^^^^^^^^^</p>

<p>.. contents:: Table of Contents
    :backlinks: none
    :local:</p>

<h2 id="introduction">Introduction</h2>

<p>Entry point for the Ethereum specification.</p>
</div>

                        <input id="mod-fork-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-fork-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Ethereum Specification</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">.. contents:: Table of Contents</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">    :backlinks: none</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">    :local:</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">Introduction</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">------------</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">Entry point for the Ethereum specification.</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">ethereum.base_types</span> <span class="kn">import</span> <span class="n">Bytes0</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span> <span class="nn">ethereum.crypto.elliptic_curve</span> <span class="kn">import</span> <span class="n">SECP256K1N</span><span class="p">,</span> <span class="n">secp256k1_recover</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span> <span class="nn">ethereum.crypto.hash</span> <span class="kn">import</span> <span class="n">Hash32</span><span class="p">,</span> <span class="n">keccak256</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span> <span class="nn">ethereum.ethash</span> <span class="kn">import</span> <span class="n">dataset_size</span><span class="p">,</span> <span class="n">generate_cache</span><span class="p">,</span> <span class="n">hashimoto_light</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span> <span class="nn">ethereum.exceptions</span> <span class="kn">import</span> <span class="n">InvalidBlock</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">from</span> <span class="nn">ethereum.utils.ensure</span> <span class="kn">import</span> <span class="n">ensure</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">rlp</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">from</span> <span class="nn">..base_types</span> <span class="kn">import</span> <span class="n">U64</span><span class="p">,</span> <span class="n">U256</span><span class="p">,</span> <span class="n">U256_CEIL_VALUE</span><span class="p">,</span> <span class="n">Bytes</span><span class="p">,</span> <span class="n">Bytes32</span><span class="p">,</span> <span class="n">Uint</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">vm</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span> <span class="nn">.bloom</span> <span class="kn">import</span> <span class="n">logs_bloom</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">from</span> <span class="nn">.fork_types</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="n">TX_BASE_COST</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="n">TX_CREATE_COST</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="n">TX_DATA_COST_PER_NON_ZERO</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="n">TX_DATA_COST_PER_ZERO</span><span class="p">,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">Address</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="n">Block</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">Bloom</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="n">Header</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>    <span class="n">Log</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="n">Receipt</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="n">Root</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>    <span class="n">Transaction</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="p">)</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>    <span class="n">State</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>    <span class="n">create_ether</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>    <span class="n">destroy_account</span><span class="p">,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>    <span class="n">get_account</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="n">increment_nonce</span><span class="p">,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>    <span class="n">set_account_balance</span><span class="p">,</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="n">state_root</span><span class="p">,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="p">)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="kn">from</span> <span class="nn">.trie</span> <span class="kn">import</span> <span class="n">Trie</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">trie_set</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="kn">from</span> <span class="nn">.utils.message</span> <span class="kn">import</span> <span class="n">prepare_message</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="kn">from</span> <span class="nn">.vm.interpreter</span> <span class="kn">import</span> <span class="n">process_message_call</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="n">BLOCK_REWARD</span> <span class="o">=</span> <span class="n">U256</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">18</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="n">GAS_LIMIT_ADJUSTMENT_FACTOR</span> <span class="o">=</span> <span class="mi">1024</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="n">GAS_LIMIT_MINIMUM</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="n">MINIMUM_DIFFICULTY</span> <span class="o">=</span> <span class="n">Uint</span><span class="p">(</span><span class="mi">131072</span><span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="n">MAX_OMMER_DEPTH</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="nd">@dataclass</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="k">class</span> <span class="nc">BlockChain</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    History and current state of the block chain.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="n">blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="n">state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="n">chain_id</span><span class="p">:</span> <span class="n">U64</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="k">def</span> <span class="nf">apply_fork</span><span class="p">(</span><span class="n">old</span><span class="p">:</span> <span class="n">BlockChain</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockChain</span><span class="p">:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">    Transforms the state from the previous hard fork (`old`) into the block</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">    chain object for this hard fork and returns it.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">    When forks need to implement an irregular state transition, this function</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">    is used to handle the irregularity. See the :ref:`DAO Fork &lt;dao-fork&gt;` for</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">    an example.</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">    Parameters</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">    ----------</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">    old :</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">        Previous block chain object.</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">    Returns</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">    -------</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">    new : `BlockChain`</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">        Upgraded block chain object for this hard fork.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="k">return</span> <span class="n">old</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="k">def</span> <span class="nf">get_last_256_block_hashes</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="n">BlockChain</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Hash32</span><span class="p">]:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">    Obtain the list of hashes of the previous 256 blocks in order of</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">    increasing block number.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">    This function will return less hashes for the first 256 blocks.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    The ``BLOCKHASH`` opcode needs to access the latest hashes on the chain,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">    therefore this function retrieves them.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">    Parameters</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">    ----------</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">    chain :</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">        History and current state.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">    Returns</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">    -------</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">    recent_block_hashes : `List[Hash32]`</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">        Hashes of the recent 256 blocks in order of increasing block number.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>    <span class="n">recent_blocks</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">255</span><span class="p">:]</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="c1"># TODO: This function has not been tested rigorously</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_blocks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>    <span class="n">recent_block_hashes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">recent_blocks</span><span class="p">:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="n">prev_block_hash</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">parent_hash</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="n">recent_block_hashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_block_hash</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>    <span class="c1"># We are computing the hash only for the most recent block and not for</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="c1"># the rest of the blocks as they have successors which have the hash of</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="c1"># the current block as parent hash.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>    <span class="n">most_recent_block_hash</span> <span class="o">=</span> <span class="n">keccak256</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">recent_blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="n">recent_block_hashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">most_recent_block_hash</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="k">return</span> <span class="n">recent_block_hashes</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="k">def</span> <span class="nf">state_transition</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="n">BlockChain</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">    Attempts to apply a block to an existing block chain.</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">    All parts of the block&#39;s contents need to be verified before being added</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">    to the chain. Blocks are verified by ensuring that the contents of the</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">    block make logical sense with the contents of the parent block. The</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">    information in the block&#39;s header must also match the corresponding</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">    information in the block.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">    To implement Ethereum, in theory clients are only required to store the</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">    most recent 255 blocks of the chain since as far as execution is</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">    concerned, only those blocks are accessed. Practically, however, clients</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">    should store more blocks to handle reorgs.</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">    Parameters</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">    ----------</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">    chain :</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">        History and current state.</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">    block :</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">        Block to apply to `chain`.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>    <span class="n">parent_header</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>    <span class="n">validate_header</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">parent_header</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>    <span class="n">validate_ommers</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">ommers</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>    <span class="p">(</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">gas_used</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="n">transactions_root</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="n">receipt_root</span><span class="p">,</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="n">block_logs_bloom</span><span class="p">,</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="n">state</span><span class="p">,</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>    <span class="p">)</span> <span class="o">=</span> <span class="n">apply_body</span><span class="p">(</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="n">chain</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">get_last_256_block_hashes</span><span class="p">(</span><span class="n">chain</span><span class="p">),</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">gas_limit</span><span class="p">,</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">transactions</span><span class="p">,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">ommers</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>    <span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">gas_used</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">gas_used</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">transactions_root</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">transactions_root</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">state_root</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">state_root</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">receipt_root</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">receipt_root</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">block_logs_bloom</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">bloom</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>    <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="c1"># Real clients have to store more blocks to deal with reorgs, but the</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="c1"># protocol only requires the last 255</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">255</span><span class="p">:]</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="k">def</span> <span class="nf">validate_header</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">,</span> <span class="n">parent_header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">    Verifies a block header.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">    In order to consider a block&#39;s header valid, the logic for the</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">    quantities in the header should match the logic for the block itself.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">    For example the header timestamp should be greater than the block&#39;s parent</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">    timestamp because the block was created *after* the parent block.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">    Additionally, the block&#39;s number should be directly following the parent</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">    block&#39;s number since it is the next block in the sequence.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">    Parameters</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">    ----------</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">    header :</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        Header to check for correctness.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">    parent_header :</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        Parent Header of the header to check for correctness</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">parent_header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="n">parent_header</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>    <span class="n">ensure</span><span class="p">(</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="n">check_gas_limit</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">gas_limit</span><span class="p">,</span> <span class="n">parent_header</span><span class="o">.</span><span class="n">gas_limit</span><span class="p">),</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="n">InvalidBlock</span><span class="p">,</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>    <span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">extra_data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>    <span class="n">block_difficulty</span> <span class="o">=</span> <span class="n">calculate_block_difficulty</span><span class="p">(</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="n">parent_header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="n">parent_header</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>    <span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">difficulty</span> <span class="o">==</span> <span class="n">block_difficulty</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>    <span class="n">block_parent_hash</span> <span class="o">=</span> <span class="n">keccak256</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">parent_header</span><span class="p">))</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">parent_hash</span> <span class="o">==</span> <span class="n">block_parent_hash</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>    <span class="n">validate_proof_of_work</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="k">def</span> <span class="nf">generate_header_hash_for_pow</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash32</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">    Generate rlp hash of the header which is to be used for Proof-of-Work</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">    verification.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">    In other words, the PoW artefacts `mix_digest` and `nonce` are ignored</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">    while calculating this hash.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">    A particular PoW is valid for a single hash, that hash is computed by</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">    this function. The `nonce` and `mix_digest` are omitted from this hash</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">    because they are being changed by miners in their search for a sufficient</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">    proof-of-work.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">    Parameters</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">    ----------</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">    header :</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">        The header object for which the hash is to be generated.</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">    Returns</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">    -------</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">    hash : `Hash32`</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        The PoW valid rlp hash of the passed in header.</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="n">header_data_without_pow_artefacts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">parent_hash</span><span class="p">,</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">ommers_hash</span><span class="p">,</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">state_root</span><span class="p">,</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">transactions_root</span><span class="p">,</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">receipt_root</span><span class="p">,</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">bloom</span><span class="p">,</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">gas_limit</span><span class="p">,</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">gas_used</span><span class="p">,</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">extra_data</span><span class="p">,</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>    <span class="p">]</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>    <span class="k">return</span> <span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">header_data_without_pow_artefacts</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="k">def</span> <span class="nf">validate_proof_of_work</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">    Validates the Proof of Work constraints.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">    In order to verify that a miner&#39;s proof-of-work is valid for a block, a</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">    ``mix-digest`` and ``result`` are calculated using the ``hashimoto_light``</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">    hash function. The mix digest is a hash of the header and the nonce that</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">    is passed through and it confirms whether or not proof-of-work was done</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">    on the correct block. The result is the actual hash value of the block.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">    Parameters</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">    ----------</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">    header :</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        Header of interest.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>    <span class="n">header_hash</span> <span class="o">=</span> <span class="n">generate_header_hash_for_pow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>    <span class="c1"># TODO: Memoize this somewhere and read from that data instead of</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>    <span class="c1"># calculating cache for every block validation.</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>    <span class="n">cache</span> <span class="o">=</span> <span class="n">generate_cache</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>    <span class="n">mix_digest</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">hashimoto_light</span><span class="p">(</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="n">header_hash</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">dataset_size</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>    <span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">mix_digest</span> <span class="o">==</span> <span class="n">header</span><span class="o">.</span><span class="n">mix_digest</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>    <span class="n">ensure</span><span class="p">(</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="n">Uint</span><span class="o">.</span><span class="n">from_be_bytes</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">U256_CEIL_VALUE</span> <span class="o">//</span> <span class="n">header</span><span class="o">.</span><span class="n">difficulty</span><span class="p">),</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="n">InvalidBlock</span><span class="p">,</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>    <span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="k">def</span> <span class="nf">check_transaction</span><span class="p">(</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>    <span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>    <span class="n">gas_available</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Address</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">    Check if the transaction is includable in the block.</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">    Parameters</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">    ----------</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">    tx :</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">        The transaction.</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">    gas_available :</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">        The gas remaining in the block.</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">    Returns</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">    -------</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">    sender_address :</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">        The sender of the transaction.</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">    Raises</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">    ------</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">    InvalidBlock :</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">        If the transaction is not includable.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">&lt;=</span> <span class="n">gas_available</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>    <span class="n">sender_address</span> <span class="o">=</span> <span class="n">recover_sender</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>    <span class="k">return</span> <span class="n">sender_address</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="k">def</span> <span class="nf">make_receipt</span><span class="p">(</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>    <span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>    <span class="n">post_state</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>    <span class="n">cumulative_gas_used</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>    <span class="n">logs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Log</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Receipt</span><span class="p">:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">    Make the receipt for a transaction that was executed.</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">    Parameters</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">    ----------</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">    tx :</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        The executed transaction.</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">    post_state :</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="sd">        The state root immediately after this transaction.</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">    cumulative_gas_used :</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">        The total gas used so far in the block after the transaction was</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">        executed.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">    logs :</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">        The logs produced by the transaction.</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">    Returns</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">    -------</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">    receipt :</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">        The receipt for the transaction.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>    <span class="n">receipt</span> <span class="o">=</span> <span class="n">Receipt</span><span class="p">(</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="n">post_state</span><span class="o">=</span><span class="n">post_state</span><span class="p">,</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="n">cumulative_gas_used</span><span class="o">=</span><span class="n">cumulative_gas_used</span><span class="p">,</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="n">bloom</span><span class="o">=</span><span class="n">logs_bloom</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="n">logs</span><span class="o">=</span><span class="n">logs</span><span class="p">,</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>    <span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>    <span class="k">return</span> <span class="n">receipt</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="k">def</span> <span class="nf">apply_body</span><span class="p">(</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>    <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>    <span class="n">block_hashes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Hash32</span><span class="p">],</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>    <span class="n">coinbase</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>    <span class="n">block_number</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>    <span class="n">block_gas_limit</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="n">block_time</span><span class="p">:</span> <span class="n">U256</span><span class="p">,</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>    <span class="n">block_difficulty</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>    <span class="n">transactions</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Transaction</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>    <span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Header</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Uint</span><span class="p">,</span> <span class="n">Root</span><span class="p">,</span> <span class="n">Root</span><span class="p">,</span> <span class="n">Bloom</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">    Executes a block.</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">    Many of the contents of a block are stored in data structures called</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">    tries. There is a transactions trie which is similar to a ledger of the</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">    transactions stored in the current block. There is also a receipts trie</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">    which stores the results of executing a transaction, like the post state</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">    and gas used. This function creates and executes the block that is to be</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">    added to the chain.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">    Parameters</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">    ----------</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">    state :</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        Current account state.</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">    block_hashes :</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">        List of hashes of the previous 256 blocks in the order of</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        increasing block number.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">    coinbase :</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">        Address of account which receives block reward and transaction fees.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">    block_number :</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        Position of the block within the chain.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">    block_gas_limit :</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        Initial amount of gas available for execution in this block.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">    block_time :</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        Time the block was produced, measured in seconds since the epoch.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">    block_difficulty :</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">        Difficulty of the block.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">    transactions :</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">        Transactions included in the block.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">    ommers :</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">        Headers of ancestor blocks which are not direct parents (formerly</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">        uncles.)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">    Returns</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">    -------</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">    block_gas_used : `ethereum.base_types.Uint`</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">        Gas used for executing all transactions.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">    transactions_root : `ethereum.fork_types.Root`</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">        Trie root of all the transactions in the block.</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">    receipt_root : `ethereum.fork_types.Root`</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">        Trie root of all the receipts in the block.</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">    block_logs_bloom : `Bloom`</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        Logs bloom of all the logs included in all the transactions of the</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        block.</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">    state : `ethereum.fork_types.State`</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        State after all transactions have been executed.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>    <span class="n">gas_available</span> <span class="o">=</span> <span class="n">block_gas_limit</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="n">transactions_trie</span><span class="p">:</span> <span class="n">Trie</span><span class="p">[</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Transaction</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Trie</span><span class="p">(</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="n">secured</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>    <span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>    <span class="n">receipts_trie</span><span class="p">:</span> <span class="n">Trie</span><span class="p">[</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Receipt</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Trie</span><span class="p">(</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="n">secured</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>    <span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>    <span class="n">block_logs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Log</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transactions</span><span class="p">):</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="n">trie_set</span><span class="p">(</span><span class="n">transactions_trie</span><span class="p">,</span> <span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Uint</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">tx</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="n">sender_address</span> <span class="o">=</span> <span class="n">check_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">gas_available</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="n">env</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="n">caller</span><span class="o">=</span><span class="n">sender_address</span><span class="p">,</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="n">origin</span><span class="o">=</span><span class="n">sender_address</span><span class="p">,</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="n">block_hashes</span><span class="o">=</span><span class="n">block_hashes</span><span class="p">,</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="n">coinbase</span><span class="o">=</span><span class="n">coinbase</span><span class="p">,</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>            <span class="n">number</span><span class="o">=</span><span class="n">block_number</span><span class="p">,</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="n">gas_limit</span><span class="o">=</span><span class="n">block_gas_limit</span><span class="p">,</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="n">gas_price</span><span class="o">=</span><span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">time</span><span class="o">=</span><span class="n">block_time</span><span class="p">,</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="n">difficulty</span><span class="o">=</span><span class="n">block_difficulty</span><span class="p">,</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>            <span class="n">traces</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="n">gas_used</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">process_transaction</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="n">gas_available</span> <span class="o">-=</span> <span class="n">gas_used</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="n">receipt</span> <span class="o">=</span> <span class="n">make_receipt</span><span class="p">(</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">tx</span><span class="p">,</span> <span class="n">state_root</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="p">(</span><span class="n">block_gas_limit</span> <span class="o">-</span> <span class="n">gas_available</span><span class="p">),</span> <span class="n">logs</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="n">trie_set</span><span class="p">(</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="n">receipts_trie</span><span class="p">,</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Uint</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="n">receipt</span><span class="p">,</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>        <span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="n">block_logs</span> <span class="o">+=</span> <span class="n">logs</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>    <span class="n">pay_rewards</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block_number</span><span class="p">,</span> <span class="n">coinbase</span><span class="p">,</span> <span class="n">ommers</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>    <span class="n">block_gas_used</span> <span class="o">=</span> <span class="n">block_gas_limit</span> <span class="o">-</span> <span class="n">gas_available</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>    <span class="n">block_logs_bloom</span> <span class="o">=</span> <span class="n">logs_bloom</span><span class="p">(</span><span class="n">block_logs</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>    <span class="k">return</span> <span class="p">(</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="n">block_gas_used</span><span class="p">,</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="n">root</span><span class="p">(</span><span class="n">transactions_trie</span><span class="p">),</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="n">root</span><span class="p">(</span><span class="n">receipts_trie</span><span class="p">),</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="n">block_logs_bloom</span><span class="p">,</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="n">state</span><span class="p">,</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>    <span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="k">def</span> <span class="nf">validate_ommers</span><span class="p">(</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>    <span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Header</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">block_header</span><span class="p">:</span> <span class="n">Header</span><span class="p">,</span> <span class="n">chain</span><span class="p">:</span> <span class="n">BlockChain</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a><span class="sd">    Validates the ommers mentioned in the block.</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="sd">    An ommer block is a block that wasn&#39;t canonically added to the</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="sd">    blockchain because it wasn&#39;t validated as fast as the canonical block</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a><span class="sd">    but was mined at the same time.</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="sd">    To be considered valid, the ommers must adhere to the rules defined in</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="sd">    the Ethereum protocol. The maximum amount of ommers is 2 per block and</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="sd">    there cannot be duplicate ommers in a block. Many of the other ommer</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="sd">    constraints are listed in the in-line comments of this function.</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">    Parameters</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="sd">    ----------</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">    ommers :</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="sd">        List of ommers mentioned in the current block.</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">    block_header:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="sd">        The header of current block.</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">    chain :</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="sd">        History and current state.</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>    <span class="n">block_hash</span> <span class="o">=</span> <span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">block_header</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">ommers</span><span class="p">)</span> <span class="o">==</span> <span class="n">block_header</span><span class="o">.</span><span class="n">ommers_hash</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ommers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="c1"># Nothing to validate</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="k">return</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>    <span class="c1"># Check that each ommer satisfies the constraints of a header</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>    <span class="k">for</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="n">ommers</span><span class="p">:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">ommer</span><span class="o">.</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">block_header</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="n">ommer_parent_header</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="o">-</span><span class="p">(</span><span class="n">block_header</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="n">ommer</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">header</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>        <span class="n">validate_header</span><span class="p">(</span><span class="n">ommer</span><span class="p">,</span> <span class="n">ommer_parent_header</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>    <span class="c1"># Check that there can be only at most 2 ommers for a block.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ommers</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>    <span class="n">ommers_hashes</span> <span class="o">=</span> <span class="p">[</span><span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">ommer</span><span class="p">)</span> <span class="k">for</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="n">ommers</span><span class="p">]</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>    <span class="c1"># Check that there are no duplicates in the ommers of current block</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ommers_hashes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ommers_hashes</span><span class="p">)),</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="n">recent_canonical_blocks</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">MAX_OMMER_DEPTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:]</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    <span class="n">recent_canonical_block_hashes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">recent_canonical_blocks</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>    <span class="p">}</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="n">recent_ommers_hashes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Hash32</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">recent_canonical_blocks</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="n">recent_ommers_hashes</span> <span class="o">=</span> <span class="n">recent_ommers_hashes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>            <span class="p">{</span><span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">ommer</span><span class="p">)</span> <span class="k">for</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">ommers</span><span class="p">}</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>    <span class="k">for</span> <span class="n">ommer_index</span><span class="p">,</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ommers</span><span class="p">):</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="n">ommer_hash</span> <span class="o">=</span> <span class="n">ommers_hashes</span><span class="p">[</span><span class="n">ommer_index</span><span class="p">]</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="c1"># The current block shouldn&#39;t be the ommer</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="n">ommer_hash</span> <span class="o">!=</span> <span class="n">block_hash</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>        <span class="c1"># Ommer shouldn&#39;t be one of the recent canonical blocks</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="n">ommer_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recent_canonical_block_hashes</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="c1"># Ommer shouldn&#39;t be one of the uncles mentioned in the recent</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        <span class="c1"># canonical blocks</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="n">ommer_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recent_ommers_hashes</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>        <span class="c1"># Ommer age with respect to the current block. For example, an age of</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="c1"># 1 indicates that the ommer is a sibling of previous block.</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>        <span class="n">ommer_age</span> <span class="o">=</span> <span class="n">block_header</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="n">ommer</span><span class="o">.</span><span class="n">number</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">ommer_age</span> <span class="o">&lt;=</span> <span class="n">MAX_OMMER_DEPTH</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        <span class="n">ensure</span><span class="p">(</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>            <span class="n">ommer</span><span class="o">.</span><span class="n">parent_hash</span> <span class="ow">in</span> <span class="n">recent_canonical_block_hashes</span><span class="p">,</span> <span class="n">InvalidBlock</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        <span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="n">ommer</span><span class="o">.</span><span class="n">parent_hash</span> <span class="o">!=</span> <span class="n">block_header</span><span class="o">.</span><span class="n">parent_hash</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a><span class="k">def</span> <span class="nf">pay_rewards</span><span class="p">(</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>    <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>    <span class="n">block_number</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>    <span class="n">coinbase</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>    <span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Header</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a><span class="sd">    Pay rewards to the block miner as well as the ommers miners.</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="sd">    The miner of the canonical block is rewarded with the predetermined</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="sd">    block reward, ``BLOCK_REWARD``, plus a variable award based off of the</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="sd">    number of ommer blocks that were mined around the same time, and included</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="sd">    in the canonical block&#39;s header. An ommer block is a block that wasn&#39;t</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">    added to the canonical blockchain because it wasn&#39;t validated as fast as</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="sd">    the accepted block but was mined at the same time. Although not all blocks</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a><span class="sd">    that are mined are added to the canonical chain, miners are still paid a</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="sd">    reward for their efforts. This reward is called an ommer reward and is</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="sd">    calculated based on the number associated with the ommer block that they</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">    mined.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">    Parameters</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">    ----------</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">    state :</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="sd">        Current account state.</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="sd">    block_number :</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">        Position of the block within the chain.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a><span class="sd">    coinbase :</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a><span class="sd">        Address of account which receives block reward and transaction fees.</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="sd">    ommers :</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="sd">        List of ommers mentioned in the current block.</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>    <span class="n">miner_reward</span> <span class="o">=</span> <span class="n">BLOCK_REWARD</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ommers</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">BLOCK_REWARD</span> <span class="o">//</span> <span class="mi">32</span><span class="p">))</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>    <span class="n">create_ether</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">coinbase</span><span class="p">,</span> <span class="n">miner_reward</span><span class="p">)</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>    <span class="k">for</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="n">ommers</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="c1"># Ommer age with respect to the current block.</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>        <span class="n">ommer_age</span> <span class="o">=</span> <span class="n">U256</span><span class="p">(</span><span class="n">block_number</span> <span class="o">-</span> <span class="n">ommer</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="n">ommer_miner_reward</span> <span class="o">=</span> <span class="p">((</span><span class="mi">8</span> <span class="o">-</span> <span class="n">ommer_age</span><span class="p">)</span> <span class="o">*</span> <span class="n">BLOCK_REWARD</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>        <span class="n">create_ether</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ommer</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span> <span class="n">ommer_miner_reward</span><span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a><span class="k">def</span> <span class="nf">process_transaction</span><span class="p">(</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>    <span class="n">env</span><span class="p">:</span> <span class="n">vm</span><span class="o">.</span><span class="n">Environment</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Uint</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Log</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a><span class="sd">    Execute a transaction against the provided environment.</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a><span class="sd">    This function processes the actions needed to execute a transaction.</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a><span class="sd">    It decrements the sender&#39;s account after calculating the gas fee and</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a><span class="sd">    refunds them the proper amount after execution. Calling contracts,</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="sd">    deploying code, and incrementing nonces are all examples of actions that</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a><span class="sd">    happen within this function or from a call made within this function.</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a><span class="sd">    Accounts that are marked for deletion are processed and destroyed after</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a><span class="sd">    execution.</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a><span class="sd">    Parameters</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a><span class="sd">    ----------</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a><span class="sd">    env :</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a><span class="sd">        Environment for the Ethereum Virtual Machine.</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a><span class="sd">    tx :</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a><span class="sd">        Transaction to execute.</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a><span class="sd">    Returns</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a><span class="sd">    -------</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a><span class="sd">    gas_left : `ethereum.base_types.U256`</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a><span class="sd">        Remaining gas after execution.</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a><span class="sd">    logs : `Tuple[ethereum.fork_types.Log, ...]`</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a><span class="sd">        Logs generated during execution.</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">validate_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>    <span class="n">sender</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">origin</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>    <span class="n">sender_account</span> <span class="o">=</span> <span class="n">get_account</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>    <span class="n">gas_fee</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">*</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">sender_account</span><span class="o">.</span><span class="n">nonce</span> <span class="o">==</span> <span class="n">tx</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">sender_account</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">gas_fee</span> <span class="o">+</span> <span class="n">tx</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">sender_account</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="nb">bytearray</span><span class="p">(),</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>    <span class="n">gas</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">-</span> <span class="n">calculate_intrinsic_cost</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>    <span class="n">increment_nonce</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>    <span class="n">sender_balance_after_gas_fee</span> <span class="o">=</span> <span class="n">sender_account</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">gas_fee</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>    <span class="n">set_account_balance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">sender_balance_after_gas_fee</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>    <span class="n">message</span> <span class="o">=</span> <span class="n">prepare_message</span><span class="p">(</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>        <span class="n">sender</span><span class="p">,</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="n">tx</span><span class="o">.</span><span class="n">to</span><span class="p">,</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="n">tx</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>        <span class="n">tx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="n">gas</span><span class="p">,</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="n">env</span><span class="p">,</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>    <span class="p">)</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">process_message_call</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>    <span class="n">gas_used</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">-</span> <span class="n">output</span><span class="o">.</span><span class="n">gas_left</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>    <span class="n">gas_refund</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gas_used</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">refund_counter</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>    <span class="n">gas_refund_amount</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">gas_left</span> <span class="o">+</span> <span class="n">gas_refund</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>    <span class="n">transaction_fee</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">-</span> <span class="n">output</span><span class="o">.</span><span class="n">gas_left</span> <span class="o">-</span> <span class="n">gas_refund</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>    <span class="n">total_gas_used</span> <span class="o">=</span> <span class="n">gas_used</span> <span class="o">-</span> <span class="n">gas_refund</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>    <span class="c1"># refund gas</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>    <span class="n">sender_balance_after_refund</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>        <span class="n">get_account</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">)</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">gas_refund_amount</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>    <span class="p">)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>    <span class="n">set_account_balance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">sender_balance_after_refund</span><span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>    <span class="c1"># transfer miner fees</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>    <span class="n">coinbase_balance_after_mining_fee</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="n">get_account</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">coinbase</span><span class="p">)</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">transaction_fee</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>    <span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>    <span class="n">set_account_balance</span><span class="p">(</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>        <span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span> <span class="n">coinbase_balance_after_mining_fee</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>    <span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>    <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">accounts_to_delete</span><span class="p">:</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>        <span class="n">destroy_account</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>    <span class="k">return</span> <span class="n">total_gas_used</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">logs</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a><span class="k">def</span> <span class="nf">validate_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a><span class="sd">    Verifies a transaction.</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a><span class="sd">    The gas in a transaction gets used to pay for the intrinsic cost of</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a><span class="sd">    operations, therefore if there is insufficient gas then it would not</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a><span class="sd">    be possible to execute a transaction and it will be declared invalid.</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="sd">    Additionally, the nonce of a transaction must not equal or exceed the</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a><span class="sd">    limit defined in `EIP-2681 &lt;https://eips.ethereum.org/EIPS/eip-2681&gt;`_.</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a><span class="sd">    In practice, defining the limit as ``2**64-1`` has no impact because</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">    sending ``2**64-1`` transactions is improbable. It&#39;s not strictly</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">    impossible though, ``2**64-1`` transactions is the entire capacity of the</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="sd">    Ethereum blockchain at 2022 gas limits for a little over 22 years.</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a><span class="sd">    Parameters</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="sd">    ----------</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a><span class="sd">    tx :</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a><span class="sd">        Transaction to validate.</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a><span class="sd">    Returns</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a><span class="sd">    -------</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a><span class="sd">    verified : `bool`</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a><span class="sd">        True if the transaction can be executed, or False otherwise.</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>    <span class="k">return</span> <span class="n">calculate_intrinsic_cost</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="ow">and</span> <span class="n">tx</span><span class="o">.</span><span class="n">nonce</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="k">def</span> <span class="nf">calculate_intrinsic_cost</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Uint</span><span class="p">:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a><span class="sd">    Calculates the gas that is charged before execution is started.</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a><span class="sd">    The intrinsic cost of the transaction is charged before execution has</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">    begun. Functions/operations in the EVM cost money to execute so this</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a><span class="sd">    intrinsic cost is for the operations that need to be paid for as part of</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a><span class="sd">    the transaction. Data transfer, for example, is part of this intrinsic</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a><span class="sd">    cost. It costs ether to send data over the wire and that ether is</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a><span class="sd">    accounted for in the intrinsic cost calculated in this function. This</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a><span class="sd">    intrinsic cost must be calculated and paid for before execution in order</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a><span class="sd">    for all operations to be implemented.</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a><span class="sd">    Parameters</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a><span class="sd">    ----------</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a><span class="sd">    tx :</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a><span class="sd">        Transaction to compute the intrinsic cost of.</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a><span class="sd">    Returns</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a><span class="sd">    -------</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a><span class="sd">    verified : `ethereum.base_types.Uint`</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a><span class="sd">        The intrinsic cost of the transaction.</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>    <span class="n">data_cost</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">tx</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>        <span class="k">if</span> <span class="n">byte</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>            <span class="n">data_cost</span> <span class="o">+=</span> <span class="n">TX_DATA_COST_PER_ZERO</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>            <span class="n">data_cost</span> <span class="o">+=</span> <span class="n">TX_DATA_COST_PER_NON_ZERO</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>    <span class="k">if</span> <span class="n">tx</span><span class="o">.</span><span class="n">to</span> <span class="o">==</span> <span class="n">Bytes0</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>        <span class="n">create_cost</span> <span class="o">=</span> <span class="n">TX_CREATE_COST</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>        <span class="n">create_cost</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>    <span class="k">return</span> <span class="n">Uint</span><span class="p">(</span><span class="n">TX_BASE_COST</span> <span class="o">+</span> <span class="n">data_cost</span> <span class="o">+</span> <span class="n">create_cost</span><span class="p">)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a><span class="k">def</span> <span class="nf">recover_sender</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Address</span><span class="p">:</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a><span class="sd">    Extracts the sender address from a transaction.</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a><span class="sd">    The v, r, and s values are the three parts that make up the signature</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a><span class="sd">    of a transaction. In order to recover the sender of a transaction the two</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a><span class="sd">    components needed are the signature (``v``, ``r``, and ``s``) and the</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a><span class="sd">    signing hash of the transaction. The sender&#39;s public key can be obtained</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a><span class="sd">    with these two values and therefore the sender address can be retrieved.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a><span class="sd">    Parameters</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="sd">    ----------</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="sd">    tx :</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a><span class="sd">        Transaction of interest.</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a><span class="sd">    Returns</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a><span class="sd">    -------</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a><span class="sd">    sender : `ethereum.fork_types.Address`</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a><span class="sd">        The address of the account that signed the transaction.</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>    <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">s</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>    <span class="c1">#  if v &gt; 28:</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>    <span class="c1">#      v = v - (chain_id*2+8)</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">27</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">28</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">SECP256K1N</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">SECP256K1N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>    <span class="n">public_key</span> <span class="o">=</span> <span class="n">secp256k1_recover</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">27</span><span class="p">,</span> <span class="n">signing_hash</span><span class="p">(</span><span class="n">tx</span><span class="p">))</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>    <span class="k">return</span> <span class="n">Address</span><span class="p">(</span><span class="n">keccak256</span><span class="p">(</span><span class="n">public_key</span><span class="p">)[</span><span class="mi">12</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a><span class="k">def</span> <span class="nf">signing_hash</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash32</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a><span class="sd">    Compute the hash of a transaction used in the signature.</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a><span class="sd">    The values that are used to compute the signing hash set the rules for a</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a><span class="sd">    transaction. For example, signing over the gas sets a limit for the</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a><span class="sd">    amount of money that is allowed to be pulled out of the sender&#39;s account.</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a><span class="sd">    Parameters</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a><span class="sd">    ----------</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a><span class="sd">    tx :</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a><span class="sd">        Transaction of interest.</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a><span class="sd">    Returns</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a><span class="sd">    -------</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a><span class="sd">    hash : `ethereum.crypto.hash.Hash32`</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a><span class="sd">        Hash of the transaction.</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>    <span class="k">return</span> <span class="n">keccak256</span><span class="p">(</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>        <span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>            <span class="p">(</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">to</span><span class="p">,</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>            <span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>        <span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>    <span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a><span class="k">def</span> <span class="nf">compute_header_hash</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash32</span><span class="p">:</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a><span class="sd">    Computes the hash of a block header.</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a><span class="sd">    The header hash of a block is the canonical hash that is used to refer</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a><span class="sd">    to a specific block and completely distinguishes a block from another.</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a><span class="sd">    ``keccak256`` is a function that produces a 256 bit hash of any input.</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a><span class="sd">    It also takes in any number of bytes as an input and produces a single</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a><span class="sd">    hash for them. A hash is a completely unique output for a single input.</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a><span class="sd">    So an input corresponds to one unique hash that can be used to identify</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a><span class="sd">    the input exactly.</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a><span class="sd">    Prior to using the ``keccak256`` hash function, the header must be</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a><span class="sd">    encoded using the Recursive-Length Prefix. See :ref:`rlp`.</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a><span class="sd">    RLP encoding the header converts it into a space-efficient format that</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a><span class="sd">    allows for easy transfer of data between nodes. The purpose of RLP is to</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a><span class="sd">    encode arbitrarily nested arrays of binary data, and RLP is the primary</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a><span class="sd">    encoding method used to serialize objects in Ethereum&#39;s execution layer.</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a><span class="sd">    The only purpose of RLP is to encode structure; encoding specific data</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a><span class="sd">    types (e.g. strings, floats) is left up to higher-order protocols.</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a><span class="sd">    Parameters</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a><span class="sd">    ----------</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a><span class="sd">    header :</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a><span class="sd">        Header of interest.</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a><span class="sd">    Returns</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a><span class="sd">    -------</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a><span class="sd">    hash : `ethereum.crypto.hash.Hash32`</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a><span class="sd">        Hash of the header.</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>    <span class="k">return</span> <span class="n">keccak256</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a><span class="k">def</span> <span class="nf">check_gas_limit</span><span class="p">(</span><span class="n">gas_limit</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span> <span class="n">parent_gas_limit</span><span class="p">:</span> <span class="n">Uint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a><span class="sd">    Validates the gas limit for a block.</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a><span class="sd">    The bounds of the gas limit, ``max_adjustment_delta``, is set as the</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a><span class="sd">    quotient of the parent block&#39;s gas limit and the</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a><span class="sd">    ``GAS_LIMIT_ADJUSTMENT_FACTOR``. Therefore, if the gas limit that is</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a><span class="sd">    passed through as a parameter is greater than or equal to the *sum* of</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a><span class="sd">    the parent&#39;s gas and the adjustment delta then the limit for gas is too</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a><span class="sd">    high and fails this function&#39;s check. Similarly, if the limit is less</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a><span class="sd">    than or equal to the *difference* of the parent&#39;s gas and the adjustment</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a><span class="sd">    delta *or* the predefined ``GAS_LIMIT_MINIMUM`` then this function&#39;s</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a><span class="sd">    check fails because the gas limit doesn&#39;t allow for a sufficient or</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a><span class="sd">    reasonable amount of gas to be used on a block.</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a><span class="sd">    Parameters</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a><span class="sd">    ----------</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a><span class="sd">    gas_limit :</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a><span class="sd">        Gas limit to validate.</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a><span class="sd">    parent_gas_limit :</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a><span class="sd">        Gas limit of the parent block.</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a><span class="sd">    Returns</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a><span class="sd">    -------</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a><span class="sd">    check : `bool`</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a><span class="sd">        True if gas limit constraints are satisfied, False otherwise.</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>    <span class="n">max_adjustment_delta</span> <span class="o">=</span> <span class="n">parent_gas_limit</span> <span class="o">//</span> <span class="n">GAS_LIMIT_ADJUSTMENT_FACTOR</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>    <span class="k">if</span> <span class="n">gas_limit</span> <span class="o">&gt;=</span> <span class="n">parent_gas_limit</span> <span class="o">+</span> <span class="n">max_adjustment_delta</span><span class="p">:</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a>    <span class="k">if</span> <span class="n">gas_limit</span> <span class="o">&lt;=</span> <span class="n">parent_gas_limit</span> <span class="o">-</span> <span class="n">max_adjustment_delta</span><span class="p">:</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>    <span class="k">if</span> <span class="n">gas_limit</span> <span class="o">&lt;</span> <span class="n">GAS_LIMIT_MINIMUM</span><span class="p">:</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos">890</span></a>
</span><span id="L-891"><a href="#L-891"><span class="linenos">891</span></a>
</span><span id="L-892"><a href="#L-892"><span class="linenos">892</span></a><span class="k">def</span> <span class="nf">calculate_block_difficulty</span><span class="p">(</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos">893</span></a>    <span class="n">block_number</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos">894</span></a>    <span class="n">block_timestamp</span><span class="p">:</span> <span class="n">U256</span><span class="p">,</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos">895</span></a>    <span class="n">parent_timestamp</span><span class="p">:</span> <span class="n">U256</span><span class="p">,</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos">896</span></a>    <span class="n">parent_difficulty</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos">897</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Uint</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos">898</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos">899</span></a><span class="sd">    Computes difficulty of a block using its header and parent header.</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos">900</span></a>
</span><span id="L-901"><a href="#L-901"><span class="linenos">901</span></a><span class="sd">    The difficulty is determined by the time the block was created after its</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos">902</span></a><span class="sd">    parent. The ``offset`` is calculated using the parent block&#39;s difficulty,</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos">903</span></a><span class="sd">    ``parent_difficulty``, and the timestamp between blocks. This offset is</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos">904</span></a><span class="sd">    then added to the parent difficulty and is stored as the ``difficulty``</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos">905</span></a><span class="sd">    variable. If the time between the block and its parent is too short, the</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos">906</span></a><span class="sd">    offset will result in a positive number thus making the sum of</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos">907</span></a><span class="sd">    ``parent_difficulty`` and ``offset`` to be a greater value in order to</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos">908</span></a><span class="sd">    avoid mass forking. But, if the time is long enough, then the offset</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos">909</span></a><span class="sd">    results in a negative value making the block less difficult than</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos">910</span></a><span class="sd">    its parent.</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos">911</span></a>
</span><span id="L-912"><a href="#L-912"><span class="linenos">912</span></a><span class="sd">    The base standard for a block&#39;s difficulty is the predefined value</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos">913</span></a><span class="sd">    set for the genesis block since it has no parent. So, a block</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos">914</span></a><span class="sd">    can&#39;t be less difficult than the genesis block, therefore each block&#39;s</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos">915</span></a><span class="sd">    difficulty is set to the maximum value between the calculated</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos">916</span></a><span class="sd">    difficulty and the ``GENESIS_DIFFICULTY``.</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos">917</span></a>
</span><span id="L-918"><a href="#L-918"><span class="linenos">918</span></a><span class="sd">    Parameters</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos">919</span></a><span class="sd">    ----------</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos">920</span></a><span class="sd">    block_number :</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos">921</span></a><span class="sd">        Block number of the block.</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos">922</span></a><span class="sd">    block_timestamp :</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos">923</span></a><span class="sd">        Timestamp of the block.</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos">924</span></a><span class="sd">    parent_timestamp :</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos">925</span></a><span class="sd">        Timestamp of the parent block.</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos">926</span></a><span class="sd">    parent_difficulty :</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos">927</span></a><span class="sd">        difficulty of the parent block.</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos">928</span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos">929</span></a><span class="sd">    Returns</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos">930</span></a><span class="sd">    -------</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos">931</span></a><span class="sd">    difficulty : `ethereum.base_types.Uint`</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos">932</span></a><span class="sd">        Computed difficulty for a block.</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos">933</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos">934</span></a>    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos">935</span></a>        <span class="nb">int</span><span class="p">(</span><span class="n">parent_difficulty</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos">936</span></a>        <span class="o">//</span> <span class="mi">2048</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos">937</span></a>        <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">block_timestamp</span> <span class="o">-</span> <span class="n">parent_timestamp</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span><span class="p">)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos">938</span></a>    <span class="p">)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos">939</span></a>    <span class="n">difficulty</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parent_difficulty</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos">940</span></a>    <span class="c1"># Historical Note: The difficulty bomb was not present in Ethereum at the</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos">941</span></a>    <span class="c1"># start of Frontier, but was added shortly after launch. However since the</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos">942</span></a>    <span class="c1"># bomb has no effect prior to block 200000 we pretend it existed from</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos">943</span></a>    <span class="c1"># genesis.</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos">944</span></a>    <span class="c1"># See https://github.com/ethereum/go-ethereum/pull/1588</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos">945</span></a>    <span class="n">num_bomb_periods</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">block_number</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos">946</span></a>    <span class="k">if</span> <span class="n">num_bomb_periods</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos">947</span></a>        <span class="n">difficulty</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">num_bomb_periods</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos">948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos">949</span></a>    <span class="c1"># Some clients raise the difficulty to `MINIMUM_DIFFICULTY` prior to adding</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos">950</span></a>    <span class="c1"># the bomb. This bug does not matter because the difficulty is always much</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos">951</span></a>    <span class="c1"># greater than `MINIMUM_DIFFICULTY` on Mainnet.</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos">952</span></a>    <span class="k">return</span> <span class="n">Uint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">difficulty</span><span class="p">,</span> <span class="n">MINIMUM_DIFFICULTY</span><span class="p">))</span>
</span></pre></div>


            </section>
                <section id="BlockChain">
                            <input id="BlockChain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclass</div>

    <span class="def">class</span>
    <span class="name">BlockChain</span>:

                <label class="view-source-button" for="BlockChain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BlockChain"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BlockChain-64"><a href="#BlockChain-64"><span class="linenos">64</span></a><span class="nd">@dataclass</span>
</span><span id="BlockChain-65"><a href="#BlockChain-65"><span class="linenos">65</span></a><span class="k">class</span> <span class="nc">BlockChain</span><span class="p">:</span>
</span><span id="BlockChain-66"><a href="#BlockChain-66"><span class="linenos">66</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BlockChain-67"><a href="#BlockChain-67"><span class="linenos">67</span></a><span class="sd">    History and current state of the block chain.</span>
</span><span id="BlockChain-68"><a href="#BlockChain-68"><span class="linenos">68</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BlockChain-69"><a href="#BlockChain-69"><span class="linenos">69</span></a>
</span><span id="BlockChain-70"><a href="#BlockChain-70"><span class="linenos">70</span></a>    <span class="n">blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span>
</span><span id="BlockChain-71"><a href="#BlockChain-71"><span class="linenos">71</span></a>    <span class="n">state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="BlockChain-72"><a href="#BlockChain-72"><span class="linenos">72</span></a>    <span class="n">chain_id</span><span class="p">:</span> <span class="n">U64</span>
</span></pre></div>


            <div class="docstring"><p>History and current state of the block chain.</p>
</div>


                </section>
                <section id="apply_fork">
                            <input id="apply_fork-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply_fork</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">old</span><span class="p">:</span> <span class="n"><a href="#BlockChain">BlockChain</a></span></span><span class="return-annotation">) -> <span class="n"><a href="#BlockChain">BlockChain</a></span>:</span></span>

                <label class="view-source-button" for="apply_fork-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#apply_fork"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="apply_fork-75"><a href="#apply_fork-75"><span class="linenos">75</span></a><span class="k">def</span> <span class="nf">apply_fork</span><span class="p">(</span><span class="n">old</span><span class="p">:</span> <span class="n">BlockChain</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockChain</span><span class="p">:</span>
</span><span id="apply_fork-76"><a href="#apply_fork-76"><span class="linenos">76</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="apply_fork-77"><a href="#apply_fork-77"><span class="linenos">77</span></a><span class="sd">    Transforms the state from the previous hard fork (`old`) into the block</span>
</span><span id="apply_fork-78"><a href="#apply_fork-78"><span class="linenos">78</span></a><span class="sd">    chain object for this hard fork and returns it.</span>
</span><span id="apply_fork-79"><a href="#apply_fork-79"><span class="linenos">79</span></a>
</span><span id="apply_fork-80"><a href="#apply_fork-80"><span class="linenos">80</span></a><span class="sd">    When forks need to implement an irregular state transition, this function</span>
</span><span id="apply_fork-81"><a href="#apply_fork-81"><span class="linenos">81</span></a><span class="sd">    is used to handle the irregularity. See the :ref:`DAO Fork &lt;dao-fork&gt;` for</span>
</span><span id="apply_fork-82"><a href="#apply_fork-82"><span class="linenos">82</span></a><span class="sd">    an example.</span>
</span><span id="apply_fork-83"><a href="#apply_fork-83"><span class="linenos">83</span></a>
</span><span id="apply_fork-84"><a href="#apply_fork-84"><span class="linenos">84</span></a><span class="sd">    Parameters</span>
</span><span id="apply_fork-85"><a href="#apply_fork-85"><span class="linenos">85</span></a><span class="sd">    ----------</span>
</span><span id="apply_fork-86"><a href="#apply_fork-86"><span class="linenos">86</span></a><span class="sd">    old :</span>
</span><span id="apply_fork-87"><a href="#apply_fork-87"><span class="linenos">87</span></a><span class="sd">        Previous block chain object.</span>
</span><span id="apply_fork-88"><a href="#apply_fork-88"><span class="linenos">88</span></a>
</span><span id="apply_fork-89"><a href="#apply_fork-89"><span class="linenos">89</span></a><span class="sd">    Returns</span>
</span><span id="apply_fork-90"><a href="#apply_fork-90"><span class="linenos">90</span></a><span class="sd">    -------</span>
</span><span id="apply_fork-91"><a href="#apply_fork-91"><span class="linenos">91</span></a><span class="sd">    new : `BlockChain`</span>
</span><span id="apply_fork-92"><a href="#apply_fork-92"><span class="linenos">92</span></a><span class="sd">        Upgraded block chain object for this hard fork.</span>
</span><span id="apply_fork-93"><a href="#apply_fork-93"><span class="linenos">93</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="apply_fork-94"><a href="#apply_fork-94"><span class="linenos">94</span></a>    <span class="k">return</span> <span class="n">old</span>
</span></pre></div>


            <div class="docstring"><p>Transforms the state from the previous hard fork (<code>old</code>) into the block
chain object for this hard fork and returns it.</p>

<p>When forks need to implement an irregular state transition, this function
is used to handle the irregularity. See the :ref:<code>DAO Fork &lt;dao-fork&gt;</code> for
an example.</p>

<h2 id="parameters">Parameters</h2>

<p>old :
    Previous block chain object.</p>

<h2 id="returns">Returns</h2>

<p>new : <code><a href="#BlockChain">BlockChain</a></code>
    Upgraded block chain object for this hard fork.</p>
</div>


                </section>
                <section id="get_last_256_block_hashes">
                            <input id="get_last_256_block_hashes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_last_256_block_hashes</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">chain</span><span class="p">:</span> <span class="n"><a href="#BlockChain">BlockChain</a></span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../base_types.html#Bytes32">ethereum.base_types.Bytes32</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="get_last_256_block_hashes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_last_256_block_hashes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_last_256_block_hashes-97"><a href="#get_last_256_block_hashes-97"><span class="linenos"> 97</span></a><span class="k">def</span> <span class="nf">get_last_256_block_hashes</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="n">BlockChain</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Hash32</span><span class="p">]:</span>
</span><span id="get_last_256_block_hashes-98"><a href="#get_last_256_block_hashes-98"><span class="linenos"> 98</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_last_256_block_hashes-99"><a href="#get_last_256_block_hashes-99"><span class="linenos"> 99</span></a><span class="sd">    Obtain the list of hashes of the previous 256 blocks in order of</span>
</span><span id="get_last_256_block_hashes-100"><a href="#get_last_256_block_hashes-100"><span class="linenos">100</span></a><span class="sd">    increasing block number.</span>
</span><span id="get_last_256_block_hashes-101"><a href="#get_last_256_block_hashes-101"><span class="linenos">101</span></a>
</span><span id="get_last_256_block_hashes-102"><a href="#get_last_256_block_hashes-102"><span class="linenos">102</span></a><span class="sd">    This function will return less hashes for the first 256 blocks.</span>
</span><span id="get_last_256_block_hashes-103"><a href="#get_last_256_block_hashes-103"><span class="linenos">103</span></a>
</span><span id="get_last_256_block_hashes-104"><a href="#get_last_256_block_hashes-104"><span class="linenos">104</span></a><span class="sd">    The ``BLOCKHASH`` opcode needs to access the latest hashes on the chain,</span>
</span><span id="get_last_256_block_hashes-105"><a href="#get_last_256_block_hashes-105"><span class="linenos">105</span></a><span class="sd">    therefore this function retrieves them.</span>
</span><span id="get_last_256_block_hashes-106"><a href="#get_last_256_block_hashes-106"><span class="linenos">106</span></a>
</span><span id="get_last_256_block_hashes-107"><a href="#get_last_256_block_hashes-107"><span class="linenos">107</span></a><span class="sd">    Parameters</span>
</span><span id="get_last_256_block_hashes-108"><a href="#get_last_256_block_hashes-108"><span class="linenos">108</span></a><span class="sd">    ----------</span>
</span><span id="get_last_256_block_hashes-109"><a href="#get_last_256_block_hashes-109"><span class="linenos">109</span></a><span class="sd">    chain :</span>
</span><span id="get_last_256_block_hashes-110"><a href="#get_last_256_block_hashes-110"><span class="linenos">110</span></a><span class="sd">        History and current state.</span>
</span><span id="get_last_256_block_hashes-111"><a href="#get_last_256_block_hashes-111"><span class="linenos">111</span></a>
</span><span id="get_last_256_block_hashes-112"><a href="#get_last_256_block_hashes-112"><span class="linenos">112</span></a><span class="sd">    Returns</span>
</span><span id="get_last_256_block_hashes-113"><a href="#get_last_256_block_hashes-113"><span class="linenos">113</span></a><span class="sd">    -------</span>
</span><span id="get_last_256_block_hashes-114"><a href="#get_last_256_block_hashes-114"><span class="linenos">114</span></a><span class="sd">    recent_block_hashes : `List[Hash32]`</span>
</span><span id="get_last_256_block_hashes-115"><a href="#get_last_256_block_hashes-115"><span class="linenos">115</span></a><span class="sd">        Hashes of the recent 256 blocks in order of increasing block number.</span>
</span><span id="get_last_256_block_hashes-116"><a href="#get_last_256_block_hashes-116"><span class="linenos">116</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_last_256_block_hashes-117"><a href="#get_last_256_block_hashes-117"><span class="linenos">117</span></a>    <span class="n">recent_blocks</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">255</span><span class="p">:]</span>
</span><span id="get_last_256_block_hashes-118"><a href="#get_last_256_block_hashes-118"><span class="linenos">118</span></a>    <span class="c1"># TODO: This function has not been tested rigorously</span>
</span><span id="get_last_256_block_hashes-119"><a href="#get_last_256_block_hashes-119"><span class="linenos">119</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_blocks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="get_last_256_block_hashes-120"><a href="#get_last_256_block_hashes-120"><span class="linenos">120</span></a>        <span class="k">return</span> <span class="p">[]</span>
</span><span id="get_last_256_block_hashes-121"><a href="#get_last_256_block_hashes-121"><span class="linenos">121</span></a>
</span><span id="get_last_256_block_hashes-122"><a href="#get_last_256_block_hashes-122"><span class="linenos">122</span></a>    <span class="n">recent_block_hashes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="get_last_256_block_hashes-123"><a href="#get_last_256_block_hashes-123"><span class="linenos">123</span></a>
</span><span id="get_last_256_block_hashes-124"><a href="#get_last_256_block_hashes-124"><span class="linenos">124</span></a>    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">recent_blocks</span><span class="p">:</span>
</span><span id="get_last_256_block_hashes-125"><a href="#get_last_256_block_hashes-125"><span class="linenos">125</span></a>        <span class="n">prev_block_hash</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">parent_hash</span>
</span><span id="get_last_256_block_hashes-126"><a href="#get_last_256_block_hashes-126"><span class="linenos">126</span></a>        <span class="n">recent_block_hashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_block_hash</span><span class="p">)</span>
</span><span id="get_last_256_block_hashes-127"><a href="#get_last_256_block_hashes-127"><span class="linenos">127</span></a>
</span><span id="get_last_256_block_hashes-128"><a href="#get_last_256_block_hashes-128"><span class="linenos">128</span></a>    <span class="c1"># We are computing the hash only for the most recent block and not for</span>
</span><span id="get_last_256_block_hashes-129"><a href="#get_last_256_block_hashes-129"><span class="linenos">129</span></a>    <span class="c1"># the rest of the blocks as they have successors which have the hash of</span>
</span><span id="get_last_256_block_hashes-130"><a href="#get_last_256_block_hashes-130"><span class="linenos">130</span></a>    <span class="c1"># the current block as parent hash.</span>
</span><span id="get_last_256_block_hashes-131"><a href="#get_last_256_block_hashes-131"><span class="linenos">131</span></a>    <span class="n">most_recent_block_hash</span> <span class="o">=</span> <span class="n">keccak256</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">recent_blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
</span><span id="get_last_256_block_hashes-132"><a href="#get_last_256_block_hashes-132"><span class="linenos">132</span></a>    <span class="n">recent_block_hashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">most_recent_block_hash</span><span class="p">)</span>
</span><span id="get_last_256_block_hashes-133"><a href="#get_last_256_block_hashes-133"><span class="linenos">133</span></a>
</span><span id="get_last_256_block_hashes-134"><a href="#get_last_256_block_hashes-134"><span class="linenos">134</span></a>    <span class="k">return</span> <span class="n">recent_block_hashes</span>
</span></pre></div>


            <div class="docstring"><p>Obtain the list of hashes of the previous 256 blocks in order of
increasing block number.</p>

<p>This function will return less hashes for the first 256 blocks.</p>

<p>The <code>BLOCKHASH</code> opcode needs to access the latest hashes on the chain,
therefore this function retrieves them.</p>

<h2 id="parameters">Parameters</h2>

<p>chain :
    History and current state.</p>

<h2 id="returns">Returns</h2>

<p>recent_block_hashes : <code>List[Hash32]</code>
    Hashes of the recent 256 blocks in order of increasing block number.</p>
</div>


                </section>
                <section id="state_transition">
                            <input id="state_transition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">state_transition</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">chain</span><span class="p">:</span> <span class="n"><a href="#BlockChain">BlockChain</a></span>,</span><span class="param">	<span class="n">block</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Block">ethereum.homestead.fork_types.Block</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="state_transition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#state_transition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="state_transition-137"><a href="#state_transition-137"><span class="linenos">137</span></a><span class="k">def</span> <span class="nf">state_transition</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="n">BlockChain</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="state_transition-138"><a href="#state_transition-138"><span class="linenos">138</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="state_transition-139"><a href="#state_transition-139"><span class="linenos">139</span></a><span class="sd">    Attempts to apply a block to an existing block chain.</span>
</span><span id="state_transition-140"><a href="#state_transition-140"><span class="linenos">140</span></a>
</span><span id="state_transition-141"><a href="#state_transition-141"><span class="linenos">141</span></a><span class="sd">    All parts of the block&#39;s contents need to be verified before being added</span>
</span><span id="state_transition-142"><a href="#state_transition-142"><span class="linenos">142</span></a><span class="sd">    to the chain. Blocks are verified by ensuring that the contents of the</span>
</span><span id="state_transition-143"><a href="#state_transition-143"><span class="linenos">143</span></a><span class="sd">    block make logical sense with the contents of the parent block. The</span>
</span><span id="state_transition-144"><a href="#state_transition-144"><span class="linenos">144</span></a><span class="sd">    information in the block&#39;s header must also match the corresponding</span>
</span><span id="state_transition-145"><a href="#state_transition-145"><span class="linenos">145</span></a><span class="sd">    information in the block.</span>
</span><span id="state_transition-146"><a href="#state_transition-146"><span class="linenos">146</span></a>
</span><span id="state_transition-147"><a href="#state_transition-147"><span class="linenos">147</span></a><span class="sd">    To implement Ethereum, in theory clients are only required to store the</span>
</span><span id="state_transition-148"><a href="#state_transition-148"><span class="linenos">148</span></a><span class="sd">    most recent 255 blocks of the chain since as far as execution is</span>
</span><span id="state_transition-149"><a href="#state_transition-149"><span class="linenos">149</span></a><span class="sd">    concerned, only those blocks are accessed. Practically, however, clients</span>
</span><span id="state_transition-150"><a href="#state_transition-150"><span class="linenos">150</span></a><span class="sd">    should store more blocks to handle reorgs.</span>
</span><span id="state_transition-151"><a href="#state_transition-151"><span class="linenos">151</span></a>
</span><span id="state_transition-152"><a href="#state_transition-152"><span class="linenos">152</span></a><span class="sd">    Parameters</span>
</span><span id="state_transition-153"><a href="#state_transition-153"><span class="linenos">153</span></a><span class="sd">    ----------</span>
</span><span id="state_transition-154"><a href="#state_transition-154"><span class="linenos">154</span></a><span class="sd">    chain :</span>
</span><span id="state_transition-155"><a href="#state_transition-155"><span class="linenos">155</span></a><span class="sd">        History and current state.</span>
</span><span id="state_transition-156"><a href="#state_transition-156"><span class="linenos">156</span></a><span class="sd">    block :</span>
</span><span id="state_transition-157"><a href="#state_transition-157"><span class="linenos">157</span></a><span class="sd">        Block to apply to `chain`.</span>
</span><span id="state_transition-158"><a href="#state_transition-158"><span class="linenos">158</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="state_transition-159"><a href="#state_transition-159"><span class="linenos">159</span></a>    <span class="n">parent_header</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
</span><span id="state_transition-160"><a href="#state_transition-160"><span class="linenos">160</span></a>    <span class="n">validate_header</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">parent_header</span><span class="p">)</span>
</span><span id="state_transition-161"><a href="#state_transition-161"><span class="linenos">161</span></a>    <span class="n">validate_ommers</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">ommers</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>
</span><span id="state_transition-162"><a href="#state_transition-162"><span class="linenos">162</span></a>    <span class="p">(</span>
</span><span id="state_transition-163"><a href="#state_transition-163"><span class="linenos">163</span></a>        <span class="n">gas_used</span><span class="p">,</span>
</span><span id="state_transition-164"><a href="#state_transition-164"><span class="linenos">164</span></a>        <span class="n">transactions_root</span><span class="p">,</span>
</span><span id="state_transition-165"><a href="#state_transition-165"><span class="linenos">165</span></a>        <span class="n">receipt_root</span><span class="p">,</span>
</span><span id="state_transition-166"><a href="#state_transition-166"><span class="linenos">166</span></a>        <span class="n">block_logs_bloom</span><span class="p">,</span>
</span><span id="state_transition-167"><a href="#state_transition-167"><span class="linenos">167</span></a>        <span class="n">state</span><span class="p">,</span>
</span><span id="state_transition-168"><a href="#state_transition-168"><span class="linenos">168</span></a>    <span class="p">)</span> <span class="o">=</span> <span class="n">apply_body</span><span class="p">(</span>
</span><span id="state_transition-169"><a href="#state_transition-169"><span class="linenos">169</span></a>        <span class="n">chain</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
</span><span id="state_transition-170"><a href="#state_transition-170"><span class="linenos">170</span></a>        <span class="n">get_last_256_block_hashes</span><span class="p">(</span><span class="n">chain</span><span class="p">),</span>
</span><span id="state_transition-171"><a href="#state_transition-171"><span class="linenos">171</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span>
</span><span id="state_transition-172"><a href="#state_transition-172"><span class="linenos">172</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
</span><span id="state_transition-173"><a href="#state_transition-173"><span class="linenos">173</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">gas_limit</span><span class="p">,</span>
</span><span id="state_transition-174"><a href="#state_transition-174"><span class="linenos">174</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span><span id="state_transition-175"><a href="#state_transition-175"><span class="linenos">175</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
</span><span id="state_transition-176"><a href="#state_transition-176"><span class="linenos">176</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">transactions</span><span class="p">,</span>
</span><span id="state_transition-177"><a href="#state_transition-177"><span class="linenos">177</span></a>        <span class="n">block</span><span class="o">.</span><span class="n">ommers</span><span class="p">,</span>
</span><span id="state_transition-178"><a href="#state_transition-178"><span class="linenos">178</span></a>    <span class="p">)</span>
</span><span id="state_transition-179"><a href="#state_transition-179"><span class="linenos">179</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">gas_used</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">gas_used</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="state_transition-180"><a href="#state_transition-180"><span class="linenos">180</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">transactions_root</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">transactions_root</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="state_transition-181"><a href="#state_transition-181"><span class="linenos">181</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">state_root</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">state_root</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="state_transition-182"><a href="#state_transition-182"><span class="linenos">182</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">receipt_root</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">receipt_root</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="state_transition-183"><a href="#state_transition-183"><span class="linenos">183</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">block_logs_bloom</span> <span class="o">==</span> <span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">bloom</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="state_transition-184"><a href="#state_transition-184"><span class="linenos">184</span></a>
</span><span id="state_transition-185"><a href="#state_transition-185"><span class="linenos">185</span></a>    <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span id="state_transition-186"><a href="#state_transition-186"><span class="linenos">186</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
</span><span id="state_transition-187"><a href="#state_transition-187"><span class="linenos">187</span></a>        <span class="c1"># Real clients have to store more blocks to deal with reorgs, but the</span>
</span><span id="state_transition-188"><a href="#state_transition-188"><span class="linenos">188</span></a>        <span class="c1"># protocol only requires the last 255</span>
</span><span id="state_transition-189"><a href="#state_transition-189"><span class="linenos">189</span></a>        <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">255</span><span class="p">:]</span>
</span></pre></div>


            <div class="docstring"><p>Attempts to apply a block to an existing block chain.</p>

<p>All parts of the block's contents need to be verified before being added
to the chain. Blocks are verified by ensuring that the contents of the
block make logical sense with the contents of the parent block. The
information in the block's header must also match the corresponding
information in the block.</p>

<p>To implement Ethereum, in theory clients are only required to store the
most recent 255 blocks of the chain since as far as execution is
concerned, only those blocks are accessed. Practically, however, clients
should store more blocks to handle reorgs.</p>

<h2 id="parameters">Parameters</h2>

<p>chain :
    History and current state.
block :
    Block to apply to <code>chain</code>.</p>
</div>


                </section>
                <section id="validate_header">
                            <input id="validate_header-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validate_header</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">header</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span>,</span><span class="param">	<span class="n">parent_header</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="validate_header-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#validate_header"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="validate_header-192"><a href="#validate_header-192"><span class="linenos">192</span></a><span class="k">def</span> <span class="nf">validate_header</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">,</span> <span class="n">parent_header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="validate_header-193"><a href="#validate_header-193"><span class="linenos">193</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="validate_header-194"><a href="#validate_header-194"><span class="linenos">194</span></a><span class="sd">    Verifies a block header.</span>
</span><span id="validate_header-195"><a href="#validate_header-195"><span class="linenos">195</span></a>
</span><span id="validate_header-196"><a href="#validate_header-196"><span class="linenos">196</span></a><span class="sd">    In order to consider a block&#39;s header valid, the logic for the</span>
</span><span id="validate_header-197"><a href="#validate_header-197"><span class="linenos">197</span></a><span class="sd">    quantities in the header should match the logic for the block itself.</span>
</span><span id="validate_header-198"><a href="#validate_header-198"><span class="linenos">198</span></a><span class="sd">    For example the header timestamp should be greater than the block&#39;s parent</span>
</span><span id="validate_header-199"><a href="#validate_header-199"><span class="linenos">199</span></a><span class="sd">    timestamp because the block was created *after* the parent block.</span>
</span><span id="validate_header-200"><a href="#validate_header-200"><span class="linenos">200</span></a><span class="sd">    Additionally, the block&#39;s number should be directly following the parent</span>
</span><span id="validate_header-201"><a href="#validate_header-201"><span class="linenos">201</span></a><span class="sd">    block&#39;s number since it is the next block in the sequence.</span>
</span><span id="validate_header-202"><a href="#validate_header-202"><span class="linenos">202</span></a>
</span><span id="validate_header-203"><a href="#validate_header-203"><span class="linenos">203</span></a><span class="sd">    Parameters</span>
</span><span id="validate_header-204"><a href="#validate_header-204"><span class="linenos">204</span></a><span class="sd">    ----------</span>
</span><span id="validate_header-205"><a href="#validate_header-205"><span class="linenos">205</span></a><span class="sd">    header :</span>
</span><span id="validate_header-206"><a href="#validate_header-206"><span class="linenos">206</span></a><span class="sd">        Header to check for correctness.</span>
</span><span id="validate_header-207"><a href="#validate_header-207"><span class="linenos">207</span></a><span class="sd">    parent_header :</span>
</span><span id="validate_header-208"><a href="#validate_header-208"><span class="linenos">208</span></a><span class="sd">        Parent Header of the header to check for correctness</span>
</span><span id="validate_header-209"><a href="#validate_header-209"><span class="linenos">209</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="validate_header-210"><a href="#validate_header-210"><span class="linenos">210</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">parent_header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_header-211"><a href="#validate_header-211"><span class="linenos">211</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="n">parent_header</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_header-212"><a href="#validate_header-212"><span class="linenos">212</span></a>    <span class="n">ensure</span><span class="p">(</span>
</span><span id="validate_header-213"><a href="#validate_header-213"><span class="linenos">213</span></a>        <span class="n">check_gas_limit</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">gas_limit</span><span class="p">,</span> <span class="n">parent_header</span><span class="o">.</span><span class="n">gas_limit</span><span class="p">),</span>
</span><span id="validate_header-214"><a href="#validate_header-214"><span class="linenos">214</span></a>        <span class="n">InvalidBlock</span><span class="p">,</span>
</span><span id="validate_header-215"><a href="#validate_header-215"><span class="linenos">215</span></a>    <span class="p">)</span>
</span><span id="validate_header-216"><a href="#validate_header-216"><span class="linenos">216</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">extra_data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_header-217"><a href="#validate_header-217"><span class="linenos">217</span></a>
</span><span id="validate_header-218"><a href="#validate_header-218"><span class="linenos">218</span></a>    <span class="n">block_difficulty</span> <span class="o">=</span> <span class="n">calculate_block_difficulty</span><span class="p">(</span>
</span><span id="validate_header-219"><a href="#validate_header-219"><span class="linenos">219</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
</span><span id="validate_header-220"><a href="#validate_header-220"><span class="linenos">220</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span><span id="validate_header-221"><a href="#validate_header-221"><span class="linenos">221</span></a>        <span class="n">parent_header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span><span id="validate_header-222"><a href="#validate_header-222"><span class="linenos">222</span></a>        <span class="n">parent_header</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
</span><span id="validate_header-223"><a href="#validate_header-223"><span class="linenos">223</span></a>    <span class="p">)</span>
</span><span id="validate_header-224"><a href="#validate_header-224"><span class="linenos">224</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">difficulty</span> <span class="o">==</span> <span class="n">block_difficulty</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_header-225"><a href="#validate_header-225"><span class="linenos">225</span></a>
</span><span id="validate_header-226"><a href="#validate_header-226"><span class="linenos">226</span></a>    <span class="n">block_parent_hash</span> <span class="o">=</span> <span class="n">keccak256</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">parent_header</span><span class="p">))</span>
</span><span id="validate_header-227"><a href="#validate_header-227"><span class="linenos">227</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">parent_hash</span> <span class="o">==</span> <span class="n">block_parent_hash</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_header-228"><a href="#validate_header-228"><span class="linenos">228</span></a>
</span><span id="validate_header-229"><a href="#validate_header-229"><span class="linenos">229</span></a>    <span class="n">validate_proof_of_work</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Verifies a block header.</p>

<p>In order to consider a block's header valid, the logic for the
quantities in the header should match the logic for the block itself.
For example the header timestamp should be greater than the block's parent
timestamp because the block was created <em>after</em> the parent block.
Additionally, the block's number should be directly following the parent
block's number since it is the next block in the sequence.</p>

<h2 id="parameters">Parameters</h2>

<p>header :
    Header to check for correctness.
parent_header :
    Parent Header of the header to check for correctness</p>
</div>


                </section>
                <section id="generate_header_hash_for_pow">
                            <input id="generate_header_hash_for_pow-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_header_hash_for_pow</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">header</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../base_types.html#Bytes32">ethereum.base_types.Bytes32</a></span>:</span></span>

                <label class="view-source-button" for="generate_header_hash_for_pow-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_header_hash_for_pow"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_header_hash_for_pow-232"><a href="#generate_header_hash_for_pow-232"><span class="linenos">232</span></a><span class="k">def</span> <span class="nf">generate_header_hash_for_pow</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash32</span><span class="p">:</span>
</span><span id="generate_header_hash_for_pow-233"><a href="#generate_header_hash_for_pow-233"><span class="linenos">233</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="generate_header_hash_for_pow-234"><a href="#generate_header_hash_for_pow-234"><span class="linenos">234</span></a><span class="sd">    Generate rlp hash of the header which is to be used for Proof-of-Work</span>
</span><span id="generate_header_hash_for_pow-235"><a href="#generate_header_hash_for_pow-235"><span class="linenos">235</span></a><span class="sd">    verification.</span>
</span><span id="generate_header_hash_for_pow-236"><a href="#generate_header_hash_for_pow-236"><span class="linenos">236</span></a>
</span><span id="generate_header_hash_for_pow-237"><a href="#generate_header_hash_for_pow-237"><span class="linenos">237</span></a><span class="sd">    In other words, the PoW artefacts `mix_digest` and `nonce` are ignored</span>
</span><span id="generate_header_hash_for_pow-238"><a href="#generate_header_hash_for_pow-238"><span class="linenos">238</span></a><span class="sd">    while calculating this hash.</span>
</span><span id="generate_header_hash_for_pow-239"><a href="#generate_header_hash_for_pow-239"><span class="linenos">239</span></a>
</span><span id="generate_header_hash_for_pow-240"><a href="#generate_header_hash_for_pow-240"><span class="linenos">240</span></a><span class="sd">    A particular PoW is valid for a single hash, that hash is computed by</span>
</span><span id="generate_header_hash_for_pow-241"><a href="#generate_header_hash_for_pow-241"><span class="linenos">241</span></a><span class="sd">    this function. The `nonce` and `mix_digest` are omitted from this hash</span>
</span><span id="generate_header_hash_for_pow-242"><a href="#generate_header_hash_for_pow-242"><span class="linenos">242</span></a><span class="sd">    because they are being changed by miners in their search for a sufficient</span>
</span><span id="generate_header_hash_for_pow-243"><a href="#generate_header_hash_for_pow-243"><span class="linenos">243</span></a><span class="sd">    proof-of-work.</span>
</span><span id="generate_header_hash_for_pow-244"><a href="#generate_header_hash_for_pow-244"><span class="linenos">244</span></a>
</span><span id="generate_header_hash_for_pow-245"><a href="#generate_header_hash_for_pow-245"><span class="linenos">245</span></a><span class="sd">    Parameters</span>
</span><span id="generate_header_hash_for_pow-246"><a href="#generate_header_hash_for_pow-246"><span class="linenos">246</span></a><span class="sd">    ----------</span>
</span><span id="generate_header_hash_for_pow-247"><a href="#generate_header_hash_for_pow-247"><span class="linenos">247</span></a><span class="sd">    header :</span>
</span><span id="generate_header_hash_for_pow-248"><a href="#generate_header_hash_for_pow-248"><span class="linenos">248</span></a><span class="sd">        The header object for which the hash is to be generated.</span>
</span><span id="generate_header_hash_for_pow-249"><a href="#generate_header_hash_for_pow-249"><span class="linenos">249</span></a>
</span><span id="generate_header_hash_for_pow-250"><a href="#generate_header_hash_for_pow-250"><span class="linenos">250</span></a><span class="sd">    Returns</span>
</span><span id="generate_header_hash_for_pow-251"><a href="#generate_header_hash_for_pow-251"><span class="linenos">251</span></a><span class="sd">    -------</span>
</span><span id="generate_header_hash_for_pow-252"><a href="#generate_header_hash_for_pow-252"><span class="linenos">252</span></a><span class="sd">    hash : `Hash32`</span>
</span><span id="generate_header_hash_for_pow-253"><a href="#generate_header_hash_for_pow-253"><span class="linenos">253</span></a><span class="sd">        The PoW valid rlp hash of the passed in header.</span>
</span><span id="generate_header_hash_for_pow-254"><a href="#generate_header_hash_for_pow-254"><span class="linenos">254</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="generate_header_hash_for_pow-255"><a href="#generate_header_hash_for_pow-255"><span class="linenos">255</span></a>    <span class="n">header_data_without_pow_artefacts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="generate_header_hash_for_pow-256"><a href="#generate_header_hash_for_pow-256"><span class="linenos">256</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">parent_hash</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-257"><a href="#generate_header_hash_for_pow-257"><span class="linenos">257</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">ommers_hash</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-258"><a href="#generate_header_hash_for_pow-258"><span class="linenos">258</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-259"><a href="#generate_header_hash_for_pow-259"><span class="linenos">259</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">state_root</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-260"><a href="#generate_header_hash_for_pow-260"><span class="linenos">260</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">transactions_root</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-261"><a href="#generate_header_hash_for_pow-261"><span class="linenos">261</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">receipt_root</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-262"><a href="#generate_header_hash_for_pow-262"><span class="linenos">262</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">bloom</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-263"><a href="#generate_header_hash_for_pow-263"><span class="linenos">263</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-264"><a href="#generate_header_hash_for_pow-264"><span class="linenos">264</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-265"><a href="#generate_header_hash_for_pow-265"><span class="linenos">265</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">gas_limit</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-266"><a href="#generate_header_hash_for_pow-266"><span class="linenos">266</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">gas_used</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-267"><a href="#generate_header_hash_for_pow-267"><span class="linenos">267</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-268"><a href="#generate_header_hash_for_pow-268"><span class="linenos">268</span></a>        <span class="n">header</span><span class="o">.</span><span class="n">extra_data</span><span class="p">,</span>
</span><span id="generate_header_hash_for_pow-269"><a href="#generate_header_hash_for_pow-269"><span class="linenos">269</span></a>    <span class="p">]</span>
</span><span id="generate_header_hash_for_pow-270"><a href="#generate_header_hash_for_pow-270"><span class="linenos">270</span></a>
</span><span id="generate_header_hash_for_pow-271"><a href="#generate_header_hash_for_pow-271"><span class="linenos">271</span></a>    <span class="k">return</span> <span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">header_data_without_pow_artefacts</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate rlp hash of the header which is to be used for Proof-of-Work
verification.</p>

<p>In other words, the PoW artefacts <code>mix_digest</code> and <code>nonce</code> are ignored
while calculating this hash.</p>

<p>A particular PoW is valid for a single hash, that hash is computed by
this function. The <code>nonce</code> and <code>mix_digest</code> are omitted from this hash
because they are being changed by miners in their search for a sufficient
proof-of-work.</p>

<h2 id="parameters">Parameters</h2>

<p>header :
    The header object for which the hash is to be generated.</p>

<h2 id="returns">Returns</h2>

<p>hash : <code>Hash32</code>
    The PoW valid rlp hash of the passed in header.</p>
</div>


                </section>
                <section id="validate_proof_of_work">
                            <input id="validate_proof_of_work-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validate_proof_of_work</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">header</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="validate_proof_of_work-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#validate_proof_of_work"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="validate_proof_of_work-274"><a href="#validate_proof_of_work-274"><span class="linenos">274</span></a><span class="k">def</span> <span class="nf">validate_proof_of_work</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="validate_proof_of_work-275"><a href="#validate_proof_of_work-275"><span class="linenos">275</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="validate_proof_of_work-276"><a href="#validate_proof_of_work-276"><span class="linenos">276</span></a><span class="sd">    Validates the Proof of Work constraints.</span>
</span><span id="validate_proof_of_work-277"><a href="#validate_proof_of_work-277"><span class="linenos">277</span></a>
</span><span id="validate_proof_of_work-278"><a href="#validate_proof_of_work-278"><span class="linenos">278</span></a><span class="sd">    In order to verify that a miner&#39;s proof-of-work is valid for a block, a</span>
</span><span id="validate_proof_of_work-279"><a href="#validate_proof_of_work-279"><span class="linenos">279</span></a><span class="sd">    ``mix-digest`` and ``result`` are calculated using the ``hashimoto_light``</span>
</span><span id="validate_proof_of_work-280"><a href="#validate_proof_of_work-280"><span class="linenos">280</span></a><span class="sd">    hash function. The mix digest is a hash of the header and the nonce that</span>
</span><span id="validate_proof_of_work-281"><a href="#validate_proof_of_work-281"><span class="linenos">281</span></a><span class="sd">    is passed through and it confirms whether or not proof-of-work was done</span>
</span><span id="validate_proof_of_work-282"><a href="#validate_proof_of_work-282"><span class="linenos">282</span></a><span class="sd">    on the correct block. The result is the actual hash value of the block.</span>
</span><span id="validate_proof_of_work-283"><a href="#validate_proof_of_work-283"><span class="linenos">283</span></a>
</span><span id="validate_proof_of_work-284"><a href="#validate_proof_of_work-284"><span class="linenos">284</span></a><span class="sd">    Parameters</span>
</span><span id="validate_proof_of_work-285"><a href="#validate_proof_of_work-285"><span class="linenos">285</span></a><span class="sd">    ----------</span>
</span><span id="validate_proof_of_work-286"><a href="#validate_proof_of_work-286"><span class="linenos">286</span></a><span class="sd">    header :</span>
</span><span id="validate_proof_of_work-287"><a href="#validate_proof_of_work-287"><span class="linenos">287</span></a><span class="sd">        Header of interest.</span>
</span><span id="validate_proof_of_work-288"><a href="#validate_proof_of_work-288"><span class="linenos">288</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="validate_proof_of_work-289"><a href="#validate_proof_of_work-289"><span class="linenos">289</span></a>    <span class="n">header_hash</span> <span class="o">=</span> <span class="n">generate_header_hash_for_pow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
</span><span id="validate_proof_of_work-290"><a href="#validate_proof_of_work-290"><span class="linenos">290</span></a>    <span class="c1"># TODO: Memoize this somewhere and read from that data instead of</span>
</span><span id="validate_proof_of_work-291"><a href="#validate_proof_of_work-291"><span class="linenos">291</span></a>    <span class="c1"># calculating cache for every block validation.</span>
</span><span id="validate_proof_of_work-292"><a href="#validate_proof_of_work-292"><span class="linenos">292</span></a>    <span class="n">cache</span> <span class="o">=</span> <span class="n">generate_cache</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</span><span id="validate_proof_of_work-293"><a href="#validate_proof_of_work-293"><span class="linenos">293</span></a>    <span class="n">mix_digest</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">hashimoto_light</span><span class="p">(</span>
</span><span id="validate_proof_of_work-294"><a href="#validate_proof_of_work-294"><span class="linenos">294</span></a>        <span class="n">header_hash</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">dataset_size</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</span><span id="validate_proof_of_work-295"><a href="#validate_proof_of_work-295"><span class="linenos">295</span></a>    <span class="p">)</span>
</span><span id="validate_proof_of_work-296"><a href="#validate_proof_of_work-296"><span class="linenos">296</span></a>
</span><span id="validate_proof_of_work-297"><a href="#validate_proof_of_work-297"><span class="linenos">297</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">mix_digest</span> <span class="o">==</span> <span class="n">header</span><span class="o">.</span><span class="n">mix_digest</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_proof_of_work-298"><a href="#validate_proof_of_work-298"><span class="linenos">298</span></a>    <span class="n">ensure</span><span class="p">(</span>
</span><span id="validate_proof_of_work-299"><a href="#validate_proof_of_work-299"><span class="linenos">299</span></a>        <span class="n">Uint</span><span class="o">.</span><span class="n">from_be_bytes</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">U256_CEIL_VALUE</span> <span class="o">//</span> <span class="n">header</span><span class="o">.</span><span class="n">difficulty</span><span class="p">),</span>
</span><span id="validate_proof_of_work-300"><a href="#validate_proof_of_work-300"><span class="linenos">300</span></a>        <span class="n">InvalidBlock</span><span class="p">,</span>
</span><span id="validate_proof_of_work-301"><a href="#validate_proof_of_work-301"><span class="linenos">301</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Validates the Proof of Work constraints.</p>

<p>In order to verify that a miner's proof-of-work is valid for a block, a
<code>mix-digest</code> and <code>result</code> are calculated using the <code>hashimoto_light</code>
hash function. The mix digest is a hash of the header and the nonce that
is passed through and it confirms whether or not proof-of-work was done
on the correct block. The result is the actual hash value of the block.</p>

<h2 id="parameters">Parameters</h2>

<p>header :
    Header of interest.</p>
</div>


                </section>
                <section id="check_transaction">
                            <input id="check_transaction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_transaction</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tx</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Transaction">ethereum.homestead.fork_types.Transaction</a></span>,</span><span class="param">	<span class="n">gas_available</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../base_types.html#Bytes20">ethereum.base_types.Bytes20</a></span>:</span></span>

                <label class="view-source-button" for="check_transaction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_transaction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_transaction-304"><a href="#check_transaction-304"><span class="linenos">304</span></a><span class="k">def</span> <span class="nf">check_transaction</span><span class="p">(</span>
</span><span id="check_transaction-305"><a href="#check_transaction-305"><span class="linenos">305</span></a>    <span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
</span><span id="check_transaction-306"><a href="#check_transaction-306"><span class="linenos">306</span></a>    <span class="n">gas_available</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="check_transaction-307"><a href="#check_transaction-307"><span class="linenos">307</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Address</span><span class="p">:</span>
</span><span id="check_transaction-308"><a href="#check_transaction-308"><span class="linenos">308</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_transaction-309"><a href="#check_transaction-309"><span class="linenos">309</span></a><span class="sd">    Check if the transaction is includable in the block.</span>
</span><span id="check_transaction-310"><a href="#check_transaction-310"><span class="linenos">310</span></a>
</span><span id="check_transaction-311"><a href="#check_transaction-311"><span class="linenos">311</span></a><span class="sd">    Parameters</span>
</span><span id="check_transaction-312"><a href="#check_transaction-312"><span class="linenos">312</span></a><span class="sd">    ----------</span>
</span><span id="check_transaction-313"><a href="#check_transaction-313"><span class="linenos">313</span></a><span class="sd">    tx :</span>
</span><span id="check_transaction-314"><a href="#check_transaction-314"><span class="linenos">314</span></a><span class="sd">        The transaction.</span>
</span><span id="check_transaction-315"><a href="#check_transaction-315"><span class="linenos">315</span></a><span class="sd">    gas_available :</span>
</span><span id="check_transaction-316"><a href="#check_transaction-316"><span class="linenos">316</span></a><span class="sd">        The gas remaining in the block.</span>
</span><span id="check_transaction-317"><a href="#check_transaction-317"><span class="linenos">317</span></a>
</span><span id="check_transaction-318"><a href="#check_transaction-318"><span class="linenos">318</span></a><span class="sd">    Returns</span>
</span><span id="check_transaction-319"><a href="#check_transaction-319"><span class="linenos">319</span></a><span class="sd">    -------</span>
</span><span id="check_transaction-320"><a href="#check_transaction-320"><span class="linenos">320</span></a><span class="sd">    sender_address :</span>
</span><span id="check_transaction-321"><a href="#check_transaction-321"><span class="linenos">321</span></a><span class="sd">        The sender of the transaction.</span>
</span><span id="check_transaction-322"><a href="#check_transaction-322"><span class="linenos">322</span></a>
</span><span id="check_transaction-323"><a href="#check_transaction-323"><span class="linenos">323</span></a><span class="sd">    Raises</span>
</span><span id="check_transaction-324"><a href="#check_transaction-324"><span class="linenos">324</span></a><span class="sd">    ------</span>
</span><span id="check_transaction-325"><a href="#check_transaction-325"><span class="linenos">325</span></a><span class="sd">    InvalidBlock :</span>
</span><span id="check_transaction-326"><a href="#check_transaction-326"><span class="linenos">326</span></a><span class="sd">        If the transaction is not includable.</span>
</span><span id="check_transaction-327"><a href="#check_transaction-327"><span class="linenos">327</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_transaction-328"><a href="#check_transaction-328"><span class="linenos">328</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">&lt;=</span> <span class="n">gas_available</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="check_transaction-329"><a href="#check_transaction-329"><span class="linenos">329</span></a>    <span class="n">sender_address</span> <span class="o">=</span> <span class="n">recover_sender</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
</span><span id="check_transaction-330"><a href="#check_transaction-330"><span class="linenos">330</span></a>
</span><span id="check_transaction-331"><a href="#check_transaction-331"><span class="linenos">331</span></a>    <span class="k">return</span> <span class="n">sender_address</span>
</span></pre></div>


            <div class="docstring"><p>Check if the transaction is includable in the block.</p>

<h2 id="parameters">Parameters</h2>

<p>tx :
    The transaction.
gas_available :
    The gas remaining in the block.</p>

<h2 id="returns">Returns</h2>

<p>sender_address :
    The sender of the transaction.</p>

<h2 id="raises">Raises</h2>

<p>InvalidBlock :
    If the transaction is not includable.</p>
</div>


                </section>
                <section id="make_receipt">
                            <input id="make_receipt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">make_receipt</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tx</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Transaction">ethereum.homestead.fork_types.Transaction</a></span>,</span><span class="param">	<span class="n">post_state</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Bytes32">ethereum.base_types.Bytes32</a></span>,</span><span class="param">	<span class="n">cumulative_gas_used</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>,</span><span class="param">	<span class="n">logs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n"><a href="fork_types.html#Log">ethereum.homestead.fork_types.Log</a></span><span class="p">,</span> <span class="o">...</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="fork_types.html#Receipt">ethereum.homestead.fork_types.Receipt</a></span>:</span></span>

                <label class="view-source-button" for="make_receipt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#make_receipt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="make_receipt-334"><a href="#make_receipt-334"><span class="linenos">334</span></a><span class="k">def</span> <span class="nf">make_receipt</span><span class="p">(</span>
</span><span id="make_receipt-335"><a href="#make_receipt-335"><span class="linenos">335</span></a>    <span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
</span><span id="make_receipt-336"><a href="#make_receipt-336"><span class="linenos">336</span></a>    <span class="n">post_state</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">,</span>
</span><span id="make_receipt-337"><a href="#make_receipt-337"><span class="linenos">337</span></a>    <span class="n">cumulative_gas_used</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="make_receipt-338"><a href="#make_receipt-338"><span class="linenos">338</span></a>    <span class="n">logs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Log</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="make_receipt-339"><a href="#make_receipt-339"><span class="linenos">339</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Receipt</span><span class="p">:</span>
</span><span id="make_receipt-340"><a href="#make_receipt-340"><span class="linenos">340</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="make_receipt-341"><a href="#make_receipt-341"><span class="linenos">341</span></a><span class="sd">    Make the receipt for a transaction that was executed.</span>
</span><span id="make_receipt-342"><a href="#make_receipt-342"><span class="linenos">342</span></a>
</span><span id="make_receipt-343"><a href="#make_receipt-343"><span class="linenos">343</span></a><span class="sd">    Parameters</span>
</span><span id="make_receipt-344"><a href="#make_receipt-344"><span class="linenos">344</span></a><span class="sd">    ----------</span>
</span><span id="make_receipt-345"><a href="#make_receipt-345"><span class="linenos">345</span></a><span class="sd">    tx :</span>
</span><span id="make_receipt-346"><a href="#make_receipt-346"><span class="linenos">346</span></a><span class="sd">        The executed transaction.</span>
</span><span id="make_receipt-347"><a href="#make_receipt-347"><span class="linenos">347</span></a><span class="sd">    post_state :</span>
</span><span id="make_receipt-348"><a href="#make_receipt-348"><span class="linenos">348</span></a><span class="sd">        The state root immediately after this transaction.</span>
</span><span id="make_receipt-349"><a href="#make_receipt-349"><span class="linenos">349</span></a><span class="sd">    cumulative_gas_used :</span>
</span><span id="make_receipt-350"><a href="#make_receipt-350"><span class="linenos">350</span></a><span class="sd">        The total gas used so far in the block after the transaction was</span>
</span><span id="make_receipt-351"><a href="#make_receipt-351"><span class="linenos">351</span></a><span class="sd">        executed.</span>
</span><span id="make_receipt-352"><a href="#make_receipt-352"><span class="linenos">352</span></a><span class="sd">    logs :</span>
</span><span id="make_receipt-353"><a href="#make_receipt-353"><span class="linenos">353</span></a><span class="sd">        The logs produced by the transaction.</span>
</span><span id="make_receipt-354"><a href="#make_receipt-354"><span class="linenos">354</span></a>
</span><span id="make_receipt-355"><a href="#make_receipt-355"><span class="linenos">355</span></a><span class="sd">    Returns</span>
</span><span id="make_receipt-356"><a href="#make_receipt-356"><span class="linenos">356</span></a><span class="sd">    -------</span>
</span><span id="make_receipt-357"><a href="#make_receipt-357"><span class="linenos">357</span></a><span class="sd">    receipt :</span>
</span><span id="make_receipt-358"><a href="#make_receipt-358"><span class="linenos">358</span></a><span class="sd">        The receipt for the transaction.</span>
</span><span id="make_receipt-359"><a href="#make_receipt-359"><span class="linenos">359</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="make_receipt-360"><a href="#make_receipt-360"><span class="linenos">360</span></a>    <span class="n">receipt</span> <span class="o">=</span> <span class="n">Receipt</span><span class="p">(</span>
</span><span id="make_receipt-361"><a href="#make_receipt-361"><span class="linenos">361</span></a>        <span class="n">post_state</span><span class="o">=</span><span class="n">post_state</span><span class="p">,</span>
</span><span id="make_receipt-362"><a href="#make_receipt-362"><span class="linenos">362</span></a>        <span class="n">cumulative_gas_used</span><span class="o">=</span><span class="n">cumulative_gas_used</span><span class="p">,</span>
</span><span id="make_receipt-363"><a href="#make_receipt-363"><span class="linenos">363</span></a>        <span class="n">bloom</span><span class="o">=</span><span class="n">logs_bloom</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span>
</span><span id="make_receipt-364"><a href="#make_receipt-364"><span class="linenos">364</span></a>        <span class="n">logs</span><span class="o">=</span><span class="n">logs</span><span class="p">,</span>
</span><span id="make_receipt-365"><a href="#make_receipt-365"><span class="linenos">365</span></a>    <span class="p">)</span>
</span><span id="make_receipt-366"><a href="#make_receipt-366"><span class="linenos">366</span></a>
</span><span id="make_receipt-367"><a href="#make_receipt-367"><span class="linenos">367</span></a>    <span class="k">return</span> <span class="n">receipt</span>
</span></pre></div>


            <div class="docstring"><p>Make the receipt for a transaction that was executed.</p>

<h2 id="parameters">Parameters</h2>

<p>tx :
    The executed transaction.
post_state :
    The state root immediately after this transaction.
cumulative_gas_used :
    The total gas used so far in the block after the transaction was
    executed.
logs :
    The logs produced by the transaction.</p>

<h2 id="returns">Returns</h2>

<p>receipt :
    The receipt for the transaction.</p>
</div>


                </section>
                <section id="apply_body">
                            <input id="apply_body-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply_body</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">state</span><span class="p">:</span> <span class="n"><a href="state.html#State">ethereum.homestead.state.State</a></span>,</span><span class="param">	<span class="n">block_hashes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../base_types.html#Bytes32">ethereum.base_types.Bytes32</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">coinbase</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Bytes20">ethereum.base_types.Bytes20</a></span>,</span><span class="param">	<span class="n">block_number</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>,</span><span class="param">	<span class="n">block_gas_limit</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>,</span><span class="param">	<span class="n">block_time</span><span class="p">:</span> <span class="n"><a href="../base_types.html#U256">ethereum.base_types.U256</a></span>,</span><span class="param">	<span class="n">block_difficulty</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>,</span><span class="param">	<span class="n">transactions</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n"><a href="fork_types.html#Transaction">ethereum.homestead.fork_types.Transaction</a></span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>,</span><span class="param">	<span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span><span class="p">,</span> <span class="o">...</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span><span class="p">,</span> <span class="n"><a href="../base_types.html#Bytes32">ethereum.base_types.Bytes32</a></span><span class="p">,</span> <span class="n"><a href="../base_types.html#Bytes32">ethereum.base_types.Bytes32</a></span><span class="p">,</span> <span class="n"><a href="../base_types.html#Bytes256">ethereum.base_types.Bytes256</a></span><span class="p">,</span> <span class="n"><a href="state.html#State">ethereum.homestead.state.State</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="apply_body-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#apply_body"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="apply_body-370"><a href="#apply_body-370"><span class="linenos">370</span></a><span class="k">def</span> <span class="nf">apply_body</span><span class="p">(</span>
</span><span id="apply_body-371"><a href="#apply_body-371"><span class="linenos">371</span></a>    <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span>
</span><span id="apply_body-372"><a href="#apply_body-372"><span class="linenos">372</span></a>    <span class="n">block_hashes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Hash32</span><span class="p">],</span>
</span><span id="apply_body-373"><a href="#apply_body-373"><span class="linenos">373</span></a>    <span class="n">coinbase</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span>
</span><span id="apply_body-374"><a href="#apply_body-374"><span class="linenos">374</span></a>    <span class="n">block_number</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="apply_body-375"><a href="#apply_body-375"><span class="linenos">375</span></a>    <span class="n">block_gas_limit</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="apply_body-376"><a href="#apply_body-376"><span class="linenos">376</span></a>    <span class="n">block_time</span><span class="p">:</span> <span class="n">U256</span><span class="p">,</span>
</span><span id="apply_body-377"><a href="#apply_body-377"><span class="linenos">377</span></a>    <span class="n">block_difficulty</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="apply_body-378"><a href="#apply_body-378"><span class="linenos">378</span></a>    <span class="n">transactions</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Transaction</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="apply_body-379"><a href="#apply_body-379"><span class="linenos">379</span></a>    <span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Header</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="apply_body-380"><a href="#apply_body-380"><span class="linenos">380</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Uint</span><span class="p">,</span> <span class="n">Root</span><span class="p">,</span> <span class="n">Root</span><span class="p">,</span> <span class="n">Bloom</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="apply_body-381"><a href="#apply_body-381"><span class="linenos">381</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="apply_body-382"><a href="#apply_body-382"><span class="linenos">382</span></a><span class="sd">    Executes a block.</span>
</span><span id="apply_body-383"><a href="#apply_body-383"><span class="linenos">383</span></a>
</span><span id="apply_body-384"><a href="#apply_body-384"><span class="linenos">384</span></a><span class="sd">    Many of the contents of a block are stored in data structures called</span>
</span><span id="apply_body-385"><a href="#apply_body-385"><span class="linenos">385</span></a><span class="sd">    tries. There is a transactions trie which is similar to a ledger of the</span>
</span><span id="apply_body-386"><a href="#apply_body-386"><span class="linenos">386</span></a><span class="sd">    transactions stored in the current block. There is also a receipts trie</span>
</span><span id="apply_body-387"><a href="#apply_body-387"><span class="linenos">387</span></a><span class="sd">    which stores the results of executing a transaction, like the post state</span>
</span><span id="apply_body-388"><a href="#apply_body-388"><span class="linenos">388</span></a><span class="sd">    and gas used. This function creates and executes the block that is to be</span>
</span><span id="apply_body-389"><a href="#apply_body-389"><span class="linenos">389</span></a><span class="sd">    added to the chain.</span>
</span><span id="apply_body-390"><a href="#apply_body-390"><span class="linenos">390</span></a>
</span><span id="apply_body-391"><a href="#apply_body-391"><span class="linenos">391</span></a><span class="sd">    Parameters</span>
</span><span id="apply_body-392"><a href="#apply_body-392"><span class="linenos">392</span></a><span class="sd">    ----------</span>
</span><span id="apply_body-393"><a href="#apply_body-393"><span class="linenos">393</span></a><span class="sd">    state :</span>
</span><span id="apply_body-394"><a href="#apply_body-394"><span class="linenos">394</span></a><span class="sd">        Current account state.</span>
</span><span id="apply_body-395"><a href="#apply_body-395"><span class="linenos">395</span></a><span class="sd">    block_hashes :</span>
</span><span id="apply_body-396"><a href="#apply_body-396"><span class="linenos">396</span></a><span class="sd">        List of hashes of the previous 256 blocks in the order of</span>
</span><span id="apply_body-397"><a href="#apply_body-397"><span class="linenos">397</span></a><span class="sd">        increasing block number.</span>
</span><span id="apply_body-398"><a href="#apply_body-398"><span class="linenos">398</span></a><span class="sd">    coinbase :</span>
</span><span id="apply_body-399"><a href="#apply_body-399"><span class="linenos">399</span></a><span class="sd">        Address of account which receives block reward and transaction fees.</span>
</span><span id="apply_body-400"><a href="#apply_body-400"><span class="linenos">400</span></a><span class="sd">    block_number :</span>
</span><span id="apply_body-401"><a href="#apply_body-401"><span class="linenos">401</span></a><span class="sd">        Position of the block within the chain.</span>
</span><span id="apply_body-402"><a href="#apply_body-402"><span class="linenos">402</span></a><span class="sd">    block_gas_limit :</span>
</span><span id="apply_body-403"><a href="#apply_body-403"><span class="linenos">403</span></a><span class="sd">        Initial amount of gas available for execution in this block.</span>
</span><span id="apply_body-404"><a href="#apply_body-404"><span class="linenos">404</span></a><span class="sd">    block_time :</span>
</span><span id="apply_body-405"><a href="#apply_body-405"><span class="linenos">405</span></a><span class="sd">        Time the block was produced, measured in seconds since the epoch.</span>
</span><span id="apply_body-406"><a href="#apply_body-406"><span class="linenos">406</span></a><span class="sd">    block_difficulty :</span>
</span><span id="apply_body-407"><a href="#apply_body-407"><span class="linenos">407</span></a><span class="sd">        Difficulty of the block.</span>
</span><span id="apply_body-408"><a href="#apply_body-408"><span class="linenos">408</span></a><span class="sd">    transactions :</span>
</span><span id="apply_body-409"><a href="#apply_body-409"><span class="linenos">409</span></a><span class="sd">        Transactions included in the block.</span>
</span><span id="apply_body-410"><a href="#apply_body-410"><span class="linenos">410</span></a><span class="sd">    ommers :</span>
</span><span id="apply_body-411"><a href="#apply_body-411"><span class="linenos">411</span></a><span class="sd">        Headers of ancestor blocks which are not direct parents (formerly</span>
</span><span id="apply_body-412"><a href="#apply_body-412"><span class="linenos">412</span></a><span class="sd">        uncles.)</span>
</span><span id="apply_body-413"><a href="#apply_body-413"><span class="linenos">413</span></a>
</span><span id="apply_body-414"><a href="#apply_body-414"><span class="linenos">414</span></a><span class="sd">    Returns</span>
</span><span id="apply_body-415"><a href="#apply_body-415"><span class="linenos">415</span></a><span class="sd">    -------</span>
</span><span id="apply_body-416"><a href="#apply_body-416"><span class="linenos">416</span></a><span class="sd">    block_gas_used : `ethereum.base_types.Uint`</span>
</span><span id="apply_body-417"><a href="#apply_body-417"><span class="linenos">417</span></a><span class="sd">        Gas used for executing all transactions.</span>
</span><span id="apply_body-418"><a href="#apply_body-418"><span class="linenos">418</span></a><span class="sd">    transactions_root : `ethereum.fork_types.Root`</span>
</span><span id="apply_body-419"><a href="#apply_body-419"><span class="linenos">419</span></a><span class="sd">        Trie root of all the transactions in the block.</span>
</span><span id="apply_body-420"><a href="#apply_body-420"><span class="linenos">420</span></a><span class="sd">    receipt_root : `ethereum.fork_types.Root`</span>
</span><span id="apply_body-421"><a href="#apply_body-421"><span class="linenos">421</span></a><span class="sd">        Trie root of all the receipts in the block.</span>
</span><span id="apply_body-422"><a href="#apply_body-422"><span class="linenos">422</span></a><span class="sd">    block_logs_bloom : `Bloom`</span>
</span><span id="apply_body-423"><a href="#apply_body-423"><span class="linenos">423</span></a><span class="sd">        Logs bloom of all the logs included in all the transactions of the</span>
</span><span id="apply_body-424"><a href="#apply_body-424"><span class="linenos">424</span></a><span class="sd">        block.</span>
</span><span id="apply_body-425"><a href="#apply_body-425"><span class="linenos">425</span></a><span class="sd">    state : `ethereum.fork_types.State`</span>
</span><span id="apply_body-426"><a href="#apply_body-426"><span class="linenos">426</span></a><span class="sd">        State after all transactions have been executed.</span>
</span><span id="apply_body-427"><a href="#apply_body-427"><span class="linenos">427</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="apply_body-428"><a href="#apply_body-428"><span class="linenos">428</span></a>    <span class="n">gas_available</span> <span class="o">=</span> <span class="n">block_gas_limit</span>
</span><span id="apply_body-429"><a href="#apply_body-429"><span class="linenos">429</span></a>    <span class="n">transactions_trie</span><span class="p">:</span> <span class="n">Trie</span><span class="p">[</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Transaction</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Trie</span><span class="p">(</span>
</span><span id="apply_body-430"><a href="#apply_body-430"><span class="linenos">430</span></a>        <span class="n">secured</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
</span><span id="apply_body-431"><a href="#apply_body-431"><span class="linenos">431</span></a>    <span class="p">)</span>
</span><span id="apply_body-432"><a href="#apply_body-432"><span class="linenos">432</span></a>    <span class="n">receipts_trie</span><span class="p">:</span> <span class="n">Trie</span><span class="p">[</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Receipt</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Trie</span><span class="p">(</span>
</span><span id="apply_body-433"><a href="#apply_body-433"><span class="linenos">433</span></a>        <span class="n">secured</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
</span><span id="apply_body-434"><a href="#apply_body-434"><span class="linenos">434</span></a>    <span class="p">)</span>
</span><span id="apply_body-435"><a href="#apply_body-435"><span class="linenos">435</span></a>    <span class="n">block_logs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Log</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="apply_body-436"><a href="#apply_body-436"><span class="linenos">436</span></a>
</span><span id="apply_body-437"><a href="#apply_body-437"><span class="linenos">437</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transactions</span><span class="p">):</span>
</span><span id="apply_body-438"><a href="#apply_body-438"><span class="linenos">438</span></a>        <span class="n">trie_set</span><span class="p">(</span><span class="n">transactions_trie</span><span class="p">,</span> <span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Uint</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">tx</span><span class="p">)</span>
</span><span id="apply_body-439"><a href="#apply_body-439"><span class="linenos">439</span></a>
</span><span id="apply_body-440"><a href="#apply_body-440"><span class="linenos">440</span></a>        <span class="n">sender_address</span> <span class="o">=</span> <span class="n">check_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">gas_available</span><span class="p">)</span>
</span><span id="apply_body-441"><a href="#apply_body-441"><span class="linenos">441</span></a>
</span><span id="apply_body-442"><a href="#apply_body-442"><span class="linenos">442</span></a>        <span class="n">env</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span>
</span><span id="apply_body-443"><a href="#apply_body-443"><span class="linenos">443</span></a>            <span class="n">caller</span><span class="o">=</span><span class="n">sender_address</span><span class="p">,</span>
</span><span id="apply_body-444"><a href="#apply_body-444"><span class="linenos">444</span></a>            <span class="n">origin</span><span class="o">=</span><span class="n">sender_address</span><span class="p">,</span>
</span><span id="apply_body-445"><a href="#apply_body-445"><span class="linenos">445</span></a>            <span class="n">block_hashes</span><span class="o">=</span><span class="n">block_hashes</span><span class="p">,</span>
</span><span id="apply_body-446"><a href="#apply_body-446"><span class="linenos">446</span></a>            <span class="n">coinbase</span><span class="o">=</span><span class="n">coinbase</span><span class="p">,</span>
</span><span id="apply_body-447"><a href="#apply_body-447"><span class="linenos">447</span></a>            <span class="n">number</span><span class="o">=</span><span class="n">block_number</span><span class="p">,</span>
</span><span id="apply_body-448"><a href="#apply_body-448"><span class="linenos">448</span></a>            <span class="n">gas_limit</span><span class="o">=</span><span class="n">block_gas_limit</span><span class="p">,</span>
</span><span id="apply_body-449"><a href="#apply_body-449"><span class="linenos">449</span></a>            <span class="n">gas_price</span><span class="o">=</span><span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span><span id="apply_body-450"><a href="#apply_body-450"><span class="linenos">450</span></a>            <span class="n">time</span><span class="o">=</span><span class="n">block_time</span><span class="p">,</span>
</span><span id="apply_body-451"><a href="#apply_body-451"><span class="linenos">451</span></a>            <span class="n">difficulty</span><span class="o">=</span><span class="n">block_difficulty</span><span class="p">,</span>
</span><span id="apply_body-452"><a href="#apply_body-452"><span class="linenos">452</span></a>            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
</span><span id="apply_body-453"><a href="#apply_body-453"><span class="linenos">453</span></a>            <span class="n">traces</span><span class="o">=</span><span class="p">[],</span>
</span><span id="apply_body-454"><a href="#apply_body-454"><span class="linenos">454</span></a>        <span class="p">)</span>
</span><span id="apply_body-455"><a href="#apply_body-455"><span class="linenos">455</span></a>
</span><span id="apply_body-456"><a href="#apply_body-456"><span class="linenos">456</span></a>        <span class="n">gas_used</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">process_transaction</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
</span><span id="apply_body-457"><a href="#apply_body-457"><span class="linenos">457</span></a>        <span class="n">gas_available</span> <span class="o">-=</span> <span class="n">gas_used</span>
</span><span id="apply_body-458"><a href="#apply_body-458"><span class="linenos">458</span></a>
</span><span id="apply_body-459"><a href="#apply_body-459"><span class="linenos">459</span></a>        <span class="n">receipt</span> <span class="o">=</span> <span class="n">make_receipt</span><span class="p">(</span>
</span><span id="apply_body-460"><a href="#apply_body-460"><span class="linenos">460</span></a>            <span class="n">tx</span><span class="p">,</span> <span class="n">state_root</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="p">(</span><span class="n">block_gas_limit</span> <span class="o">-</span> <span class="n">gas_available</span><span class="p">),</span> <span class="n">logs</span>
</span><span id="apply_body-461"><a href="#apply_body-461"><span class="linenos">461</span></a>        <span class="p">)</span>
</span><span id="apply_body-462"><a href="#apply_body-462"><span class="linenos">462</span></a>
</span><span id="apply_body-463"><a href="#apply_body-463"><span class="linenos">463</span></a>        <span class="n">trie_set</span><span class="p">(</span>
</span><span id="apply_body-464"><a href="#apply_body-464"><span class="linenos">464</span></a>            <span class="n">receipts_trie</span><span class="p">,</span>
</span><span id="apply_body-465"><a href="#apply_body-465"><span class="linenos">465</span></a>            <span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">Uint</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
</span><span id="apply_body-466"><a href="#apply_body-466"><span class="linenos">466</span></a>            <span class="n">receipt</span><span class="p">,</span>
</span><span id="apply_body-467"><a href="#apply_body-467"><span class="linenos">467</span></a>        <span class="p">)</span>
</span><span id="apply_body-468"><a href="#apply_body-468"><span class="linenos">468</span></a>
</span><span id="apply_body-469"><a href="#apply_body-469"><span class="linenos">469</span></a>        <span class="n">block_logs</span> <span class="o">+=</span> <span class="n">logs</span>
</span><span id="apply_body-470"><a href="#apply_body-470"><span class="linenos">470</span></a>
</span><span id="apply_body-471"><a href="#apply_body-471"><span class="linenos">471</span></a>    <span class="n">pay_rewards</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block_number</span><span class="p">,</span> <span class="n">coinbase</span><span class="p">,</span> <span class="n">ommers</span><span class="p">)</span>
</span><span id="apply_body-472"><a href="#apply_body-472"><span class="linenos">472</span></a>
</span><span id="apply_body-473"><a href="#apply_body-473"><span class="linenos">473</span></a>    <span class="n">block_gas_used</span> <span class="o">=</span> <span class="n">block_gas_limit</span> <span class="o">-</span> <span class="n">gas_available</span>
</span><span id="apply_body-474"><a href="#apply_body-474"><span class="linenos">474</span></a>
</span><span id="apply_body-475"><a href="#apply_body-475"><span class="linenos">475</span></a>    <span class="n">block_logs_bloom</span> <span class="o">=</span> <span class="n">logs_bloom</span><span class="p">(</span><span class="n">block_logs</span><span class="p">)</span>
</span><span id="apply_body-476"><a href="#apply_body-476"><span class="linenos">476</span></a>
</span><span id="apply_body-477"><a href="#apply_body-477"><span class="linenos">477</span></a>    <span class="k">return</span> <span class="p">(</span>
</span><span id="apply_body-478"><a href="#apply_body-478"><span class="linenos">478</span></a>        <span class="n">block_gas_used</span><span class="p">,</span>
</span><span id="apply_body-479"><a href="#apply_body-479"><span class="linenos">479</span></a>        <span class="n">root</span><span class="p">(</span><span class="n">transactions_trie</span><span class="p">),</span>
</span><span id="apply_body-480"><a href="#apply_body-480"><span class="linenos">480</span></a>        <span class="n">root</span><span class="p">(</span><span class="n">receipts_trie</span><span class="p">),</span>
</span><span id="apply_body-481"><a href="#apply_body-481"><span class="linenos">481</span></a>        <span class="n">block_logs_bloom</span><span class="p">,</span>
</span><span id="apply_body-482"><a href="#apply_body-482"><span class="linenos">482</span></a>        <span class="n">state</span><span class="p">,</span>
</span><span id="apply_body-483"><a href="#apply_body-483"><span class="linenos">483</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Executes a block.</p>

<p>Many of the contents of a block are stored in data structures called
tries. There is a transactions trie which is similar to a ledger of the
transactions stored in the current block. There is also a receipts trie
which stores the results of executing a transaction, like the post state
and gas used. This function creates and executes the block that is to be
added to the chain.</p>

<h2 id="parameters">Parameters</h2>

<p>state :
    Current account state.
block_hashes :
    List of hashes of the previous 256 blocks in the order of
    increasing block number.
coinbase :
    Address of account which receives block reward and transaction fees.
block_number :
    Position of the block within the chain.
block_gas_limit :
    Initial amount of gas available for execution in this block.
block_time :
    Time the block was produced, measured in seconds since the epoch.
block_difficulty :
    Difficulty of the block.
transactions :
    Transactions included in the block.
ommers :
    Headers of ancestor blocks which are not direct parents (formerly
    uncles.)</p>

<h2 id="returns">Returns</h2>

<p>block_gas_used : <code><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></code>
    Gas used for executing all transactions.
transactions_root : <code>ethereum.fork_types.Root</code>
    Trie root of all the transactions in the block.
receipt_root : <code>ethereum.fork_types.Root</code>
    Trie root of all the receipts in the block.
block_logs_bloom : <code>Bloom</code>
    Logs bloom of all the logs included in all the transactions of the
    block.
state : <code>ethereum.fork_types.State</code>
    State after all transactions have been executed.</p>
</div>


                </section>
                <section id="validate_ommers">
                            <input id="validate_ommers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validate_ommers</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>,</span><span class="param">	<span class="n">block_header</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span>,</span><span class="param">	<span class="n">chain</span><span class="p">:</span> <span class="n"><a href="#BlockChain">BlockChain</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="validate_ommers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#validate_ommers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="validate_ommers-486"><a href="#validate_ommers-486"><span class="linenos">486</span></a><span class="k">def</span> <span class="nf">validate_ommers</span><span class="p">(</span>
</span><span id="validate_ommers-487"><a href="#validate_ommers-487"><span class="linenos">487</span></a>    <span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Header</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">block_header</span><span class="p">:</span> <span class="n">Header</span><span class="p">,</span> <span class="n">chain</span><span class="p">:</span> <span class="n">BlockChain</span>
</span><span id="validate_ommers-488"><a href="#validate_ommers-488"><span class="linenos">488</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="validate_ommers-489"><a href="#validate_ommers-489"><span class="linenos">489</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="validate_ommers-490"><a href="#validate_ommers-490"><span class="linenos">490</span></a><span class="sd">    Validates the ommers mentioned in the block.</span>
</span><span id="validate_ommers-491"><a href="#validate_ommers-491"><span class="linenos">491</span></a>
</span><span id="validate_ommers-492"><a href="#validate_ommers-492"><span class="linenos">492</span></a><span class="sd">    An ommer block is a block that wasn&#39;t canonically added to the</span>
</span><span id="validate_ommers-493"><a href="#validate_ommers-493"><span class="linenos">493</span></a><span class="sd">    blockchain because it wasn&#39;t validated as fast as the canonical block</span>
</span><span id="validate_ommers-494"><a href="#validate_ommers-494"><span class="linenos">494</span></a><span class="sd">    but was mined at the same time.</span>
</span><span id="validate_ommers-495"><a href="#validate_ommers-495"><span class="linenos">495</span></a>
</span><span id="validate_ommers-496"><a href="#validate_ommers-496"><span class="linenos">496</span></a><span class="sd">    To be considered valid, the ommers must adhere to the rules defined in</span>
</span><span id="validate_ommers-497"><a href="#validate_ommers-497"><span class="linenos">497</span></a><span class="sd">    the Ethereum protocol. The maximum amount of ommers is 2 per block and</span>
</span><span id="validate_ommers-498"><a href="#validate_ommers-498"><span class="linenos">498</span></a><span class="sd">    there cannot be duplicate ommers in a block. Many of the other ommer</span>
</span><span id="validate_ommers-499"><a href="#validate_ommers-499"><span class="linenos">499</span></a><span class="sd">    constraints are listed in the in-line comments of this function.</span>
</span><span id="validate_ommers-500"><a href="#validate_ommers-500"><span class="linenos">500</span></a>
</span><span id="validate_ommers-501"><a href="#validate_ommers-501"><span class="linenos">501</span></a><span class="sd">    Parameters</span>
</span><span id="validate_ommers-502"><a href="#validate_ommers-502"><span class="linenos">502</span></a><span class="sd">    ----------</span>
</span><span id="validate_ommers-503"><a href="#validate_ommers-503"><span class="linenos">503</span></a><span class="sd">    ommers :</span>
</span><span id="validate_ommers-504"><a href="#validate_ommers-504"><span class="linenos">504</span></a><span class="sd">        List of ommers mentioned in the current block.</span>
</span><span id="validate_ommers-505"><a href="#validate_ommers-505"><span class="linenos">505</span></a><span class="sd">    block_header:</span>
</span><span id="validate_ommers-506"><a href="#validate_ommers-506"><span class="linenos">506</span></a><span class="sd">        The header of current block.</span>
</span><span id="validate_ommers-507"><a href="#validate_ommers-507"><span class="linenos">507</span></a><span class="sd">    chain :</span>
</span><span id="validate_ommers-508"><a href="#validate_ommers-508"><span class="linenos">508</span></a><span class="sd">        History and current state.</span>
</span><span id="validate_ommers-509"><a href="#validate_ommers-509"><span class="linenos">509</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="validate_ommers-510"><a href="#validate_ommers-510"><span class="linenos">510</span></a>    <span class="n">block_hash</span> <span class="o">=</span> <span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">block_header</span><span class="p">)</span>
</span><span id="validate_ommers-511"><a href="#validate_ommers-511"><span class="linenos">511</span></a>
</span><span id="validate_ommers-512"><a href="#validate_ommers-512"><span class="linenos">512</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">ommers</span><span class="p">)</span> <span class="o">==</span> <span class="n">block_header</span><span class="o">.</span><span class="n">ommers_hash</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_ommers-513"><a href="#validate_ommers-513"><span class="linenos">513</span></a>
</span><span id="validate_ommers-514"><a href="#validate_ommers-514"><span class="linenos">514</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ommers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="validate_ommers-515"><a href="#validate_ommers-515"><span class="linenos">515</span></a>        <span class="c1"># Nothing to validate</span>
</span><span id="validate_ommers-516"><a href="#validate_ommers-516"><span class="linenos">516</span></a>        <span class="k">return</span>
</span><span id="validate_ommers-517"><a href="#validate_ommers-517"><span class="linenos">517</span></a>
</span><span id="validate_ommers-518"><a href="#validate_ommers-518"><span class="linenos">518</span></a>    <span class="c1"># Check that each ommer satisfies the constraints of a header</span>
</span><span id="validate_ommers-519"><a href="#validate_ommers-519"><span class="linenos">519</span></a>    <span class="k">for</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="n">ommers</span><span class="p">:</span>
</span><span id="validate_ommers-520"><a href="#validate_ommers-520"><span class="linenos">520</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">ommer</span><span class="o">.</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">block_header</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_ommers-521"><a href="#validate_ommers-521"><span class="linenos">521</span></a>        <span class="n">ommer_parent_header</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span>
</span><span id="validate_ommers-522"><a href="#validate_ommers-522"><span class="linenos">522</span></a>            <span class="o">-</span><span class="p">(</span><span class="n">block_header</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="n">ommer</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="validate_ommers-523"><a href="#validate_ommers-523"><span class="linenos">523</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">header</span>
</span><span id="validate_ommers-524"><a href="#validate_ommers-524"><span class="linenos">524</span></a>        <span class="n">validate_header</span><span class="p">(</span><span class="n">ommer</span><span class="p">,</span> <span class="n">ommer_parent_header</span><span class="p">)</span>
</span><span id="validate_ommers-525"><a href="#validate_ommers-525"><span class="linenos">525</span></a>
</span><span id="validate_ommers-526"><a href="#validate_ommers-526"><span class="linenos">526</span></a>    <span class="c1"># Check that there can be only at most 2 ommers for a block.</span>
</span><span id="validate_ommers-527"><a href="#validate_ommers-527"><span class="linenos">527</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ommers</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_ommers-528"><a href="#validate_ommers-528"><span class="linenos">528</span></a>
</span><span id="validate_ommers-529"><a href="#validate_ommers-529"><span class="linenos">529</span></a>    <span class="n">ommers_hashes</span> <span class="o">=</span> <span class="p">[</span><span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">ommer</span><span class="p">)</span> <span class="k">for</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="n">ommers</span><span class="p">]</span>
</span><span id="validate_ommers-530"><a href="#validate_ommers-530"><span class="linenos">530</span></a>    <span class="c1"># Check that there are no duplicates in the ommers of current block</span>
</span><span id="validate_ommers-531"><a href="#validate_ommers-531"><span class="linenos">531</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ommers_hashes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ommers_hashes</span><span class="p">)),</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_ommers-532"><a href="#validate_ommers-532"><span class="linenos">532</span></a>
</span><span id="validate_ommers-533"><a href="#validate_ommers-533"><span class="linenos">533</span></a>    <span class="n">recent_canonical_blocks</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">MAX_OMMER_DEPTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:]</span>
</span><span id="validate_ommers-534"><a href="#validate_ommers-534"><span class="linenos">534</span></a>    <span class="n">recent_canonical_block_hashes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="validate_ommers-535"><a href="#validate_ommers-535"><span class="linenos">535</span></a>        <span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">header</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">recent_canonical_blocks</span>
</span><span id="validate_ommers-536"><a href="#validate_ommers-536"><span class="linenos">536</span></a>    <span class="p">}</span>
</span><span id="validate_ommers-537"><a href="#validate_ommers-537"><span class="linenos">537</span></a>    <span class="n">recent_ommers_hashes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Hash32</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="validate_ommers-538"><a href="#validate_ommers-538"><span class="linenos">538</span></a>    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">recent_canonical_blocks</span><span class="p">:</span>
</span><span id="validate_ommers-539"><a href="#validate_ommers-539"><span class="linenos">539</span></a>        <span class="n">recent_ommers_hashes</span> <span class="o">=</span> <span class="n">recent_ommers_hashes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span id="validate_ommers-540"><a href="#validate_ommers-540"><span class="linenos">540</span></a>            <span class="p">{</span><span class="n">rlp</span><span class="o">.</span><span class="n">rlp_hash</span><span class="p">(</span><span class="n">ommer</span><span class="p">)</span> <span class="k">for</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">ommers</span><span class="p">}</span>
</span><span id="validate_ommers-541"><a href="#validate_ommers-541"><span class="linenos">541</span></a>        <span class="p">)</span>
</span><span id="validate_ommers-542"><a href="#validate_ommers-542"><span class="linenos">542</span></a>
</span><span id="validate_ommers-543"><a href="#validate_ommers-543"><span class="linenos">543</span></a>    <span class="k">for</span> <span class="n">ommer_index</span><span class="p">,</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ommers</span><span class="p">):</span>
</span><span id="validate_ommers-544"><a href="#validate_ommers-544"><span class="linenos">544</span></a>        <span class="n">ommer_hash</span> <span class="o">=</span> <span class="n">ommers_hashes</span><span class="p">[</span><span class="n">ommer_index</span><span class="p">]</span>
</span><span id="validate_ommers-545"><a href="#validate_ommers-545"><span class="linenos">545</span></a>        <span class="c1"># The current block shouldn&#39;t be the ommer</span>
</span><span id="validate_ommers-546"><a href="#validate_ommers-546"><span class="linenos">546</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="n">ommer_hash</span> <span class="o">!=</span> <span class="n">block_hash</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_ommers-547"><a href="#validate_ommers-547"><span class="linenos">547</span></a>
</span><span id="validate_ommers-548"><a href="#validate_ommers-548"><span class="linenos">548</span></a>        <span class="c1"># Ommer shouldn&#39;t be one of the recent canonical blocks</span>
</span><span id="validate_ommers-549"><a href="#validate_ommers-549"><span class="linenos">549</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="n">ommer_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recent_canonical_block_hashes</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_ommers-550"><a href="#validate_ommers-550"><span class="linenos">550</span></a>
</span><span id="validate_ommers-551"><a href="#validate_ommers-551"><span class="linenos">551</span></a>        <span class="c1"># Ommer shouldn&#39;t be one of the uncles mentioned in the recent</span>
</span><span id="validate_ommers-552"><a href="#validate_ommers-552"><span class="linenos">552</span></a>        <span class="c1"># canonical blocks</span>
</span><span id="validate_ommers-553"><a href="#validate_ommers-553"><span class="linenos">553</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="n">ommer_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recent_ommers_hashes</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_ommers-554"><a href="#validate_ommers-554"><span class="linenos">554</span></a>
</span><span id="validate_ommers-555"><a href="#validate_ommers-555"><span class="linenos">555</span></a>        <span class="c1"># Ommer age with respect to the current block. For example, an age of</span>
</span><span id="validate_ommers-556"><a href="#validate_ommers-556"><span class="linenos">556</span></a>        <span class="c1"># 1 indicates that the ommer is a sibling of previous block.</span>
</span><span id="validate_ommers-557"><a href="#validate_ommers-557"><span class="linenos">557</span></a>        <span class="n">ommer_age</span> <span class="o">=</span> <span class="n">block_header</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="n">ommer</span><span class="o">.</span><span class="n">number</span>
</span><span id="validate_ommers-558"><a href="#validate_ommers-558"><span class="linenos">558</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">ommer_age</span> <span class="o">&lt;=</span> <span class="n">MAX_OMMER_DEPTH</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="validate_ommers-559"><a href="#validate_ommers-559"><span class="linenos">559</span></a>
</span><span id="validate_ommers-560"><a href="#validate_ommers-560"><span class="linenos">560</span></a>        <span class="n">ensure</span><span class="p">(</span>
</span><span id="validate_ommers-561"><a href="#validate_ommers-561"><span class="linenos">561</span></a>            <span class="n">ommer</span><span class="o">.</span><span class="n">parent_hash</span> <span class="ow">in</span> <span class="n">recent_canonical_block_hashes</span><span class="p">,</span> <span class="n">InvalidBlock</span>
</span><span id="validate_ommers-562"><a href="#validate_ommers-562"><span class="linenos">562</span></a>        <span class="p">)</span>
</span><span id="validate_ommers-563"><a href="#validate_ommers-563"><span class="linenos">563</span></a>        <span class="n">ensure</span><span class="p">(</span><span class="n">ommer</span><span class="o">.</span><span class="n">parent_hash</span> <span class="o">!=</span> <span class="n">block_header</span><span class="o">.</span><span class="n">parent_hash</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Validates the ommers mentioned in the block.</p>

<p>An ommer block is a block that wasn't canonically added to the
blockchain because it wasn't validated as fast as the canonical block
but was mined at the same time.</p>

<p>To be considered valid, the ommers must adhere to the rules defined in
the Ethereum protocol. The maximum amount of ommers is 2 per block and
there cannot be duplicate ommers in a block. Many of the other ommer
constraints are listed in the in-line comments of this function.</p>

<h2 id="parameters">Parameters</h2>

<p>ommers :
    List of ommers mentioned in the current block.
block_header:
    The header of current block.
chain :
    History and current state.</p>
</div>


                </section>
                <section id="pay_rewards">
                            <input id="pay_rewards-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pay_rewards</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">state</span><span class="p">:</span> <span class="n"><a href="state.html#State">ethereum.homestead.state.State</a></span>,</span><span class="param">	<span class="n">block_number</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>,</span><span class="param">	<span class="n">coinbase</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Bytes20">ethereum.base_types.Bytes20</a></span>,</span><span class="param">	<span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span><span class="p">,</span> <span class="o">...</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="pay_rewards-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pay_rewards"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pay_rewards-566"><a href="#pay_rewards-566"><span class="linenos">566</span></a><span class="k">def</span> <span class="nf">pay_rewards</span><span class="p">(</span>
</span><span id="pay_rewards-567"><a href="#pay_rewards-567"><span class="linenos">567</span></a>    <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span>
</span><span id="pay_rewards-568"><a href="#pay_rewards-568"><span class="linenos">568</span></a>    <span class="n">block_number</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="pay_rewards-569"><a href="#pay_rewards-569"><span class="linenos">569</span></a>    <span class="n">coinbase</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span>
</span><span id="pay_rewards-570"><a href="#pay_rewards-570"><span class="linenos">570</span></a>    <span class="n">ommers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Header</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="pay_rewards-571"><a href="#pay_rewards-571"><span class="linenos">571</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="pay_rewards-572"><a href="#pay_rewards-572"><span class="linenos">572</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="pay_rewards-573"><a href="#pay_rewards-573"><span class="linenos">573</span></a><span class="sd">    Pay rewards to the block miner as well as the ommers miners.</span>
</span><span id="pay_rewards-574"><a href="#pay_rewards-574"><span class="linenos">574</span></a>
</span><span id="pay_rewards-575"><a href="#pay_rewards-575"><span class="linenos">575</span></a><span class="sd">    The miner of the canonical block is rewarded with the predetermined</span>
</span><span id="pay_rewards-576"><a href="#pay_rewards-576"><span class="linenos">576</span></a><span class="sd">    block reward, ``BLOCK_REWARD``, plus a variable award based off of the</span>
</span><span id="pay_rewards-577"><a href="#pay_rewards-577"><span class="linenos">577</span></a><span class="sd">    number of ommer blocks that were mined around the same time, and included</span>
</span><span id="pay_rewards-578"><a href="#pay_rewards-578"><span class="linenos">578</span></a><span class="sd">    in the canonical block&#39;s header. An ommer block is a block that wasn&#39;t</span>
</span><span id="pay_rewards-579"><a href="#pay_rewards-579"><span class="linenos">579</span></a><span class="sd">    added to the canonical blockchain because it wasn&#39;t validated as fast as</span>
</span><span id="pay_rewards-580"><a href="#pay_rewards-580"><span class="linenos">580</span></a><span class="sd">    the accepted block but was mined at the same time. Although not all blocks</span>
</span><span id="pay_rewards-581"><a href="#pay_rewards-581"><span class="linenos">581</span></a><span class="sd">    that are mined are added to the canonical chain, miners are still paid a</span>
</span><span id="pay_rewards-582"><a href="#pay_rewards-582"><span class="linenos">582</span></a><span class="sd">    reward for their efforts. This reward is called an ommer reward and is</span>
</span><span id="pay_rewards-583"><a href="#pay_rewards-583"><span class="linenos">583</span></a><span class="sd">    calculated based on the number associated with the ommer block that they</span>
</span><span id="pay_rewards-584"><a href="#pay_rewards-584"><span class="linenos">584</span></a><span class="sd">    mined.</span>
</span><span id="pay_rewards-585"><a href="#pay_rewards-585"><span class="linenos">585</span></a>
</span><span id="pay_rewards-586"><a href="#pay_rewards-586"><span class="linenos">586</span></a><span class="sd">    Parameters</span>
</span><span id="pay_rewards-587"><a href="#pay_rewards-587"><span class="linenos">587</span></a><span class="sd">    ----------</span>
</span><span id="pay_rewards-588"><a href="#pay_rewards-588"><span class="linenos">588</span></a><span class="sd">    state :</span>
</span><span id="pay_rewards-589"><a href="#pay_rewards-589"><span class="linenos">589</span></a><span class="sd">        Current account state.</span>
</span><span id="pay_rewards-590"><a href="#pay_rewards-590"><span class="linenos">590</span></a><span class="sd">    block_number :</span>
</span><span id="pay_rewards-591"><a href="#pay_rewards-591"><span class="linenos">591</span></a><span class="sd">        Position of the block within the chain.</span>
</span><span id="pay_rewards-592"><a href="#pay_rewards-592"><span class="linenos">592</span></a><span class="sd">    coinbase :</span>
</span><span id="pay_rewards-593"><a href="#pay_rewards-593"><span class="linenos">593</span></a><span class="sd">        Address of account which receives block reward and transaction fees.</span>
</span><span id="pay_rewards-594"><a href="#pay_rewards-594"><span class="linenos">594</span></a><span class="sd">    ommers :</span>
</span><span id="pay_rewards-595"><a href="#pay_rewards-595"><span class="linenos">595</span></a><span class="sd">        List of ommers mentioned in the current block.</span>
</span><span id="pay_rewards-596"><a href="#pay_rewards-596"><span class="linenos">596</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="pay_rewards-597"><a href="#pay_rewards-597"><span class="linenos">597</span></a>    <span class="n">miner_reward</span> <span class="o">=</span> <span class="n">BLOCK_REWARD</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ommers</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">BLOCK_REWARD</span> <span class="o">//</span> <span class="mi">32</span><span class="p">))</span>
</span><span id="pay_rewards-598"><a href="#pay_rewards-598"><span class="linenos">598</span></a>    <span class="n">create_ether</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">coinbase</span><span class="p">,</span> <span class="n">miner_reward</span><span class="p">)</span>
</span><span id="pay_rewards-599"><a href="#pay_rewards-599"><span class="linenos">599</span></a>
</span><span id="pay_rewards-600"><a href="#pay_rewards-600"><span class="linenos">600</span></a>    <span class="k">for</span> <span class="n">ommer</span> <span class="ow">in</span> <span class="n">ommers</span><span class="p">:</span>
</span><span id="pay_rewards-601"><a href="#pay_rewards-601"><span class="linenos">601</span></a>        <span class="c1"># Ommer age with respect to the current block.</span>
</span><span id="pay_rewards-602"><a href="#pay_rewards-602"><span class="linenos">602</span></a>        <span class="n">ommer_age</span> <span class="o">=</span> <span class="n">U256</span><span class="p">(</span><span class="n">block_number</span> <span class="o">-</span> <span class="n">ommer</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</span><span id="pay_rewards-603"><a href="#pay_rewards-603"><span class="linenos">603</span></a>        <span class="n">ommer_miner_reward</span> <span class="o">=</span> <span class="p">((</span><span class="mi">8</span> <span class="o">-</span> <span class="n">ommer_age</span><span class="p">)</span> <span class="o">*</span> <span class="n">BLOCK_REWARD</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span>
</span><span id="pay_rewards-604"><a href="#pay_rewards-604"><span class="linenos">604</span></a>        <span class="n">create_ether</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ommer</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span> <span class="n">ommer_miner_reward</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Pay rewards to the block miner as well as the ommers miners.</p>

<p>The miner of the canonical block is rewarded with the predetermined
block reward, <code>BLOCK_REWARD</code>, plus a variable award based off of the
number of ommer blocks that were mined around the same time, and included
in the canonical block's header. An ommer block is a block that wasn't
added to the canonical blockchain because it wasn't validated as fast as
the accepted block but was mined at the same time. Although not all blocks
that are mined are added to the canonical chain, miners are still paid a
reward for their efforts. This reward is called an ommer reward and is
calculated based on the number associated with the ommer block that they
mined.</p>

<h2 id="parameters">Parameters</h2>

<p>state :
    Current account state.
block_number :
    Position of the block within the chain.
coinbase :
    Address of account which receives block reward and transaction fees.
ommers :
    List of ommers mentioned in the current block.</p>
</div>


                </section>
                <section id="process_transaction">
                            <input id="process_transaction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_transaction</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">env</span><span class="p">:</span> <span class="n"><a href="vm.html#Environment">ethereum.homestead.vm.Environment</a></span>,</span><span class="param">	<span class="n">tx</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Transaction">ethereum.homestead.fork_types.Transaction</a></span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n"><a href="fork_types.html#Log">ethereum.homestead.fork_types.Log</a></span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="process_transaction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#process_transaction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="process_transaction-607"><a href="#process_transaction-607"><span class="linenos">607</span></a><span class="k">def</span> <span class="nf">process_transaction</span><span class="p">(</span>
</span><span id="process_transaction-608"><a href="#process_transaction-608"><span class="linenos">608</span></a>    <span class="n">env</span><span class="p">:</span> <span class="n">vm</span><span class="o">.</span><span class="n">Environment</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span>
</span><span id="process_transaction-609"><a href="#process_transaction-609"><span class="linenos">609</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Uint</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Log</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
</span><span id="process_transaction-610"><a href="#process_transaction-610"><span class="linenos">610</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="process_transaction-611"><a href="#process_transaction-611"><span class="linenos">611</span></a><span class="sd">    Execute a transaction against the provided environment.</span>
</span><span id="process_transaction-612"><a href="#process_transaction-612"><span class="linenos">612</span></a>
</span><span id="process_transaction-613"><a href="#process_transaction-613"><span class="linenos">613</span></a><span class="sd">    This function processes the actions needed to execute a transaction.</span>
</span><span id="process_transaction-614"><a href="#process_transaction-614"><span class="linenos">614</span></a><span class="sd">    It decrements the sender&#39;s account after calculating the gas fee and</span>
</span><span id="process_transaction-615"><a href="#process_transaction-615"><span class="linenos">615</span></a><span class="sd">    refunds them the proper amount after execution. Calling contracts,</span>
</span><span id="process_transaction-616"><a href="#process_transaction-616"><span class="linenos">616</span></a><span class="sd">    deploying code, and incrementing nonces are all examples of actions that</span>
</span><span id="process_transaction-617"><a href="#process_transaction-617"><span class="linenos">617</span></a><span class="sd">    happen within this function or from a call made within this function.</span>
</span><span id="process_transaction-618"><a href="#process_transaction-618"><span class="linenos">618</span></a>
</span><span id="process_transaction-619"><a href="#process_transaction-619"><span class="linenos">619</span></a><span class="sd">    Accounts that are marked for deletion are processed and destroyed after</span>
</span><span id="process_transaction-620"><a href="#process_transaction-620"><span class="linenos">620</span></a><span class="sd">    execution.</span>
</span><span id="process_transaction-621"><a href="#process_transaction-621"><span class="linenos">621</span></a>
</span><span id="process_transaction-622"><a href="#process_transaction-622"><span class="linenos">622</span></a><span class="sd">    Parameters</span>
</span><span id="process_transaction-623"><a href="#process_transaction-623"><span class="linenos">623</span></a><span class="sd">    ----------</span>
</span><span id="process_transaction-624"><a href="#process_transaction-624"><span class="linenos">624</span></a><span class="sd">    env :</span>
</span><span id="process_transaction-625"><a href="#process_transaction-625"><span class="linenos">625</span></a><span class="sd">        Environment for the Ethereum Virtual Machine.</span>
</span><span id="process_transaction-626"><a href="#process_transaction-626"><span class="linenos">626</span></a><span class="sd">    tx :</span>
</span><span id="process_transaction-627"><a href="#process_transaction-627"><span class="linenos">627</span></a><span class="sd">        Transaction to execute.</span>
</span><span id="process_transaction-628"><a href="#process_transaction-628"><span class="linenos">628</span></a>
</span><span id="process_transaction-629"><a href="#process_transaction-629"><span class="linenos">629</span></a><span class="sd">    Returns</span>
</span><span id="process_transaction-630"><a href="#process_transaction-630"><span class="linenos">630</span></a><span class="sd">    -------</span>
</span><span id="process_transaction-631"><a href="#process_transaction-631"><span class="linenos">631</span></a><span class="sd">    gas_left : `ethereum.base_types.U256`</span>
</span><span id="process_transaction-632"><a href="#process_transaction-632"><span class="linenos">632</span></a><span class="sd">        Remaining gas after execution.</span>
</span><span id="process_transaction-633"><a href="#process_transaction-633"><span class="linenos">633</span></a><span class="sd">    logs : `Tuple[ethereum.fork_types.Log, ...]`</span>
</span><span id="process_transaction-634"><a href="#process_transaction-634"><span class="linenos">634</span></a><span class="sd">        Logs generated during execution.</span>
</span><span id="process_transaction-635"><a href="#process_transaction-635"><span class="linenos">635</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="process_transaction-636"><a href="#process_transaction-636"><span class="linenos">636</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">validate_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="process_transaction-637"><a href="#process_transaction-637"><span class="linenos">637</span></a>
</span><span id="process_transaction-638"><a href="#process_transaction-638"><span class="linenos">638</span></a>    <span class="n">sender</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">origin</span>
</span><span id="process_transaction-639"><a href="#process_transaction-639"><span class="linenos">639</span></a>    <span class="n">sender_account</span> <span class="o">=</span> <span class="n">get_account</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">)</span>
</span><span id="process_transaction-640"><a href="#process_transaction-640"><span class="linenos">640</span></a>    <span class="n">gas_fee</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">*</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span>
</span><span id="process_transaction-641"><a href="#process_transaction-641"><span class="linenos">641</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">sender_account</span><span class="o">.</span><span class="n">nonce</span> <span class="o">==</span> <span class="n">tx</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="process_transaction-642"><a href="#process_transaction-642"><span class="linenos">642</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">sender_account</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">gas_fee</span> <span class="o">+</span> <span class="n">tx</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="process_transaction-643"><a href="#process_transaction-643"><span class="linenos">643</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">sender_account</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="nb">bytearray</span><span class="p">(),</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="process_transaction-644"><a href="#process_transaction-644"><span class="linenos">644</span></a>
</span><span id="process_transaction-645"><a href="#process_transaction-645"><span class="linenos">645</span></a>    <span class="n">gas</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">-</span> <span class="n">calculate_intrinsic_cost</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
</span><span id="process_transaction-646"><a href="#process_transaction-646"><span class="linenos">646</span></a>    <span class="n">increment_nonce</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">)</span>
</span><span id="process_transaction-647"><a href="#process_transaction-647"><span class="linenos">647</span></a>    <span class="n">sender_balance_after_gas_fee</span> <span class="o">=</span> <span class="n">sender_account</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">gas_fee</span>
</span><span id="process_transaction-648"><a href="#process_transaction-648"><span class="linenos">648</span></a>    <span class="n">set_account_balance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">sender_balance_after_gas_fee</span><span class="p">)</span>
</span><span id="process_transaction-649"><a href="#process_transaction-649"><span class="linenos">649</span></a>
</span><span id="process_transaction-650"><a href="#process_transaction-650"><span class="linenos">650</span></a>    <span class="n">message</span> <span class="o">=</span> <span class="n">prepare_message</span><span class="p">(</span>
</span><span id="process_transaction-651"><a href="#process_transaction-651"><span class="linenos">651</span></a>        <span class="n">sender</span><span class="p">,</span>
</span><span id="process_transaction-652"><a href="#process_transaction-652"><span class="linenos">652</span></a>        <span class="n">tx</span><span class="o">.</span><span class="n">to</span><span class="p">,</span>
</span><span id="process_transaction-653"><a href="#process_transaction-653"><span class="linenos">653</span></a>        <span class="n">tx</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
</span><span id="process_transaction-654"><a href="#process_transaction-654"><span class="linenos">654</span></a>        <span class="n">tx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="process_transaction-655"><a href="#process_transaction-655"><span class="linenos">655</span></a>        <span class="n">gas</span><span class="p">,</span>
</span><span id="process_transaction-656"><a href="#process_transaction-656"><span class="linenos">656</span></a>        <span class="n">env</span><span class="p">,</span>
</span><span id="process_transaction-657"><a href="#process_transaction-657"><span class="linenos">657</span></a>    <span class="p">)</span>
</span><span id="process_transaction-658"><a href="#process_transaction-658"><span class="linenos">658</span></a>
</span><span id="process_transaction-659"><a href="#process_transaction-659"><span class="linenos">659</span></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">process_message_call</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span><span id="process_transaction-660"><a href="#process_transaction-660"><span class="linenos">660</span></a>
</span><span id="process_transaction-661"><a href="#process_transaction-661"><span class="linenos">661</span></a>    <span class="n">gas_used</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">-</span> <span class="n">output</span><span class="o">.</span><span class="n">gas_left</span>
</span><span id="process_transaction-662"><a href="#process_transaction-662"><span class="linenos">662</span></a>    <span class="n">gas_refund</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gas_used</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">refund_counter</span><span class="p">)</span>
</span><span id="process_transaction-663"><a href="#process_transaction-663"><span class="linenos">663</span></a>    <span class="n">gas_refund_amount</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">gas_left</span> <span class="o">+</span> <span class="n">gas_refund</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span>
</span><span id="process_transaction-664"><a href="#process_transaction-664"><span class="linenos">664</span></a>    <span class="n">transaction_fee</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="o">-</span> <span class="n">output</span><span class="o">.</span><span class="n">gas_left</span> <span class="o">-</span> <span class="n">gas_refund</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span>
</span><span id="process_transaction-665"><a href="#process_transaction-665"><span class="linenos">665</span></a>    <span class="n">total_gas_used</span> <span class="o">=</span> <span class="n">gas_used</span> <span class="o">-</span> <span class="n">gas_refund</span>
</span><span id="process_transaction-666"><a href="#process_transaction-666"><span class="linenos">666</span></a>
</span><span id="process_transaction-667"><a href="#process_transaction-667"><span class="linenos">667</span></a>    <span class="c1"># refund gas</span>
</span><span id="process_transaction-668"><a href="#process_transaction-668"><span class="linenos">668</span></a>    <span class="n">sender_balance_after_refund</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="process_transaction-669"><a href="#process_transaction-669"><span class="linenos">669</span></a>        <span class="n">get_account</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">)</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">gas_refund_amount</span>
</span><span id="process_transaction-670"><a href="#process_transaction-670"><span class="linenos">670</span></a>    <span class="p">)</span>
</span><span id="process_transaction-671"><a href="#process_transaction-671"><span class="linenos">671</span></a>    <span class="n">set_account_balance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">sender_balance_after_refund</span><span class="p">)</span>
</span><span id="process_transaction-672"><a href="#process_transaction-672"><span class="linenos">672</span></a>
</span><span id="process_transaction-673"><a href="#process_transaction-673"><span class="linenos">673</span></a>    <span class="c1"># transfer miner fees</span>
</span><span id="process_transaction-674"><a href="#process_transaction-674"><span class="linenos">674</span></a>    <span class="n">coinbase_balance_after_mining_fee</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="process_transaction-675"><a href="#process_transaction-675"><span class="linenos">675</span></a>        <span class="n">get_account</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">coinbase</span><span class="p">)</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">transaction_fee</span>
</span><span id="process_transaction-676"><a href="#process_transaction-676"><span class="linenos">676</span></a>    <span class="p">)</span>
</span><span id="process_transaction-677"><a href="#process_transaction-677"><span class="linenos">677</span></a>    <span class="n">set_account_balance</span><span class="p">(</span>
</span><span id="process_transaction-678"><a href="#process_transaction-678"><span class="linenos">678</span></a>        <span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span> <span class="n">coinbase_balance_after_mining_fee</span>
</span><span id="process_transaction-679"><a href="#process_transaction-679"><span class="linenos">679</span></a>    <span class="p">)</span>
</span><span id="process_transaction-680"><a href="#process_transaction-680"><span class="linenos">680</span></a>
</span><span id="process_transaction-681"><a href="#process_transaction-681"><span class="linenos">681</span></a>    <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">accounts_to_delete</span><span class="p">:</span>
</span><span id="process_transaction-682"><a href="#process_transaction-682"><span class="linenos">682</span></a>        <span class="n">destroy_account</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
</span><span id="process_transaction-683"><a href="#process_transaction-683"><span class="linenos">683</span></a>
</span><span id="process_transaction-684"><a href="#process_transaction-684"><span class="linenos">684</span></a>    <span class="k">return</span> <span class="n">total_gas_used</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">logs</span>
</span></pre></div>


            <div class="docstring"><p>Execute a transaction against the provided environment.</p>

<p>This function processes the actions needed to execute a transaction.
It decrements the sender's account after calculating the gas fee and
refunds them the proper amount after execution. Calling contracts,
deploying code, and incrementing nonces are all examples of actions that
happen within this function or from a call made within this function.</p>

<p>Accounts that are marked for deletion are processed and destroyed after
execution.</p>

<h2 id="parameters">Parameters</h2>

<p>env :
    Environment for the Ethereum Virtual Machine.
tx :
    Transaction to execute.</p>

<h2 id="returns">Returns</h2>

<p>gas_left : <code><a href="../base_types.html#U256">ethereum.base_types.U256</a></code>
    Remaining gas after execution.
logs : <code>Tuple[ethereum.fork_types.Log, ...]</code>
    Logs generated during execution.</p>
</div>


                </section>
                <section id="validate_transaction">
                            <input id="validate_transaction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validate_transaction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">tx</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Transaction">ethereum.homestead.fork_types.Transaction</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="validate_transaction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#validate_transaction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="validate_transaction-687"><a href="#validate_transaction-687"><span class="linenos">687</span></a><span class="k">def</span> <span class="nf">validate_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="validate_transaction-688"><a href="#validate_transaction-688"><span class="linenos">688</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="validate_transaction-689"><a href="#validate_transaction-689"><span class="linenos">689</span></a><span class="sd">    Verifies a transaction.</span>
</span><span id="validate_transaction-690"><a href="#validate_transaction-690"><span class="linenos">690</span></a>
</span><span id="validate_transaction-691"><a href="#validate_transaction-691"><span class="linenos">691</span></a><span class="sd">    The gas in a transaction gets used to pay for the intrinsic cost of</span>
</span><span id="validate_transaction-692"><a href="#validate_transaction-692"><span class="linenos">692</span></a><span class="sd">    operations, therefore if there is insufficient gas then it would not</span>
</span><span id="validate_transaction-693"><a href="#validate_transaction-693"><span class="linenos">693</span></a><span class="sd">    be possible to execute a transaction and it will be declared invalid.</span>
</span><span id="validate_transaction-694"><a href="#validate_transaction-694"><span class="linenos">694</span></a>
</span><span id="validate_transaction-695"><a href="#validate_transaction-695"><span class="linenos">695</span></a><span class="sd">    Additionally, the nonce of a transaction must not equal or exceed the</span>
</span><span id="validate_transaction-696"><a href="#validate_transaction-696"><span class="linenos">696</span></a><span class="sd">    limit defined in `EIP-2681 &lt;https://eips.ethereum.org/EIPS/eip-2681&gt;`_.</span>
</span><span id="validate_transaction-697"><a href="#validate_transaction-697"><span class="linenos">697</span></a><span class="sd">    In practice, defining the limit as ``2**64-1`` has no impact because</span>
</span><span id="validate_transaction-698"><a href="#validate_transaction-698"><span class="linenos">698</span></a><span class="sd">    sending ``2**64-1`` transactions is improbable. It&#39;s not strictly</span>
</span><span id="validate_transaction-699"><a href="#validate_transaction-699"><span class="linenos">699</span></a><span class="sd">    impossible though, ``2**64-1`` transactions is the entire capacity of the</span>
</span><span id="validate_transaction-700"><a href="#validate_transaction-700"><span class="linenos">700</span></a><span class="sd">    Ethereum blockchain at 2022 gas limits for a little over 22 years.</span>
</span><span id="validate_transaction-701"><a href="#validate_transaction-701"><span class="linenos">701</span></a>
</span><span id="validate_transaction-702"><a href="#validate_transaction-702"><span class="linenos">702</span></a><span class="sd">    Parameters</span>
</span><span id="validate_transaction-703"><a href="#validate_transaction-703"><span class="linenos">703</span></a><span class="sd">    ----------</span>
</span><span id="validate_transaction-704"><a href="#validate_transaction-704"><span class="linenos">704</span></a><span class="sd">    tx :</span>
</span><span id="validate_transaction-705"><a href="#validate_transaction-705"><span class="linenos">705</span></a><span class="sd">        Transaction to validate.</span>
</span><span id="validate_transaction-706"><a href="#validate_transaction-706"><span class="linenos">706</span></a>
</span><span id="validate_transaction-707"><a href="#validate_transaction-707"><span class="linenos">707</span></a><span class="sd">    Returns</span>
</span><span id="validate_transaction-708"><a href="#validate_transaction-708"><span class="linenos">708</span></a><span class="sd">    -------</span>
</span><span id="validate_transaction-709"><a href="#validate_transaction-709"><span class="linenos">709</span></a><span class="sd">    verified : `bool`</span>
</span><span id="validate_transaction-710"><a href="#validate_transaction-710"><span class="linenos">710</span></a><span class="sd">        True if the transaction can be executed, or False otherwise.</span>
</span><span id="validate_transaction-711"><a href="#validate_transaction-711"><span class="linenos">711</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="validate_transaction-712"><a href="#validate_transaction-712"><span class="linenos">712</span></a>    <span class="k">return</span> <span class="n">calculate_intrinsic_cost</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tx</span><span class="o">.</span><span class="n">gas</span> <span class="ow">and</span> <span class="n">tx</span><span class="o">.</span><span class="n">nonce</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Verifies a transaction.</p>

<p>The gas in a transaction gets used to pay for the intrinsic cost of
operations, therefore if there is insufficient gas then it would not
be possible to execute a transaction and it will be declared invalid.</p>

<p>Additionally, the nonce of a transaction must not equal or exceed the
limit defined in <code>EIP-2681 &lt;https://eips.ethereum.org/EIPS/eip-2681&gt;</code>_.
In practice, defining the limit as <code>2**64-1</code> has no impact because
sending <code>2**64-1</code> transactions is improbable. It's not strictly
impossible though, <code>2**64-1</code> transactions is the entire capacity of the
Ethereum blockchain at 2022 gas limits for a little over 22 years.</p>

<h2 id="parameters">Parameters</h2>

<p>tx :
    Transaction to validate.</p>

<h2 id="returns">Returns</h2>

<p>verified : <code>bool</code>
    True if the transaction can be executed, or False otherwise.</p>
</div>


                </section>
                <section id="calculate_intrinsic_cost">
                            <input id="calculate_intrinsic_cost-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_intrinsic_cost</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tx</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Transaction">ethereum.homestead.fork_types.Transaction</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>:</span></span>

                <label class="view-source-button" for="calculate_intrinsic_cost-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#calculate_intrinsic_cost"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="calculate_intrinsic_cost-715"><a href="#calculate_intrinsic_cost-715"><span class="linenos">715</span></a><span class="k">def</span> <span class="nf">calculate_intrinsic_cost</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Uint</span><span class="p">:</span>
</span><span id="calculate_intrinsic_cost-716"><a href="#calculate_intrinsic_cost-716"><span class="linenos">716</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="calculate_intrinsic_cost-717"><a href="#calculate_intrinsic_cost-717"><span class="linenos">717</span></a><span class="sd">    Calculates the gas that is charged before execution is started.</span>
</span><span id="calculate_intrinsic_cost-718"><a href="#calculate_intrinsic_cost-718"><span class="linenos">718</span></a>
</span><span id="calculate_intrinsic_cost-719"><a href="#calculate_intrinsic_cost-719"><span class="linenos">719</span></a><span class="sd">    The intrinsic cost of the transaction is charged before execution has</span>
</span><span id="calculate_intrinsic_cost-720"><a href="#calculate_intrinsic_cost-720"><span class="linenos">720</span></a><span class="sd">    begun. Functions/operations in the EVM cost money to execute so this</span>
</span><span id="calculate_intrinsic_cost-721"><a href="#calculate_intrinsic_cost-721"><span class="linenos">721</span></a><span class="sd">    intrinsic cost is for the operations that need to be paid for as part of</span>
</span><span id="calculate_intrinsic_cost-722"><a href="#calculate_intrinsic_cost-722"><span class="linenos">722</span></a><span class="sd">    the transaction. Data transfer, for example, is part of this intrinsic</span>
</span><span id="calculate_intrinsic_cost-723"><a href="#calculate_intrinsic_cost-723"><span class="linenos">723</span></a><span class="sd">    cost. It costs ether to send data over the wire and that ether is</span>
</span><span id="calculate_intrinsic_cost-724"><a href="#calculate_intrinsic_cost-724"><span class="linenos">724</span></a><span class="sd">    accounted for in the intrinsic cost calculated in this function. This</span>
</span><span id="calculate_intrinsic_cost-725"><a href="#calculate_intrinsic_cost-725"><span class="linenos">725</span></a><span class="sd">    intrinsic cost must be calculated and paid for before execution in order</span>
</span><span id="calculate_intrinsic_cost-726"><a href="#calculate_intrinsic_cost-726"><span class="linenos">726</span></a><span class="sd">    for all operations to be implemented.</span>
</span><span id="calculate_intrinsic_cost-727"><a href="#calculate_intrinsic_cost-727"><span class="linenos">727</span></a>
</span><span id="calculate_intrinsic_cost-728"><a href="#calculate_intrinsic_cost-728"><span class="linenos">728</span></a><span class="sd">    Parameters</span>
</span><span id="calculate_intrinsic_cost-729"><a href="#calculate_intrinsic_cost-729"><span class="linenos">729</span></a><span class="sd">    ----------</span>
</span><span id="calculate_intrinsic_cost-730"><a href="#calculate_intrinsic_cost-730"><span class="linenos">730</span></a><span class="sd">    tx :</span>
</span><span id="calculate_intrinsic_cost-731"><a href="#calculate_intrinsic_cost-731"><span class="linenos">731</span></a><span class="sd">        Transaction to compute the intrinsic cost of.</span>
</span><span id="calculate_intrinsic_cost-732"><a href="#calculate_intrinsic_cost-732"><span class="linenos">732</span></a>
</span><span id="calculate_intrinsic_cost-733"><a href="#calculate_intrinsic_cost-733"><span class="linenos">733</span></a><span class="sd">    Returns</span>
</span><span id="calculate_intrinsic_cost-734"><a href="#calculate_intrinsic_cost-734"><span class="linenos">734</span></a><span class="sd">    -------</span>
</span><span id="calculate_intrinsic_cost-735"><a href="#calculate_intrinsic_cost-735"><span class="linenos">735</span></a><span class="sd">    verified : `ethereum.base_types.Uint`</span>
</span><span id="calculate_intrinsic_cost-736"><a href="#calculate_intrinsic_cost-736"><span class="linenos">736</span></a><span class="sd">        The intrinsic cost of the transaction.</span>
</span><span id="calculate_intrinsic_cost-737"><a href="#calculate_intrinsic_cost-737"><span class="linenos">737</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="calculate_intrinsic_cost-738"><a href="#calculate_intrinsic_cost-738"><span class="linenos">738</span></a>    <span class="n">data_cost</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="calculate_intrinsic_cost-739"><a href="#calculate_intrinsic_cost-739"><span class="linenos">739</span></a>
</span><span id="calculate_intrinsic_cost-740"><a href="#calculate_intrinsic_cost-740"><span class="linenos">740</span></a>    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">tx</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span><span id="calculate_intrinsic_cost-741"><a href="#calculate_intrinsic_cost-741"><span class="linenos">741</span></a>        <span class="k">if</span> <span class="n">byte</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="calculate_intrinsic_cost-742"><a href="#calculate_intrinsic_cost-742"><span class="linenos">742</span></a>            <span class="n">data_cost</span> <span class="o">+=</span> <span class="n">TX_DATA_COST_PER_ZERO</span>
</span><span id="calculate_intrinsic_cost-743"><a href="#calculate_intrinsic_cost-743"><span class="linenos">743</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="calculate_intrinsic_cost-744"><a href="#calculate_intrinsic_cost-744"><span class="linenos">744</span></a>            <span class="n">data_cost</span> <span class="o">+=</span> <span class="n">TX_DATA_COST_PER_NON_ZERO</span>
</span><span id="calculate_intrinsic_cost-745"><a href="#calculate_intrinsic_cost-745"><span class="linenos">745</span></a>
</span><span id="calculate_intrinsic_cost-746"><a href="#calculate_intrinsic_cost-746"><span class="linenos">746</span></a>    <span class="k">if</span> <span class="n">tx</span><span class="o">.</span><span class="n">to</span> <span class="o">==</span> <span class="n">Bytes0</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="calculate_intrinsic_cost-747"><a href="#calculate_intrinsic_cost-747"><span class="linenos">747</span></a>        <span class="n">create_cost</span> <span class="o">=</span> <span class="n">TX_CREATE_COST</span>
</span><span id="calculate_intrinsic_cost-748"><a href="#calculate_intrinsic_cost-748"><span class="linenos">748</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="calculate_intrinsic_cost-749"><a href="#calculate_intrinsic_cost-749"><span class="linenos">749</span></a>        <span class="n">create_cost</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="calculate_intrinsic_cost-750"><a href="#calculate_intrinsic_cost-750"><span class="linenos">750</span></a>
</span><span id="calculate_intrinsic_cost-751"><a href="#calculate_intrinsic_cost-751"><span class="linenos">751</span></a>    <span class="k">return</span> <span class="n">Uint</span><span class="p">(</span><span class="n">TX_BASE_COST</span> <span class="o">+</span> <span class="n">data_cost</span> <span class="o">+</span> <span class="n">create_cost</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Calculates the gas that is charged before execution is started.</p>

<p>The intrinsic cost of the transaction is charged before execution has
begun. Functions/operations in the EVM cost money to execute so this
intrinsic cost is for the operations that need to be paid for as part of
the transaction. Data transfer, for example, is part of this intrinsic
cost. It costs ether to send data over the wire and that ether is
accounted for in the intrinsic cost calculated in this function. This
intrinsic cost must be calculated and paid for before execution in order
for all operations to be implemented.</p>

<h2 id="parameters">Parameters</h2>

<p>tx :
    Transaction to compute the intrinsic cost of.</p>

<h2 id="returns">Returns</h2>

<p>verified : <code><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></code>
    The intrinsic cost of the transaction.</p>
</div>


                </section>
                <section id="recover_sender">
                            <input id="recover_sender-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">recover_sender</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tx</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Transaction">ethereum.homestead.fork_types.Transaction</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../base_types.html#Bytes20">ethereum.base_types.Bytes20</a></span>:</span></span>

                <label class="view-source-button" for="recover_sender-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#recover_sender"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="recover_sender-754"><a href="#recover_sender-754"><span class="linenos">754</span></a><span class="k">def</span> <span class="nf">recover_sender</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Address</span><span class="p">:</span>
</span><span id="recover_sender-755"><a href="#recover_sender-755"><span class="linenos">755</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="recover_sender-756"><a href="#recover_sender-756"><span class="linenos">756</span></a><span class="sd">    Extracts the sender address from a transaction.</span>
</span><span id="recover_sender-757"><a href="#recover_sender-757"><span class="linenos">757</span></a>
</span><span id="recover_sender-758"><a href="#recover_sender-758"><span class="linenos">758</span></a><span class="sd">    The v, r, and s values are the three parts that make up the signature</span>
</span><span id="recover_sender-759"><a href="#recover_sender-759"><span class="linenos">759</span></a><span class="sd">    of a transaction. In order to recover the sender of a transaction the two</span>
</span><span id="recover_sender-760"><a href="#recover_sender-760"><span class="linenos">760</span></a><span class="sd">    components needed are the signature (``v``, ``r``, and ``s``) and the</span>
</span><span id="recover_sender-761"><a href="#recover_sender-761"><span class="linenos">761</span></a><span class="sd">    signing hash of the transaction. The sender&#39;s public key can be obtained</span>
</span><span id="recover_sender-762"><a href="#recover_sender-762"><span class="linenos">762</span></a><span class="sd">    with these two values and therefore the sender address can be retrieved.</span>
</span><span id="recover_sender-763"><a href="#recover_sender-763"><span class="linenos">763</span></a>
</span><span id="recover_sender-764"><a href="#recover_sender-764"><span class="linenos">764</span></a><span class="sd">    Parameters</span>
</span><span id="recover_sender-765"><a href="#recover_sender-765"><span class="linenos">765</span></a><span class="sd">    ----------</span>
</span><span id="recover_sender-766"><a href="#recover_sender-766"><span class="linenos">766</span></a><span class="sd">    tx :</span>
</span><span id="recover_sender-767"><a href="#recover_sender-767"><span class="linenos">767</span></a><span class="sd">        Transaction of interest.</span>
</span><span id="recover_sender-768"><a href="#recover_sender-768"><span class="linenos">768</span></a>
</span><span id="recover_sender-769"><a href="#recover_sender-769"><span class="linenos">769</span></a><span class="sd">    Returns</span>
</span><span id="recover_sender-770"><a href="#recover_sender-770"><span class="linenos">770</span></a><span class="sd">    -------</span>
</span><span id="recover_sender-771"><a href="#recover_sender-771"><span class="linenos">771</span></a><span class="sd">    sender : `ethereum.fork_types.Address`</span>
</span><span id="recover_sender-772"><a href="#recover_sender-772"><span class="linenos">772</span></a><span class="sd">        The address of the account that signed the transaction.</span>
</span><span id="recover_sender-773"><a href="#recover_sender-773"><span class="linenos">773</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="recover_sender-774"><a href="#recover_sender-774"><span class="linenos">774</span></a>    <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">s</span>
</span><span id="recover_sender-775"><a href="#recover_sender-775"><span class="linenos">775</span></a>
</span><span id="recover_sender-776"><a href="#recover_sender-776"><span class="linenos">776</span></a>    <span class="c1">#  if v &gt; 28:</span>
</span><span id="recover_sender-777"><a href="#recover_sender-777"><span class="linenos">777</span></a>    <span class="c1">#      v = v - (chain_id*2+8)</span>
</span><span id="recover_sender-778"><a href="#recover_sender-778"><span class="linenos">778</span></a>
</span><span id="recover_sender-779"><a href="#recover_sender-779"><span class="linenos">779</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">27</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">28</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="recover_sender-780"><a href="#recover_sender-780"><span class="linenos">780</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">SECP256K1N</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="recover_sender-781"><a href="#recover_sender-781"><span class="linenos">781</span></a>    <span class="n">ensure</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">SECP256K1N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">InvalidBlock</span><span class="p">)</span>
</span><span id="recover_sender-782"><a href="#recover_sender-782"><span class="linenos">782</span></a>
</span><span id="recover_sender-783"><a href="#recover_sender-783"><span class="linenos">783</span></a>    <span class="n">public_key</span> <span class="o">=</span> <span class="n">secp256k1_recover</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">27</span><span class="p">,</span> <span class="n">signing_hash</span><span class="p">(</span><span class="n">tx</span><span class="p">))</span>
</span><span id="recover_sender-784"><a href="#recover_sender-784"><span class="linenos">784</span></a>    <span class="k">return</span> <span class="n">Address</span><span class="p">(</span><span class="n">keccak256</span><span class="p">(</span><span class="n">public_key</span><span class="p">)[</span><span class="mi">12</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Extracts the sender address from a transaction.</p>

<p>The v, r, and s values are the three parts that make up the signature
of a transaction. In order to recover the sender of a transaction the two
components needed are the signature (<code>v</code>, <code>r</code>, and <code>s</code>) and the
signing hash of the transaction. The sender's public key can be obtained
with these two values and therefore the sender address can be retrieved.</p>

<h2 id="parameters">Parameters</h2>

<p>tx :
    Transaction of interest.</p>

<h2 id="returns">Returns</h2>

<p>sender : <code>ethereum.fork_types.Address</code>
    The address of the account that signed the transaction.</p>
</div>


                </section>
                <section id="signing_hash">
                            <input id="signing_hash-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">signing_hash</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tx</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Transaction">ethereum.homestead.fork_types.Transaction</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../base_types.html#Bytes32">ethereum.base_types.Bytes32</a></span>:</span></span>

                <label class="view-source-button" for="signing_hash-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#signing_hash"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="signing_hash-787"><a href="#signing_hash-787"><span class="linenos">787</span></a><span class="k">def</span> <span class="nf">signing_hash</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash32</span><span class="p">:</span>
</span><span id="signing_hash-788"><a href="#signing_hash-788"><span class="linenos">788</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="signing_hash-789"><a href="#signing_hash-789"><span class="linenos">789</span></a><span class="sd">    Compute the hash of a transaction used in the signature.</span>
</span><span id="signing_hash-790"><a href="#signing_hash-790"><span class="linenos">790</span></a>
</span><span id="signing_hash-791"><a href="#signing_hash-791"><span class="linenos">791</span></a><span class="sd">    The values that are used to compute the signing hash set the rules for a</span>
</span><span id="signing_hash-792"><a href="#signing_hash-792"><span class="linenos">792</span></a><span class="sd">    transaction. For example, signing over the gas sets a limit for the</span>
</span><span id="signing_hash-793"><a href="#signing_hash-793"><span class="linenos">793</span></a><span class="sd">    amount of money that is allowed to be pulled out of the sender&#39;s account.</span>
</span><span id="signing_hash-794"><a href="#signing_hash-794"><span class="linenos">794</span></a>
</span><span id="signing_hash-795"><a href="#signing_hash-795"><span class="linenos">795</span></a><span class="sd">    Parameters</span>
</span><span id="signing_hash-796"><a href="#signing_hash-796"><span class="linenos">796</span></a><span class="sd">    ----------</span>
</span><span id="signing_hash-797"><a href="#signing_hash-797"><span class="linenos">797</span></a><span class="sd">    tx :</span>
</span><span id="signing_hash-798"><a href="#signing_hash-798"><span class="linenos">798</span></a><span class="sd">        Transaction of interest.</span>
</span><span id="signing_hash-799"><a href="#signing_hash-799"><span class="linenos">799</span></a>
</span><span id="signing_hash-800"><a href="#signing_hash-800"><span class="linenos">800</span></a><span class="sd">    Returns</span>
</span><span id="signing_hash-801"><a href="#signing_hash-801"><span class="linenos">801</span></a><span class="sd">    -------</span>
</span><span id="signing_hash-802"><a href="#signing_hash-802"><span class="linenos">802</span></a><span class="sd">    hash : `ethereum.crypto.hash.Hash32`</span>
</span><span id="signing_hash-803"><a href="#signing_hash-803"><span class="linenos">803</span></a><span class="sd">        Hash of the transaction.</span>
</span><span id="signing_hash-804"><a href="#signing_hash-804"><span class="linenos">804</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="signing_hash-805"><a href="#signing_hash-805"><span class="linenos">805</span></a>    <span class="k">return</span> <span class="n">keccak256</span><span class="p">(</span>
</span><span id="signing_hash-806"><a href="#signing_hash-806"><span class="linenos">806</span></a>        <span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="signing_hash-807"><a href="#signing_hash-807"><span class="linenos">807</span></a>            <span class="p">(</span>
</span><span id="signing_hash-808"><a href="#signing_hash-808"><span class="linenos">808</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span>
</span><span id="signing_hash-809"><a href="#signing_hash-809"><span class="linenos">809</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span><span id="signing_hash-810"><a href="#signing_hash-810"><span class="linenos">810</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span>
</span><span id="signing_hash-811"><a href="#signing_hash-811"><span class="linenos">811</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">to</span><span class="p">,</span>
</span><span id="signing_hash-812"><a href="#signing_hash-812"><span class="linenos">812</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
</span><span id="signing_hash-813"><a href="#signing_hash-813"><span class="linenos">813</span></a>                <span class="n">tx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="signing_hash-814"><a href="#signing_hash-814"><span class="linenos">814</span></a>            <span class="p">)</span>
</span><span id="signing_hash-815"><a href="#signing_hash-815"><span class="linenos">815</span></a>        <span class="p">)</span>
</span><span id="signing_hash-816"><a href="#signing_hash-816"><span class="linenos">816</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the hash of a transaction used in the signature.</p>

<p>The values that are used to compute the signing hash set the rules for a
transaction. For example, signing over the gas sets a limit for the
amount of money that is allowed to be pulled out of the sender's account.</p>

<h2 id="parameters">Parameters</h2>

<p>tx :
    Transaction of interest.</p>

<h2 id="returns">Returns</h2>

<p>hash : <code>ethereum.crypto.hash.Hash32</code>
    Hash of the transaction.</p>
</div>


                </section>
                <section id="compute_header_hash">
                            <input id="compute_header_hash-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_header_hash</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">header</span><span class="p">:</span> <span class="n"><a href="fork_types.html#Header">ethereum.homestead.fork_types.Header</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../base_types.html#Bytes32">ethereum.base_types.Bytes32</a></span>:</span></span>

                <label class="view-source-button" for="compute_header_hash-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_header_hash"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_header_hash-819"><a href="#compute_header_hash-819"><span class="linenos">819</span></a><span class="k">def</span> <span class="nf">compute_header_hash</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hash32</span><span class="p">:</span>
</span><span id="compute_header_hash-820"><a href="#compute_header_hash-820"><span class="linenos">820</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_header_hash-821"><a href="#compute_header_hash-821"><span class="linenos">821</span></a><span class="sd">    Computes the hash of a block header.</span>
</span><span id="compute_header_hash-822"><a href="#compute_header_hash-822"><span class="linenos">822</span></a>
</span><span id="compute_header_hash-823"><a href="#compute_header_hash-823"><span class="linenos">823</span></a><span class="sd">    The header hash of a block is the canonical hash that is used to refer</span>
</span><span id="compute_header_hash-824"><a href="#compute_header_hash-824"><span class="linenos">824</span></a><span class="sd">    to a specific block and completely distinguishes a block from another.</span>
</span><span id="compute_header_hash-825"><a href="#compute_header_hash-825"><span class="linenos">825</span></a>
</span><span id="compute_header_hash-826"><a href="#compute_header_hash-826"><span class="linenos">826</span></a><span class="sd">    ``keccak256`` is a function that produces a 256 bit hash of any input.</span>
</span><span id="compute_header_hash-827"><a href="#compute_header_hash-827"><span class="linenos">827</span></a><span class="sd">    It also takes in any number of bytes as an input and produces a single</span>
</span><span id="compute_header_hash-828"><a href="#compute_header_hash-828"><span class="linenos">828</span></a><span class="sd">    hash for them. A hash is a completely unique output for a single input.</span>
</span><span id="compute_header_hash-829"><a href="#compute_header_hash-829"><span class="linenos">829</span></a><span class="sd">    So an input corresponds to one unique hash that can be used to identify</span>
</span><span id="compute_header_hash-830"><a href="#compute_header_hash-830"><span class="linenos">830</span></a><span class="sd">    the input exactly.</span>
</span><span id="compute_header_hash-831"><a href="#compute_header_hash-831"><span class="linenos">831</span></a>
</span><span id="compute_header_hash-832"><a href="#compute_header_hash-832"><span class="linenos">832</span></a><span class="sd">    Prior to using the ``keccak256`` hash function, the header must be</span>
</span><span id="compute_header_hash-833"><a href="#compute_header_hash-833"><span class="linenos">833</span></a><span class="sd">    encoded using the Recursive-Length Prefix. See :ref:`rlp`.</span>
</span><span id="compute_header_hash-834"><a href="#compute_header_hash-834"><span class="linenos">834</span></a><span class="sd">    RLP encoding the header converts it into a space-efficient format that</span>
</span><span id="compute_header_hash-835"><a href="#compute_header_hash-835"><span class="linenos">835</span></a><span class="sd">    allows for easy transfer of data between nodes. The purpose of RLP is to</span>
</span><span id="compute_header_hash-836"><a href="#compute_header_hash-836"><span class="linenos">836</span></a><span class="sd">    encode arbitrarily nested arrays of binary data, and RLP is the primary</span>
</span><span id="compute_header_hash-837"><a href="#compute_header_hash-837"><span class="linenos">837</span></a><span class="sd">    encoding method used to serialize objects in Ethereum&#39;s execution layer.</span>
</span><span id="compute_header_hash-838"><a href="#compute_header_hash-838"><span class="linenos">838</span></a><span class="sd">    The only purpose of RLP is to encode structure; encoding specific data</span>
</span><span id="compute_header_hash-839"><a href="#compute_header_hash-839"><span class="linenos">839</span></a><span class="sd">    types (e.g. strings, floats) is left up to higher-order protocols.</span>
</span><span id="compute_header_hash-840"><a href="#compute_header_hash-840"><span class="linenos">840</span></a>
</span><span id="compute_header_hash-841"><a href="#compute_header_hash-841"><span class="linenos">841</span></a><span class="sd">    Parameters</span>
</span><span id="compute_header_hash-842"><a href="#compute_header_hash-842"><span class="linenos">842</span></a><span class="sd">    ----------</span>
</span><span id="compute_header_hash-843"><a href="#compute_header_hash-843"><span class="linenos">843</span></a><span class="sd">    header :</span>
</span><span id="compute_header_hash-844"><a href="#compute_header_hash-844"><span class="linenos">844</span></a><span class="sd">        Header of interest.</span>
</span><span id="compute_header_hash-845"><a href="#compute_header_hash-845"><span class="linenos">845</span></a>
</span><span id="compute_header_hash-846"><a href="#compute_header_hash-846"><span class="linenos">846</span></a><span class="sd">    Returns</span>
</span><span id="compute_header_hash-847"><a href="#compute_header_hash-847"><span class="linenos">847</span></a><span class="sd">    -------</span>
</span><span id="compute_header_hash-848"><a href="#compute_header_hash-848"><span class="linenos">848</span></a><span class="sd">    hash : `ethereum.crypto.hash.Hash32`</span>
</span><span id="compute_header_hash-849"><a href="#compute_header_hash-849"><span class="linenos">849</span></a><span class="sd">        Hash of the header.</span>
</span><span id="compute_header_hash-850"><a href="#compute_header_hash-850"><span class="linenos">850</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_header_hash-851"><a href="#compute_header_hash-851"><span class="linenos">851</span></a>    <span class="k">return</span> <span class="n">keccak256</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Computes the hash of a block header.</p>

<p>The header hash of a block is the canonical hash that is used to refer
to a specific block and completely distinguishes a block from another.</p>

<p><code>keccak256</code> is a function that produces a 256 bit hash of any input.
It also takes in any number of bytes as an input and produces a single
hash for them. A hash is a completely unique output for a single input.
So an input corresponds to one unique hash that can be used to identify
the input exactly.</p>

<p>Prior to using the <code>keccak256</code> hash function, the header must be
encoded using the Recursive-Length Prefix. See :ref:<code>rlp</code>.
RLP encoding the header converts it into a space-efficient format that
allows for easy transfer of data between nodes. The purpose of RLP is to
encode arbitrarily nested arrays of binary data, and RLP is the primary
encoding method used to serialize objects in Ethereum's execution layer.
The only purpose of RLP is to encode structure; encoding specific data
types (e.g. strings, floats) is left up to higher-order protocols.</p>

<h2 id="parameters">Parameters</h2>

<p>header :
    Header of interest.</p>

<h2 id="returns">Returns</h2>

<p>hash : <code>ethereum.crypto.hash.Hash32</code>
    Hash of the header.</p>
</div>


                </section>
                <section id="check_gas_limit">
                            <input id="check_gas_limit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_gas_limit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">gas_limit</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>,</span><span class="param">	<span class="n">parent_gas_limit</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="check_gas_limit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_gas_limit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_gas_limit-854"><a href="#check_gas_limit-854"><span class="linenos">854</span></a><span class="k">def</span> <span class="nf">check_gas_limit</span><span class="p">(</span><span class="n">gas_limit</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span> <span class="n">parent_gas_limit</span><span class="p">:</span> <span class="n">Uint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="check_gas_limit-855"><a href="#check_gas_limit-855"><span class="linenos">855</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_gas_limit-856"><a href="#check_gas_limit-856"><span class="linenos">856</span></a><span class="sd">    Validates the gas limit for a block.</span>
</span><span id="check_gas_limit-857"><a href="#check_gas_limit-857"><span class="linenos">857</span></a>
</span><span id="check_gas_limit-858"><a href="#check_gas_limit-858"><span class="linenos">858</span></a><span class="sd">    The bounds of the gas limit, ``max_adjustment_delta``, is set as the</span>
</span><span id="check_gas_limit-859"><a href="#check_gas_limit-859"><span class="linenos">859</span></a><span class="sd">    quotient of the parent block&#39;s gas limit and the</span>
</span><span id="check_gas_limit-860"><a href="#check_gas_limit-860"><span class="linenos">860</span></a><span class="sd">    ``GAS_LIMIT_ADJUSTMENT_FACTOR``. Therefore, if the gas limit that is</span>
</span><span id="check_gas_limit-861"><a href="#check_gas_limit-861"><span class="linenos">861</span></a><span class="sd">    passed through as a parameter is greater than or equal to the *sum* of</span>
</span><span id="check_gas_limit-862"><a href="#check_gas_limit-862"><span class="linenos">862</span></a><span class="sd">    the parent&#39;s gas and the adjustment delta then the limit for gas is too</span>
</span><span id="check_gas_limit-863"><a href="#check_gas_limit-863"><span class="linenos">863</span></a><span class="sd">    high and fails this function&#39;s check. Similarly, if the limit is less</span>
</span><span id="check_gas_limit-864"><a href="#check_gas_limit-864"><span class="linenos">864</span></a><span class="sd">    than or equal to the *difference* of the parent&#39;s gas and the adjustment</span>
</span><span id="check_gas_limit-865"><a href="#check_gas_limit-865"><span class="linenos">865</span></a><span class="sd">    delta *or* the predefined ``GAS_LIMIT_MINIMUM`` then this function&#39;s</span>
</span><span id="check_gas_limit-866"><a href="#check_gas_limit-866"><span class="linenos">866</span></a><span class="sd">    check fails because the gas limit doesn&#39;t allow for a sufficient or</span>
</span><span id="check_gas_limit-867"><a href="#check_gas_limit-867"><span class="linenos">867</span></a><span class="sd">    reasonable amount of gas to be used on a block.</span>
</span><span id="check_gas_limit-868"><a href="#check_gas_limit-868"><span class="linenos">868</span></a>
</span><span id="check_gas_limit-869"><a href="#check_gas_limit-869"><span class="linenos">869</span></a><span class="sd">    Parameters</span>
</span><span id="check_gas_limit-870"><a href="#check_gas_limit-870"><span class="linenos">870</span></a><span class="sd">    ----------</span>
</span><span id="check_gas_limit-871"><a href="#check_gas_limit-871"><span class="linenos">871</span></a><span class="sd">    gas_limit :</span>
</span><span id="check_gas_limit-872"><a href="#check_gas_limit-872"><span class="linenos">872</span></a><span class="sd">        Gas limit to validate.</span>
</span><span id="check_gas_limit-873"><a href="#check_gas_limit-873"><span class="linenos">873</span></a>
</span><span id="check_gas_limit-874"><a href="#check_gas_limit-874"><span class="linenos">874</span></a><span class="sd">    parent_gas_limit :</span>
</span><span id="check_gas_limit-875"><a href="#check_gas_limit-875"><span class="linenos">875</span></a><span class="sd">        Gas limit of the parent block.</span>
</span><span id="check_gas_limit-876"><a href="#check_gas_limit-876"><span class="linenos">876</span></a>
</span><span id="check_gas_limit-877"><a href="#check_gas_limit-877"><span class="linenos">877</span></a><span class="sd">    Returns</span>
</span><span id="check_gas_limit-878"><a href="#check_gas_limit-878"><span class="linenos">878</span></a><span class="sd">    -------</span>
</span><span id="check_gas_limit-879"><a href="#check_gas_limit-879"><span class="linenos">879</span></a><span class="sd">    check : `bool`</span>
</span><span id="check_gas_limit-880"><a href="#check_gas_limit-880"><span class="linenos">880</span></a><span class="sd">        True if gas limit constraints are satisfied, False otherwise.</span>
</span><span id="check_gas_limit-881"><a href="#check_gas_limit-881"><span class="linenos">881</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_gas_limit-882"><a href="#check_gas_limit-882"><span class="linenos">882</span></a>    <span class="n">max_adjustment_delta</span> <span class="o">=</span> <span class="n">parent_gas_limit</span> <span class="o">//</span> <span class="n">GAS_LIMIT_ADJUSTMENT_FACTOR</span>
</span><span id="check_gas_limit-883"><a href="#check_gas_limit-883"><span class="linenos">883</span></a>    <span class="k">if</span> <span class="n">gas_limit</span> <span class="o">&gt;=</span> <span class="n">parent_gas_limit</span> <span class="o">+</span> <span class="n">max_adjustment_delta</span><span class="p">:</span>
</span><span id="check_gas_limit-884"><a href="#check_gas_limit-884"><span class="linenos">884</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="check_gas_limit-885"><a href="#check_gas_limit-885"><span class="linenos">885</span></a>    <span class="k">if</span> <span class="n">gas_limit</span> <span class="o">&lt;=</span> <span class="n">parent_gas_limit</span> <span class="o">-</span> <span class="n">max_adjustment_delta</span><span class="p">:</span>
</span><span id="check_gas_limit-886"><a href="#check_gas_limit-886"><span class="linenos">886</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="check_gas_limit-887"><a href="#check_gas_limit-887"><span class="linenos">887</span></a>    <span class="k">if</span> <span class="n">gas_limit</span> <span class="o">&lt;</span> <span class="n">GAS_LIMIT_MINIMUM</span><span class="p">:</span>
</span><span id="check_gas_limit-888"><a href="#check_gas_limit-888"><span class="linenos">888</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="check_gas_limit-889"><a href="#check_gas_limit-889"><span class="linenos">889</span></a>
</span><span id="check_gas_limit-890"><a href="#check_gas_limit-890"><span class="linenos">890</span></a>    <span class="k">return</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Validates the gas limit for a block.</p>

<p>The bounds of the gas limit, <code>max_adjustment_delta</code>, is set as the
quotient of the parent block's gas limit and the
<code>GAS_LIMIT_ADJUSTMENT_FACTOR</code>. Therefore, if the gas limit that is
passed through as a parameter is greater than or equal to the <em>sum</em> of
the parent's gas and the adjustment delta then the limit for gas is too
high and fails this function's check. Similarly, if the limit is less
than or equal to the <em>difference</em> of the parent's gas and the adjustment
delta <em>or</em> the predefined <code>GAS_LIMIT_MINIMUM</code> then this function's
check fails because the gas limit doesn't allow for a sufficient or
reasonable amount of gas to be used on a block.</p>

<h2 id="parameters">Parameters</h2>

<p>gas_limit :
    Gas limit to validate.</p>

<p>parent_gas_limit :
    Gas limit of the parent block.</p>

<h2 id="returns">Returns</h2>

<p>check : <code>bool</code>
    True if gas limit constraints are satisfied, False otherwise.</p>
</div>


                </section>
                <section id="calculate_block_difficulty">
                            <input id="calculate_block_difficulty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_block_difficulty</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">block_number</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>,</span><span class="param">	<span class="n">block_timestamp</span><span class="p">:</span> <span class="n"><a href="../base_types.html#U256">ethereum.base_types.U256</a></span>,</span><span class="param">	<span class="n">parent_timestamp</span><span class="p">:</span> <span class="n"><a href="../base_types.html#U256">ethereum.base_types.U256</a></span>,</span><span class="param">	<span class="n">parent_difficulty</span><span class="p">:</span> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></span>:</span></span>

                <label class="view-source-button" for="calculate_block_difficulty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#calculate_block_difficulty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="calculate_block_difficulty-893"><a href="#calculate_block_difficulty-893"><span class="linenos">893</span></a><span class="k">def</span> <span class="nf">calculate_block_difficulty</span><span class="p">(</span>
</span><span id="calculate_block_difficulty-894"><a href="#calculate_block_difficulty-894"><span class="linenos">894</span></a>    <span class="n">block_number</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="calculate_block_difficulty-895"><a href="#calculate_block_difficulty-895"><span class="linenos">895</span></a>    <span class="n">block_timestamp</span><span class="p">:</span> <span class="n">U256</span><span class="p">,</span>
</span><span id="calculate_block_difficulty-896"><a href="#calculate_block_difficulty-896"><span class="linenos">896</span></a>    <span class="n">parent_timestamp</span><span class="p">:</span> <span class="n">U256</span><span class="p">,</span>
</span><span id="calculate_block_difficulty-897"><a href="#calculate_block_difficulty-897"><span class="linenos">897</span></a>    <span class="n">parent_difficulty</span><span class="p">:</span> <span class="n">Uint</span><span class="p">,</span>
</span><span id="calculate_block_difficulty-898"><a href="#calculate_block_difficulty-898"><span class="linenos">898</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Uint</span><span class="p">:</span>
</span><span id="calculate_block_difficulty-899"><a href="#calculate_block_difficulty-899"><span class="linenos">899</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="calculate_block_difficulty-900"><a href="#calculate_block_difficulty-900"><span class="linenos">900</span></a><span class="sd">    Computes difficulty of a block using its header and parent header.</span>
</span><span id="calculate_block_difficulty-901"><a href="#calculate_block_difficulty-901"><span class="linenos">901</span></a>
</span><span id="calculate_block_difficulty-902"><a href="#calculate_block_difficulty-902"><span class="linenos">902</span></a><span class="sd">    The difficulty is determined by the time the block was created after its</span>
</span><span id="calculate_block_difficulty-903"><a href="#calculate_block_difficulty-903"><span class="linenos">903</span></a><span class="sd">    parent. The ``offset`` is calculated using the parent block&#39;s difficulty,</span>
</span><span id="calculate_block_difficulty-904"><a href="#calculate_block_difficulty-904"><span class="linenos">904</span></a><span class="sd">    ``parent_difficulty``, and the timestamp between blocks. This offset is</span>
</span><span id="calculate_block_difficulty-905"><a href="#calculate_block_difficulty-905"><span class="linenos">905</span></a><span class="sd">    then added to the parent difficulty and is stored as the ``difficulty``</span>
</span><span id="calculate_block_difficulty-906"><a href="#calculate_block_difficulty-906"><span class="linenos">906</span></a><span class="sd">    variable. If the time between the block and its parent is too short, the</span>
</span><span id="calculate_block_difficulty-907"><a href="#calculate_block_difficulty-907"><span class="linenos">907</span></a><span class="sd">    offset will result in a positive number thus making the sum of</span>
</span><span id="calculate_block_difficulty-908"><a href="#calculate_block_difficulty-908"><span class="linenos">908</span></a><span class="sd">    ``parent_difficulty`` and ``offset`` to be a greater value in order to</span>
</span><span id="calculate_block_difficulty-909"><a href="#calculate_block_difficulty-909"><span class="linenos">909</span></a><span class="sd">    avoid mass forking. But, if the time is long enough, then the offset</span>
</span><span id="calculate_block_difficulty-910"><a href="#calculate_block_difficulty-910"><span class="linenos">910</span></a><span class="sd">    results in a negative value making the block less difficult than</span>
</span><span id="calculate_block_difficulty-911"><a href="#calculate_block_difficulty-911"><span class="linenos">911</span></a><span class="sd">    its parent.</span>
</span><span id="calculate_block_difficulty-912"><a href="#calculate_block_difficulty-912"><span class="linenos">912</span></a>
</span><span id="calculate_block_difficulty-913"><a href="#calculate_block_difficulty-913"><span class="linenos">913</span></a><span class="sd">    The base standard for a block&#39;s difficulty is the predefined value</span>
</span><span id="calculate_block_difficulty-914"><a href="#calculate_block_difficulty-914"><span class="linenos">914</span></a><span class="sd">    set for the genesis block since it has no parent. So, a block</span>
</span><span id="calculate_block_difficulty-915"><a href="#calculate_block_difficulty-915"><span class="linenos">915</span></a><span class="sd">    can&#39;t be less difficult than the genesis block, therefore each block&#39;s</span>
</span><span id="calculate_block_difficulty-916"><a href="#calculate_block_difficulty-916"><span class="linenos">916</span></a><span class="sd">    difficulty is set to the maximum value between the calculated</span>
</span><span id="calculate_block_difficulty-917"><a href="#calculate_block_difficulty-917"><span class="linenos">917</span></a><span class="sd">    difficulty and the ``GENESIS_DIFFICULTY``.</span>
</span><span id="calculate_block_difficulty-918"><a href="#calculate_block_difficulty-918"><span class="linenos">918</span></a>
</span><span id="calculate_block_difficulty-919"><a href="#calculate_block_difficulty-919"><span class="linenos">919</span></a><span class="sd">    Parameters</span>
</span><span id="calculate_block_difficulty-920"><a href="#calculate_block_difficulty-920"><span class="linenos">920</span></a><span class="sd">    ----------</span>
</span><span id="calculate_block_difficulty-921"><a href="#calculate_block_difficulty-921"><span class="linenos">921</span></a><span class="sd">    block_number :</span>
</span><span id="calculate_block_difficulty-922"><a href="#calculate_block_difficulty-922"><span class="linenos">922</span></a><span class="sd">        Block number of the block.</span>
</span><span id="calculate_block_difficulty-923"><a href="#calculate_block_difficulty-923"><span class="linenos">923</span></a><span class="sd">    block_timestamp :</span>
</span><span id="calculate_block_difficulty-924"><a href="#calculate_block_difficulty-924"><span class="linenos">924</span></a><span class="sd">        Timestamp of the block.</span>
</span><span id="calculate_block_difficulty-925"><a href="#calculate_block_difficulty-925"><span class="linenos">925</span></a><span class="sd">    parent_timestamp :</span>
</span><span id="calculate_block_difficulty-926"><a href="#calculate_block_difficulty-926"><span class="linenos">926</span></a><span class="sd">        Timestamp of the parent block.</span>
</span><span id="calculate_block_difficulty-927"><a href="#calculate_block_difficulty-927"><span class="linenos">927</span></a><span class="sd">    parent_difficulty :</span>
</span><span id="calculate_block_difficulty-928"><a href="#calculate_block_difficulty-928"><span class="linenos">928</span></a><span class="sd">        difficulty of the parent block.</span>
</span><span id="calculate_block_difficulty-929"><a href="#calculate_block_difficulty-929"><span class="linenos">929</span></a>
</span><span id="calculate_block_difficulty-930"><a href="#calculate_block_difficulty-930"><span class="linenos">930</span></a><span class="sd">    Returns</span>
</span><span id="calculate_block_difficulty-931"><a href="#calculate_block_difficulty-931"><span class="linenos">931</span></a><span class="sd">    -------</span>
</span><span id="calculate_block_difficulty-932"><a href="#calculate_block_difficulty-932"><span class="linenos">932</span></a><span class="sd">    difficulty : `ethereum.base_types.Uint`</span>
</span><span id="calculate_block_difficulty-933"><a href="#calculate_block_difficulty-933"><span class="linenos">933</span></a><span class="sd">        Computed difficulty for a block.</span>
</span><span id="calculate_block_difficulty-934"><a href="#calculate_block_difficulty-934"><span class="linenos">934</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="calculate_block_difficulty-935"><a href="#calculate_block_difficulty-935"><span class="linenos">935</span></a>    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="calculate_block_difficulty-936"><a href="#calculate_block_difficulty-936"><span class="linenos">936</span></a>        <span class="nb">int</span><span class="p">(</span><span class="n">parent_difficulty</span><span class="p">)</span>
</span><span id="calculate_block_difficulty-937"><a href="#calculate_block_difficulty-937"><span class="linenos">937</span></a>        <span class="o">//</span> <span class="mi">2048</span>
</span><span id="calculate_block_difficulty-938"><a href="#calculate_block_difficulty-938"><span class="linenos">938</span></a>        <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">block_timestamp</span> <span class="o">-</span> <span class="n">parent_timestamp</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span><span class="p">)</span>
</span><span id="calculate_block_difficulty-939"><a href="#calculate_block_difficulty-939"><span class="linenos">939</span></a>    <span class="p">)</span>
</span><span id="calculate_block_difficulty-940"><a href="#calculate_block_difficulty-940"><span class="linenos">940</span></a>    <span class="n">difficulty</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parent_difficulty</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="calculate_block_difficulty-941"><a href="#calculate_block_difficulty-941"><span class="linenos">941</span></a>    <span class="c1"># Historical Note: The difficulty bomb was not present in Ethereum at the</span>
</span><span id="calculate_block_difficulty-942"><a href="#calculate_block_difficulty-942"><span class="linenos">942</span></a>    <span class="c1"># start of Frontier, but was added shortly after launch. However since the</span>
</span><span id="calculate_block_difficulty-943"><a href="#calculate_block_difficulty-943"><span class="linenos">943</span></a>    <span class="c1"># bomb has no effect prior to block 200000 we pretend it existed from</span>
</span><span id="calculate_block_difficulty-944"><a href="#calculate_block_difficulty-944"><span class="linenos">944</span></a>    <span class="c1"># genesis.</span>
</span><span id="calculate_block_difficulty-945"><a href="#calculate_block_difficulty-945"><span class="linenos">945</span></a>    <span class="c1"># See https://github.com/ethereum/go-ethereum/pull/1588</span>
</span><span id="calculate_block_difficulty-946"><a href="#calculate_block_difficulty-946"><span class="linenos">946</span></a>    <span class="n">num_bomb_periods</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">block_number</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
</span><span id="calculate_block_difficulty-947"><a href="#calculate_block_difficulty-947"><span class="linenos">947</span></a>    <span class="k">if</span> <span class="n">num_bomb_periods</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="calculate_block_difficulty-948"><a href="#calculate_block_difficulty-948"><span class="linenos">948</span></a>        <span class="n">difficulty</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">num_bomb_periods</span>
</span><span id="calculate_block_difficulty-949"><a href="#calculate_block_difficulty-949"><span class="linenos">949</span></a>
</span><span id="calculate_block_difficulty-950"><a href="#calculate_block_difficulty-950"><span class="linenos">950</span></a>    <span class="c1"># Some clients raise the difficulty to `MINIMUM_DIFFICULTY` prior to adding</span>
</span><span id="calculate_block_difficulty-951"><a href="#calculate_block_difficulty-951"><span class="linenos">951</span></a>    <span class="c1"># the bomb. This bug does not matter because the difficulty is always much</span>
</span><span id="calculate_block_difficulty-952"><a href="#calculate_block_difficulty-952"><span class="linenos">952</span></a>    <span class="c1"># greater than `MINIMUM_DIFFICULTY` on Mainnet.</span>
</span><span id="calculate_block_difficulty-953"><a href="#calculate_block_difficulty-953"><span class="linenos">953</span></a>    <span class="k">return</span> <span class="n">Uint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">difficulty</span><span class="p">,</span> <span class="n">MINIMUM_DIFFICULTY</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Computes difficulty of a block using its header and parent header.</p>

<p>The difficulty is determined by the time the block was created after its
parent. The <code>offset</code> is calculated using the parent block's difficulty,
<code>parent_difficulty</code>, and the timestamp between blocks. This offset is
then added to the parent difficulty and is stored as the <code>difficulty</code>
variable. If the time between the block and its parent is too short, the
offset will result in a positive number thus making the sum of
<code>parent_difficulty</code> and <code>offset</code> to be a greater value in order to
avoid mass forking. But, if the time is long enough, then the offset
results in a negative value making the block less difficult than
its parent.</p>

<p>The base standard for a block's difficulty is the predefined value
set for the genesis block since it has no parent. So, a block
can't be less difficult than the genesis block, therefore each block's
difficulty is set to the maximum value between the calculated
difficulty and the <code>GENESIS_DIFFICULTY</code>.</p>

<h2 id="parameters">Parameters</h2>

<p>block_number :
    Block number of the block.
block_timestamp :
    Timestamp of the block.
parent_timestamp :
    Timestamp of the parent block.
parent_difficulty :
    difficulty of the parent block.</p>

<h2 id="returns">Returns</h2>

<p>difficulty : <code><a href="../base_types.html#Uint">ethereum.base_types.Uint</a></code>
    Computed difficulty for a block.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>